<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#3ecf8e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="NGM Connect" />
  <meta name="format-detection" content="telephone=no" />
  <title>NGM Connect</title>
  <link rel="icon" type="image/png" href="assets/img/connect_icon.png" />
  <link rel="manifest" href="manifest-connect.json" />
  <link rel="apple-touch-icon" href="assets/img/connect_icon.png" />

  <!-- Fonts: Inter + Roboto (NGM standard) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet"
  />

  <!-- Preload loading logo -->
  <link rel="preload" href="assets/img/white_icon.png" as="image" />

  <!-- Critical CSS for loading overlay -->
  <style>
    body.page-loading { overflow: hidden; }
    .page-loading-overlay { position: fixed; inset: 0; background: #0d0d0d; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; gap: 16px; }
    .page-loading-overlay.hidden { display: none; }
    .page-loading .app-layout { visibility: hidden; }
    .loading-logo { width: 120px; height: 120px; object-fit: contain; animation: pulse 1.5s ease-in-out infinite; }
    .loading-text { color: rgba(255,255,255,0.5); font-size: 13px; font-family: system-ui, sans-serif; letter-spacing: 0.05em; }
    @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }
  </style>

  <!-- Base layout + Messages styles -->
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/pipeline_styles.css" />
  <link rel="stylesheet" href="assets/css/messages_styles.css" />
  <link rel="stylesheet" href="assets/css/toast.css" />
  <link rel="stylesheet" href="assets/css/arturito_widget.css" />
  <link rel="stylesheet" href="assets/css/chat_widget.css" />

  <!-- Supabase client for realtime -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Global scripts -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/auth-guard.js"></script>
  <script src="assets/js/toast.js" defer></script>
  <script src="assets/js/permissions.js" defer></script>
  <script src="assets/js/pills.js" defer></script>
  <script src="assets/js/sidebar.js" defer></script>
</head>

<body class="page-messages page-loading">
  <!-- Page Loading Overlay -->
  <div class="page-loading-overlay" id="pageLoadingOverlay">
    <img src="assets/img/white_icon.png" class="loading-logo" alt="Loading...">
    <span class="loading-text">Loading...</span>
  </div>

  <div class="app-layout">
    <!-- Mobile sidebar overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar (content generated by sidebar.js) -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main area -->
    <div class="main-area">
      <!-- Topbar -->
      <header class="ngm-topbar">
        <div class="ngm-bar-left">
          <!-- Mobile menu button -->
          <button type="button" class="mobile-menu-btn" id="btnMobileMenu" title="Open menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <div class="ngm-brand">
            <div class="ngm-brand-icon-small"><img src="assets/img/white_icon.png" alt="NGM"></div>
            <div class="ngm-brand-text">
              <span class="ngm-brand-org">Next Generation Management</span>
              <span class="ngm-brand-context">NGM Hub · Messages</span>
            </div>
          </div>
        </div>

        <div class="ngm-topbar-right">
          <div class="ngm-meta">
            <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment · —</span>
            <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server · —</span>
          </div>

          <!-- Search bar -->
          <form class="ngm-search" role="search" onsubmit="return false;">
            <span class="ngm-global-search-icon">⌕</span>
            <input
              id="messages-search-input"
              type="search"
              class="ngm-search-input"
              placeholder="Search messages…"
              aria-label="Search messages"
            />
          </form>

          <span id="user-pill" class="user-pill">User · —</span>
        </div>
      </header>

      <!-- Main content: Chat layout -->
      <main class="main-content messages-main">
        <div class="messages-layout">

          <!-- Mobile Top Bar (only visible on mobile) -->
          <div class="msg-mobile-topbar">
            <div class="msg-mobile-topbar-search" id="btnMobileSearch">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
              </svg>
              <span>Buscar en el chat</span>
            </div>
            <div class="msg-mobile-topbar-avatar" id="mobileUserAvatar">
              <!-- Initials set by JS -->
            </div>
          </div>

          <!-- LEFT: Channels sidebar -->
          <aside class="msg-channels-sidebar">
            <!-- Header with New Chat and Mentions buttons -->
            <div class="msg-channels-header">
              <button type="button" class="msg-btn-new-chat" id="btnNewChannel">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                <span>New chat</span>
              </button>
              <button type="button" class="msg-btn-mentions" id="btnMentionsWeb" title="Mentions">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span class="msg-btn-mentions-badge" id="mentionsWebBadge" style="display: none;">0</span>
              </button>
            </div>

            <!-- Search channels -->
            <div class="msg-channels-search">
              <input
                type="text"
                id="channelSearchInput"
                class="msg-search-input"
                placeholder="Search channels..."
              />
            </div>

            <!-- Channels list -->
            <div class="msg-channels-list" id="channelsList">
              <!-- Groups section (includes custom channels) -->
              <div class="msg-channel-section" id="sectionGroups">
                <div class="msg-channel-section-header" data-section="groups">
                  <span class="msg-section-chevron">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </span>
                  <span class="msg-section-title">Groups</span>
                </div>
                <div class="msg-channel-section-content" id="groupChannels">
                  <!-- Rendered by JS -->
                </div>
              </div>

              <!-- Project channels section -->
              <div class="msg-channel-section" id="sectionProjects">
                <div class="msg-channel-section-header" data-section="projects">
                  <span class="msg-section-chevron">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </span>
                  <span class="msg-section-title">Projects</span>
                </div>
                <div class="msg-channel-section-content" id="projectChannels">
                  <!-- Rendered by JS -->
                  <div class="msg-channel-loading">Loading projects...</div>
                </div>
              </div>

              <!-- Direct Messages section -->
              <div class="msg-channel-section" id="sectionDirect">
                <div class="msg-channel-section-header" data-section="direct">
                  <span class="msg-section-chevron">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </span>
                  <span class="msg-section-title">Direct Messages</span>
                </div>
                <div class="msg-channel-section-content" id="directMessages">
                  <!-- Rendered by JS -->
                </div>
              </div>
            </div>

            <!-- Mentions View (shown when Mentions tab is active) -->
            <div class="msg-mentions-view" id="mentionsView" style="display: none;">
              <div class="msg-mentions-header">
                <h3 class="msg-mentions-title">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                  </svg>
                  <span>Mentions</span>
                </h3>
                <span class="msg-mentions-count" id="mentionsCount">0 unread</span>
              </div>
              <div class="msg-mentions-list" id="mentionsList">
                <!-- Rendered by JS -->
                <div class="msg-mentions-empty" id="mentionsEmpty">
                  <div class="msg-mentions-empty-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                  </div>
                  <p class="msg-mentions-empty-text">No mentions yet</p>
                  <p class="msg-mentions-empty-subtext">When someone @mentions you, it will appear here</p>
                </div>
              </div>
            </div>
          </aside>

          <!-- Mobile sidebar overlay -->
          <div class="msg-sidebar-overlay" id="sidebarOverlay"></div>

          <!-- CENTER: Chat area -->
          <section class="msg-chat-area">
            <!-- Chat header -->
            <div class="msg-chat-header">
              <div class="msg-chat-header-left">
                <!-- Mobile back button (only visible on mobile) -->
                <button type="button" class="msg-mobile-back-btn" id="btnMobileBack" title="Back">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                  </svg>
                </button>
                <!-- Mobile hamburger menu -->
                <button type="button" class="msg-mobile-menu-btn" id="btnMobileMenu" title="Open menu">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                  </svg>
                </button>
                <div class="msg-chat-info">
                  <h2 class="msg-chat-name" id="chatName">Select a channel</h2>
                  <span class="msg-chat-description" id="chatDescription">Choose a channel from the sidebar to start</span>
                </div>
              </div>
              <div class="msg-chat-header-actions">
                <button type="button" class="msg-btn-icon" id="btnChannelInfo" title="Channel info">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                </button>
                <button type="button" class="msg-btn-icon" id="btnToggleThread" title="Toggle thread panel">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <line x1="9" y1="10" x2="15" y2="10"></line>
                    <line x1="9" y1="14" x2="13" y2="14"></line>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Messages container -->
            <div class="msg-messages-container" id="messagesContainer">
              <!-- Welcome state -->
              <div class="msg-empty-state" id="emptyState">
                <div class="msg-empty-icon">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                </div>
                <h3 class="msg-empty-title">No conversation selected</h3>
                <p class="msg-empty-text">Choose a chat from the sidebar or start a new conversation.</p>
              </div>

              <!-- Chat loading spinner -->
              <div class="msg-chat-loading" id="chatLoading" style="display: none;">
                <img src="assets/img/white_icon.png" class="msg-chat-loading-icon" alt="Loading...">
                <span class="msg-chat-loading-text">Loading messages...</span>
              </div>

              <!-- Messages will be rendered here -->
              <div class="msg-messages-list" id="messagesList" style="display: none;">
                <!-- Messages rendered by JS -->
              </div>
            </div>

            <!-- Typing indicator -->
            <div class="msg-typing-indicator" id="typingIndicator" style="display: none;">
              <div class="msg-typing-dots">
                <span></span><span></span><span></span>
              </div>
              <span class="msg-typing-text" id="typingText">Someone is typing...</span>
            </div>

            <!-- Message input -->
            <div class="msg-input-area" id="messageInputArea" style="display: none;">
              <!-- Attachments preview -->
              <div class="msg-attachments-preview" id="attachmentsPreview" style="display: none;">
                <!-- Rendered by JS -->
              </div>

              <!-- Reply preview -->
              <div class="msg-reply-preview" id="replyPreview" style="display: none;">
                <div class="msg-reply-content">
                  <span class="msg-reply-label">Replying to</span>
                  <span class="msg-reply-author" id="replyAuthor"></span>
                  <span class="msg-reply-text" id="replyText"></span>
                </div>
                <button type="button" class="msg-btn-icon msg-btn-cancel-reply" id="btnCancelReply">×</button>
              </div>

              <!-- Input card (Google Chat style) -->
              <div class="msg-input-card">
                <div class="msg-input-wrapper">
                  <textarea
                    id="messageInput"
                    class="msg-input"
                    placeholder="Type a message..."
                    rows="1"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="sentences"
                    spellcheck="false"
                    data-form-type="other"
                    inputmode="text"
                    enterkeyhint="send"
                  ></textarea>
                  <!-- Mention suggestions dropdown -->
                  <div class="msg-mention-dropdown" id="mentionDropdown" style="display: none;">
                    <!-- Rendered by JS -->
                  </div>
                </div>
                <div class="msg-input-toolbar">
                  <div class="msg-input-toolbar-left">
                    <button type="button" class="msg-toolbar-btn" id="btnAttachFile" title="Attach file">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                      </svg>
                    </button>
                  </div>
                  <button type="button" class="msg-btn-send" id="btnSendMessage" title="Send message" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- RIGHT: Thread panel (hidden by default) -->
          <aside class="msg-thread-panel" id="threadPanel" style="display: none;">
            <div class="msg-thread-header">
              <h3 class="msg-thread-title">Thread</h3>
              <button type="button" class="msg-btn-icon" id="btnCloseThread" title="Close thread">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>

            <!-- Original message -->
            <div class="msg-thread-original" id="threadOriginal">
              <!-- Rendered by JS -->
            </div>

            <!-- Thread replies -->
            <div class="msg-thread-replies" id="threadReplies">
              <!-- Rendered by JS -->
            </div>

            <!-- Thread input -->
            <div class="msg-thread-input-area">
              <textarea
                id="threadInput"
                class="msg-input"
                placeholder="Reply to thread..."
                rows="1"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="sentences"
                spellcheck="false"
                inputmode="text"
                enterkeyhint="send"
                data-form-type="other"
              ></textarea>
              <button type="button" class="msg-btn-send" id="btnSendThreadReply" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
              </button>
            </div>
          </aside>

          <!-- Mobile Bottom Navigation (only visible on mobile) -->
          <nav class="msg-bottom-nav">
            <button type="button" class="msg-bottom-nav-item active" data-tab="home">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span>Inicio</span>
            </button>
            <button type="button" class="msg-bottom-nav-item" data-tab="chats">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              <span>Chats</span>
              <span class="msg-bottom-nav-badge" id="chatsBadge" style="display: none;">0</span>
            </button>
            <button type="button" class="msg-bottom-nav-item" data-tab="spaces">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              <span>Espacios</span>
            </button>
            <button type="button" class="msg-bottom-nav-item" data-tab="mentions">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
              </svg>
              <span>Mentions</span>
              <span class="msg-bottom-nav-badge" id="mentionsBadge" style="display: none;">0</span>
            </button>
          </nav>

          <!-- Mobile FAB for new chat (only visible on mobile) -->
          <button type="button" class="msg-fab-new-chat" id="btnMobileFabNewChat" title="New chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              <path d="M12 8v8M8 12h8"/>
            </svg>
          </button>

        </div>
      </main>
    </div>
  </div>

  <!-- New Channel Modal -->
  <div id="newChannelModal" class="modal-backdrop hidden">
    <div class="modal msg-modal">
      <div class="modal-header">
        <div class="modal-title">Create New Channel</div>
        <button type="button" class="modal-btn header-action" id="btnCloseNewChannelModal">×</button>
      </div>

      <div class="modal-body">
        <form id="newChannelForm">
          <div class="msg-form-field">
            <label class="msg-form-label">Channel Type</label>
            <div class="msg-radio-group">
              <label class="msg-radio">
                <input type="radio" name="channelType" value="custom" checked />
                <div class="msg-radio-content">
                  <span class="msg-radio-label">Custom Channel</span>
                  <span class="msg-radio-desc">Create a channel for a specific topic</span>
                </div>
              </label>
              <label class="msg-radio">
                <input type="radio" name="channelType" value="direct" />
                <div class="msg-radio-content">
                  <span class="msg-radio-label">Direct Message</span>
                  <span class="msg-radio-desc">Private conversation with selected users</span>
                </div>
              </label>
            </div>
          </div>

          <div class="msg-form-field" id="channelNameField">
            <label class="msg-form-label">Channel Name</label>
            <input type="text" id="newChannelName" class="msg-form-input" placeholder="e.g. design-reviews" />
          </div>

          <div class="msg-form-field">
            <label class="msg-form-label">Description (optional)</label>
            <input type="text" id="newChannelDescription" class="msg-form-input" placeholder="What's this channel about?" />
          </div>

          <div class="msg-form-field">
            <label class="msg-form-label">Add Members</label>
            <div id="channelMembersPicker">
              <!-- People picker rendered here -->
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btnCancelNewChannel">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnCreateChannel">Create Channel</button>
      </div>
    </div>
  </div>

  <!-- Channel Info Modal -->
  <div id="channelInfoModal" class="modal-backdrop hidden">
    <div class="modal msg-modal">
      <div class="modal-header">
        <div class="modal-title">Channel Info</div>
        <button type="button" class="modal-btn header-action" id="btnCloseChannelInfoModal">×</button>
      </div>

      <div class="modal-body">
        <div class="msg-channel-info-content" id="channelInfoContent">
          <!-- Rendered by JS -->
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btnCloseChannelInfo">Close</button>
      </div>
    </div>
  </div>

  <!-- Search Messages Modal -->
  <div id="searchMessagesModal" class="modal-backdrop hidden">
    <div class="modal msg-modal msg-modal--search">
      <div class="modal-header">
        <div class="modal-title">Search Messages</div>
        <button type="button" class="modal-btn header-action" id="btnCloseSearchModal">×</button>
      </div>

      <div class="modal-body">
        <div class="msg-search-form">
          <input type="text" id="searchMessagesInput" class="msg-form-input" placeholder="Search for messages..." autofocus />
          <div class="msg-search-filters">
            <label class="msg-checkbox">
              <input type="checkbox" id="searchInCurrentChannel" checked />
              <span>Current channel only</span>
            </label>
          </div>
        </div>
        <div class="msg-search-results" id="searchResults">
          <!-- Rendered by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Project Channels Modal -->
  <div id="manageProjectChannelsModal" class="modal-backdrop hidden">
    <div class="modal msg-modal msg-modal--manage-channels">
      <div class="modal-header">
        <div class="modal-title">
          <span>Manage Channels — </span>
          <span id="manageChannelsProjectName">Project</span>
        </div>
        <button type="button" class="modal-btn header-action" id="btnCloseManageChannelsModal">×</button>
      </div>

      <div class="modal-body">
        <p class="manage-channels-description">
          Configure which channels are available for this project.
          <strong>General</strong> and <strong>Receipts</strong> channels cannot be removed.
        </p>

        <div class="channel-toggles-list" id="channelTogglesList">
          <!-- Rendered by JS -->
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btnCancelManageChannels">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnSaveChannelSettings">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- People Picker (reuse from pipeline) -->
  <script src="assets/js/pipeline_people_picker.js"></script>

  <!-- Messages module -->
  <script src="assets/js/page-loading.js" defer></script>
  <script src="assets/js/messages.js" defer></script>
  <script src="assets/js/arturito_widget.js" defer></script>
  <script src="assets/js/chat_widget.js" defer></script>

  <script>
    // Initialize topbar pills on DOM ready
    // Loading overlay is controlled by messages.js after data loads
    document.addEventListener('DOMContentLoaded', function() {
      if (window.initTopbarPills) window.initTopbarPills();
    });
  </script>

  <!-- Mobile View Controller -->
  <script>
    (function() {
      'use strict';

      function isMobile() {
        return window.innerWidth <= 768;
      }

      function initMobileMessages() {
        const body = document.body;
        const backBtn = document.getElementById('btnMobileBack');
        const fabBtn = document.getElementById('btnMobileFabNewChat');
        const mobileSearch = document.getElementById('btnMobileSearch');
        const mobileAvatar = document.getElementById('mobileUserAvatar');
        const bottomNavItems = document.querySelectorAll('.msg-bottom-nav-item');

        // Set user avatar initials
        function setUserAvatar() {
          try {
            const userData = localStorage.getItem('ngmUser');
            if (userData && mobileAvatar) {
              const user = JSON.parse(userData);
              const name = user.full_name || user.username || 'U';
              const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
              mobileAvatar.textContent = initials;
            }
          } catch (e) {
            if (mobileAvatar) mobileAvatar.textContent = 'U';
          }
        }

        // Open chat view on mobile
        function openMobileChat() {
          if (isMobile()) {
            body.classList.add('mobile-chat-open');
            // Push state for browser back button support
            if (!history.state || !history.state.chatOpen) {
              history.pushState({ chatOpen: true }, '', window.location.href);
            }
          }
        }

        // Close chat view on mobile (go back to list)
        function closeMobileChat() {
          body.classList.remove('mobile-chat-open');
        }

        // Back button handler
        if (backBtn) {
          backBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeMobileChat();
            // Go back in history if we pushed state
            if (history.state && history.state.chatOpen) {
              history.back();
            }
          });
        }

        // FAB new chat button
        if (fabBtn) {
          fabBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const newChannelBtn = document.getElementById('btnNewChannel');
            if (newChannelBtn) newChannelBtn.click();
          });
        }

        // Mobile search - open search modal directly
        if (mobileSearch) {
          mobileSearch.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            var searchModal = document.getElementById('searchMessagesModal');
            if (searchModal) {
              searchModal.classList.remove('hidden');
              var searchInput = document.getElementById('searchMessagesInput');
              if (searchInput) searchInput.focus();
            }
          });
        }

        // Mobile avatar - display only, no action
        // Could be extended later for profile menu

        // Bottom navigation handler
        bottomNavItems.forEach(function(item) {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const tab = this.getAttribute('data-tab');

            // Remove active from all items
            bottomNavItems.forEach(function(btn) {
              btn.classList.remove('active');
            });

            // Add active to clicked item
            this.classList.add('active');

            // Handle tab actions
            switch(tab) {
              case 'home':
                // Hide mentions view first
                if (window.MessagesModule && window.MessagesModule.hideMentionsView) {
                  window.MessagesModule.hideMentionsView();
                }
                // Show all channels (default view)
                document.querySelectorAll('.msg-channel-section').forEach(function(section) {
                  section.style.display = '';
                });
                break;
              case 'chats':
                // Hide mentions view first
                if (window.MessagesModule && window.MessagesModule.hideMentionsView) {
                  window.MessagesModule.hideMentionsView();
                }
                // Filter to show only direct messages
                document.querySelectorAll('.msg-channel-section').forEach(function(section) {
                  if (section.id === 'sectionDirect') {
                    section.style.display = '';
                  } else {
                    section.style.display = 'none';
                  }
                });
                break;
              case 'spaces':
                // Hide mentions view first
                if (window.MessagesModule && window.MessagesModule.hideMentionsView) {
                  window.MessagesModule.hideMentionsView();
                }
                // Filter to show only project channels
                document.querySelectorAll('.msg-channel-section').forEach(function(section) {
                  if (section.id === 'sectionProjects' || section.id === 'sectionGroups') {
                    section.style.display = '';
                  } else {
                    section.style.display = 'none';
                  }
                });
                break;
              case 'mentions':
                // Show mentions view
                if (window.MessagesModule && window.MessagesModule.showMentionsView) {
                  window.MessagesModule.showMentionsView();
                }
                break;
            }
          });
        });

        // Handle channel selection - open chat on mobile
        const channelsList = document.getElementById('channelsList');
        if (channelsList) {
          channelsList.addEventListener('click', function(e) {
            const channelItem = e.target.closest('.msg-channel-item');
            if (channelItem && isMobile()) {
              // Small delay to allow the existing handler to run first
              setTimeout(openMobileChat, 50);
            }
          });
        }

        // Handle resize - close mobile chat if we resize to desktop
        window.addEventListener('resize', function() {
          if (!isMobile()) {
            body.classList.remove('mobile-chat-open');
          }
        });

        // Web Mentions button handler
        var btnMentionsWeb = document.getElementById('btnMentionsWeb');
        if (btnMentionsWeb) {
          var mentionsActive = false;
          btnMentionsWeb.addEventListener('click', function() {
            if (mentionsActive) {
              // Hide mentions view
              if (window.MessagesModule && window.MessagesModule.hideMentionsView) {
                window.MessagesModule.hideMentionsView();
              }
              btnMentionsWeb.classList.remove('active');
              mentionsActive = false;
            } else {
              // Show mentions view
              if (window.MessagesModule && window.MessagesModule.showMentionsView) {
                window.MessagesModule.showMentionsView();
              }
              btnMentionsWeb.classList.add('active');
              mentionsActive = true;
            }
          });
        }

        // Handle browser back button
        window.addEventListener('popstate', function(e) {
          if (isMobile() && body.classList.contains('mobile-chat-open')) {
            closeMobileChat();
          }
        });

        // Expose functions globally for messages.js to use
        window.openMobileChat = openMobileChat;
        window.closeMobileChat = closeMobileChat;

        setUserAvatar();
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileMessages);
      } else {
        initMobileMessages();
      }
    })();
  </script>

  <!-- Firebase Push Notifications -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>
</body>
</html>
