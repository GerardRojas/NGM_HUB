<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGM HUB â€” Pipeline Manager</title>

  <!-- Fonts: Inter + Roboto (NGM standard) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet"
  />

  <!-- Base layout + Pipeline styles -->
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/pipeline_styles.css" />
  <script src="assets/js/config.js" defer></script>
  <script src="assets/js/permissions.js" defer></script>
  <script src="assets/js/pills.js" defer></script>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar con mÃ³dulos dinÃ¡micos -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img 
                    src="assets/img/logo.png" 
                    alt="NGM HUB Logo"
                    class="sidebar-logo-img"
                />
            </div>
            <div class="sidebar-title-block">
                <p class="sidebar-title">NGM HUB</p>
            </div>

            <div class="sidebar-nav-card">
                <nav class="sidebar-nav" id="sidebar-nav">
                    <a href="dashboard.html" class="nav-item" data-module="dashboard">Dashboard</a>
                    <a href="expenses.html" class="nav-item" data-module="expenses">Expenses Engine</a>
                    <a href="pipeline.html" class="nav-item nav-item-active" data-module="pipeline">Pipeline Manager</a>
                    <a href="projects.html" class="nav-item" data-module="projects">Projects</a>
                    <a href="vendors.html" class="nav-item" data-module="vendors">Vendors</a>
                    <a href="accounts.html" class="nav-item" data-module="accounts">Accounts</a>
                    <a href="estimator.html" class="nav-item" data-module="estimator">Estimator Suite</a>
                    <a href="team.html" class="nav-item" data-module="team">Team Management</a>
                </nav>
            </div>
        </aside>

        <!-- Zona principal -->
        <div class="main-area">
<!-- Topbar igual al dashboard -->
<header class="ngm-topbar">
  <!-- LEFT: brand / contexto -->
  <div class="ngm-bar-left">
    <div class="ngm-brand">
      <div class="ngm-brand-icon-small">
        <span>âš¡</span>
      </div>
      <div class="ngm-brand-text">
        <span class="ngm-brand-org">Next Generation Management</span>
        <span class="ngm-brand-context">NGM Hub Â· Pipeline Manager</span>
      </div>
    </div>
  </div>

  <!-- RIGHT: meta + search + user -->
  <div class="ngm-topbar-right">
    <div class="ngm-meta">
      <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment Â· â€”</span>
      <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server Â· â€”</span>
    </div>

    <!-- Search bar -->
    <form class="ngm-search" role="search" onsubmit="return false;">
      <span class="ngm-global-search-icon">âŒ•</span>
      <input
        id="pipeline-search-input"
        type="search"
        class="ngm-search-input"
        placeholder="Searchâ€¦"
        aria-label="Search"
      />
    </form>

    <!-- Usuario / rol -->
    <span id="user-pill" class="user-pill">User Â· â€”</span>
  </div>
</header>


        <main class="main-content">
            <section class="pipeline-section">

                <!-- âœ… Wrapper interno del pipeline -->
                <div class="pm-panel">

                    <!-- TOOLBAR dividida en 2 cards -->
                    <div class="pm-toolbar-grid">
                        <!-- Card 1: filtros -->
                        <div class="pm-toolbar-card pm-toolbar-card--filters">
                            <div class="pm-toolbar-card-header">
                                <span class="section-title">Filters</span>
                            </div>
                            <div class="pm-toolbar-card-body">
                                <div class="pm-filters">
                                    <label class="filter-label">
                                        Project
                                        <select id="project-filter" class="filter-select">
                                            <option value="all">All</option>
                                        </select>
                                    </label>

                                    <label class="filter-label">
                                        Owner
                                        <select id="owner-filter" class="filter-select">
                                            <option value="all">All</option>
                                        </select>
                                    </label>

                                    <label class="filter-label">
                                        Priority
                                        <select id="priority-filter" class="filter-select">
                                            <option value="all">All</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: layout + manage mode -->
                        <div class="pm-toolbar-card pm-toolbar-card--layout">
                            <div class="pm-toolbar-card-header">
                                <span class="section-title">Layout</span>
                            </div>
                            <div class="pm-toolbar-card-body pm-toolbar-layout-body">
                                <div class="pm-layout-actions">
                                    <button id="btnNewTask" type="button" class="pm-btn pm-btn-secondary btn-small"> 
                                     <span class="pm-btn-icon">ï¼‹</span>
                                     <span>New Task</span>
                                    </button>

                                    <button
                                        id="btnManageLayout"
                                        type="button"
                                        class="pm-btn pm-btn-secondary btn-small"
                                    >
                                        <span class="pm-btn-icon">âš™</span>
                                        <span>Manage Layout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wrapper de grupos de pipeline -->
                    <div id="pm-groups-wrapper" class="pm-groups-wrapper">
                        <!-- Groups se renderizan por JS -->
                    </div>

                </div>
            </section>
        </main>
    </div>
</div>

<!-- Modal: Manage layout (estilo global como Estimator) -->
<div id="layoutModal" class="modal-backdrop hidden">

  <div class="modal">

    <div class="modal-header">
      <div class="modal-title">Manage Layout</div>
      <button type="button" class="modal-btn header-action" id="btnCloseLayoutModal">Ã—</button>
    </div>

    <div class="modal-body">

        <!-- Ancho del panel / tabla -->
        <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Panel width</h3>

        <div class="pm-width-control">
            <span class="pm-width-control-label">Min table width</span>
            <input
            id="pm-width-slider"
            class="pm-width-slider"
            type="range"
            min="1000"
            max="2500"
            step="50"
            value="1200"
            />
            <span id="pm-width-value" class="pm-width-control-value">1200px</span>
        </div>
        </section>


      <!-- Grupos visibles -->
      <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Visible groups</h3>
        <div class="pm-checkbox-grid">
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="not started" />
            <span>Not Started</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="working on it" />
            <span>Working on It</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="awaiting approval" />
            <span>Awaiting Approval</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="good to go" />
            <span>Good to Go</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="correction" />
            <span>Correction</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="resubmittal needed" />
            <span>Resubmittal needed</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="done" />
            <span>Done</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="delayed" />
            <span>Delayed</span>
          </label>
        </div>
      </section>

    
    <!-- Columnas visibles -->
    <section class="pm-modal-section">
    <h3 class="pm-modal-section-title">Visible columns</h3>

    <!--
        âš ï¸ IMPORTANTE:
        Este contenedor se llena dinÃ¡micamente desde JS
        usando la definiciÃ³n global COLUMNS
    -->
    <div
        id="pm-columns-list"
        class="pm-checkbox-grid pm-checkbox-grid--columns"
    ></div>
    </section>


    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="btnCancelLayout">Cancel</button>
      <button type="button" class="btn-primary" id="btnApplyLayout">Apply</button>
    </div>

  </div>
</div>

    <!-- Root donde vamos a inyectar modales (partials) -->
    <div id="modals-root"></div>

    <!-- UI handlers del modal (abre/cierra/bind) -->
    <script src="assets/js/pipeline_new_task_ui.js"></script>

    <!-- Carga del partial + bind SOLO cuando ya existe en el DOM -->
    <script type="module">
     import { loadHtmlFragment } from "./assets/js/html_loader.js";

    loadHtmlFragment("./partials/new_task_modal.html", "#modals-root")
        .then(() => {
         console.log("[PARTIAL] New Task modal loaded");
         window.PM_NewTask?.bind();
        })
        .catch((err) => console.error("[PARTIAL] load failed:", err));
    </script>

    <script src="assets/js/pipeline_table_interactions.js"></script>

    <script>
            // ================================
            // Sidebar: mÃ³dulos segÃºn accesos
            // ================================
            const sidebarNav = document.getElementById("sidebar-nav");

            const AVAILABLE_MODULES = {
            dashboard: { key: "dashboard", label: "Dashboard", href: "dashboard.html" },
            projects:  { key: "projects",  label: "Projects",  href: "projects.html" },
            pipeline:  { key: "pipeline",  label: "Pipeline",  href: "pipeline.html" },
            estimator: { key: "estimator", label: "Estimator", href: "#" },
            expenses:  { key: "expenses",  label: "Expenses",  href: "#" },
            settings:  { key: "settings",  label: "Settings",  href: "#" },
            };

            // TODO: en producciÃ³n esto vendrÃ¡ del backend segÃºn el rol del usuario
            const USER_MODULES = ["dashboard", "projects", "pipeline", "estimator", "expenses"];

            function initLayoutControls() {
            const overlay = document.getElementById("layoutModal");           // overlay/backdrop
            const btnOpen = document.getElementById("btnManageLayout");       // abre modal
            if (!overlay || !btnOpen) return;

            const modalCard = overlay.querySelector(".modal");               // card interna
            const btnClose = document.getElementById("btnCloseLayoutModal"); // X (si existe)
            const btnCancel = document.getElementById("btnCancelLayout");    // Cancel
            const btnApply = document.getElementById("btnApplyLayout");      // Apply

            const openModal = () => overlay.classList.remove("hidden");
            const closeModal = () => overlay.classList.add("hidden");

            // Evita cerrar al click dentro del card
            modalCard?.addEventListener("click", (e) => e.stopPropagation());

            // Cerrar al click en overlay
            overlay.addEventListener("click", closeModal);

            // Abrir
            btnOpen.addEventListener("click", (e) => {
                e.preventDefault();
                openModal();

                // âœ… Pintar columnas (dinÃ¡mico)
                const visibleMap = loadVisibleCols(COLUMNS);
                buildColumnsModal(COLUMNS, visibleMap);
                // âœ… sync groups checks desde persistencia
                syncGroupsCheckboxesInModal(loadVisibleGroups());
            });

            // Cerrar
            btnClose?.addEventListener("click", (e) => {
                e.preventDefault();
                closeModal();
            });

            // Apply
            btnApply?.addEventListener("click", (e) => {
                e.preventDefault();

                const newMap = readColumnsModalState(COLUMNS);
                saveVisibleCols(newMap);
                applyVisibleColsToTables(newMap);

                // âœ… guardar grupos visibles
                const newGroupsMap = readGroupsFromModal();
                saveVisibleGroups(newGroupsMap);

                // âœ… re-render para aplicar el filtro de grupos
                renderGroups();
                
                window.initTableWidthSlider?.();

                closeModal();
            });
            }



        function renderSidebarModules(modulesKeys) {
        if (!sidebarNav) return;
        sidebarNav.innerHTML = "";

        modulesKeys.forEach((key) => {
            const mod = AVAILABLE_MODULES[key];
            if (!mod) return;

            const a = document.createElement("a");
            a.href = mod.href;
            a.className = "nav-item" + (key === "pipeline" ? " nav-item-active" : "");

            const labelSpan = document.createElement("span");
            labelSpan.className = "nav-item-label";
            labelSpan.textContent = mod.label;

            a.appendChild(labelSpan);
            sidebarNav.appendChild(a);
        });
        }

        // ================================
        // Pipeline: datos y lÃ³gica de UI
        // ================================

        // ðŸ”§ MODO LOCAL
        // API base (prod desde config.js, fallback local solo si no existe)
        // API base (misma lÃ³gica que el resto del HUB
        const API_BASE = window.API_BASE || "https://ngm-fastapi.onrender.com";

        const groupsWrapper = document.getElementById("pm-groups-wrapper");
        const projectFilter = document.getElementById("project-filter");
        const ownerFilter = document.getElementById("owner-filter");
        const priorityFilter = document.getElementById("priority-filter");
        const manageBtn = document.getElementById("btnNewTask");
        if (manageBtn) {
         manageBtn.addEventListener("click", () => {
            // New Task â†’ abre modal
            window.PM_NewTask?.open?.(); // o si tu UI expone open()
            // si tu UI solo tiene bind(), entonces:
            // document.getElementById("newTaskModal")?.classList.remove("hidden");
        });
        }
        const searchInput = document.getElementById("pipeline-search-input");

        // ðŸ”‘ storage key
        const PM_COLS_STORAGE_KEY = "pm_visible_columns_v1";
        const PM_GROUPS_STORAGE_KEY = "pm_visible_groups_v1";

        const COLUMNS = [
            { key: "task", label: "Task" },
            { key: "project", label: "Project" },
            { key: "owner", label: "Owner" },
            { key: "collaborator", label: "Collaborator" },
            { key: "manager", label: "Manager" },
            { key: "company", label: "Company" },

            // backend
            { key: "department", label: "Department" },
            { key: "type", label: "Type" },
            { key: "time_start", label: "Time Start" },
            { key: "time_finish", label: "Time Finish" },

            { key: "start", label: "Start" },
            { key: "est", label: "Est (h)" },
            { key: "priority", label: "Priority" },
            { key: "finished", label: "Finished" },
            { key: "due", label: "Due" },
            { key: "links", label: "Links" },
        ];

        
        // ================================
        // Column layout (shared by all tables)
        // ================================

        function buildColGroup() {
        return `
            <colgroup>
            ${COLUMNS.map(col => {
                return `<col data-col="${col.key}">`;
            }).join("")}
            </colgroup>
        `;
        }
        
        function getDefaultVisibleGroups() {
        // default: todos los grupos visibles (los keys deben coincidir con data-group-key)
        return {
            "not started": true,
            "working on it": true,
            "awaiting approval": true,
            "good to go": true,
            "correction": true,
            "resubmittal needed": true,
            "done": true,
            "delayed": true,
        };
        }

        function loadVisibleGroups() {
        try {
            const raw = localStorage.getItem(PM_GROUPS_STORAGE_KEY);
            if (!raw) return getDefaultVisibleGroups();

            const parsed = JSON.parse(raw);
            const merged = getDefaultVisibleGroups();

            Object.keys(parsed || {}).forEach(k => {
            if (k in merged) merged[k] = !!parsed[k];
            });

            return merged;
        } catch (e) {
            console.warn("[PIPELINE] loadVisibleGroups failed:", e);
            return getDefaultVisibleGroups();
        }
        }

        function saveVisibleGroups(map) {
        localStorage.setItem(PM_GROUPS_STORAGE_KEY, JSON.stringify(map));
        }

        function syncGroupsCheckboxesInModal(visibleGroupsMap) {
        // busca los checks existentes en tu HTML (data-group-key)
        document.querySelectorAll('#layoutModal input[type="checkbox"][data-group-key]').forEach(cb => {
            const key = (cb.getAttribute("data-group-key") || "").trim().toLowerCase();
            if (!key) return;
            cb.checked = !!visibleGroupsMap[key];
        });
        }

        function readGroupsFromModal() {
        const map = getDefaultVisibleGroups();

        document.querySelectorAll('#layoutModal input[type="checkbox"][data-group-key]').forEach(cb => {
            const key = (cb.getAttribute("data-group-key") || "").trim().toLowerCase();
            if (!key) return;
            map[key] = cb.checked;
        });

        return map;
        }

        function getDefaultVisibleCols(COLUMNS) {
            const map = {};
            COLUMNS.forEach(c => (map[c.key] = true));
            return map;
        }

        function loadVisibleCols(COLUMNS) {
            try {
                const raw = localStorage.getItem(PM_COLS_STORAGE_KEY);
                if (!raw) return getDefaultVisibleCols(COLUMNS);

                const parsed = JSON.parse(raw);
                const merged = getDefaultVisibleCols(COLUMNS);

                Object.keys(parsed || {}).forEach(k => {
                    if (k in merged) merged[k] = !!parsed[k];
                });

                return merged;
            } catch (e) {
                console.warn("[PIPELINE] loadVisibleCols failed:", e);
                return getDefaultVisibleCols(COLUMNS);
            }
        }

        function saveVisibleCols(map) {
            localStorage.setItem(PM_COLS_STORAGE_KEY, JSON.stringify(map));
        }

        function applyVisibleColsToTables(visibleMap) {
          document.querySelectorAll(".pm-group .table").forEach(table => {

            // th + td
            table.querySelectorAll("th[data-col], td[data-col]").forEach(el => {
              const key = el.dataset.col;
              el.style.display = visibleMap[key] ? "" : "none";
            });

            // colgroup (CLAVE para eliminar el hueco)
            table.querySelectorAll("col[data-col]").forEach(col => {
              const key = col.dataset.col;
              col.style.display = visibleMap[key] ? "" : "none";
            });
        });

        // fuerza recÃ¡lculo de ancho
        window.refreshPipelineTables?.();
        }


        function buildColumnsModal(COLUMNS, visibleMap) {
        const list = document.getElementById("pm-columns-list");
        if (!list) return;

        list.innerHTML = COLUMNS.map(c => `
            <label class="pm-checkbox">
            <input type="checkbox" data-col="${c.key}" ${visibleMap[c.key] ? "checked" : ""} />
            <span>${c.label}</span>
            </label>
        `).join("");
        }

        function readColumnsModalState(COLUMNS) {
            const list = document.getElementById("pm-columns-list");
            const map = {};
            COLUMNS.forEach(c => (map[c.key] = true));

            if (!list) return map;

            list.querySelectorAll("input[data-col]").forEach(cb => {
                map[cb.dataset.col] = cb.checked;
            });

            return map;
        }

        let rawGroups = [];
        let searchQuery = "";

        // Expose fetchPipeline to window for modal refresh
        window.fetchPipeline = fetchPipeline;

        async function fetchPipeline() {
            try {
                const res = await fetch(`${API_BASE}/pipeline/grouped`);
                if (!res.ok) throw new Error("Error loading pipeline");
                const data = await res.json();

                console.log("[PIPELINE] raw response:", data);

                if (Array.isArray(data)) {
                rawGroups = data;
                } else if (Array.isArray(data.groups)) {
                rawGroups = data.groups;
                } else if (data.groups && typeof data.groups === "object") {
                // ðŸ‘ˆ caso FastAPI agrupado por status
                rawGroups = Object.entries(data.groups).map(([status, tasks]) => ({
                    status_name: status,
                    tasks: Array.isArray(tasks) ? tasks : [],
                }));
                } else if (typeof data === "object") {
                // ðŸ‘ˆ fallback ultra defensivo
                rawGroups = Object.entries(data).map(([status, tasks]) => ({
                    status_name: status,
                    tasks: Array.isArray(tasks) ? tasks : [],
                }));
                } else {
                rawGroups = [];
                }

                console.log("[PIPELINE] parsed groups:", rawGroups);

                populateFilters(rawGroups);
                renderGroups();
            } catch (err) {
                console.error("[PIPELINE] fetch error:", err);
                if (groupsWrapper) {
                    groupsWrapper.innerHTML = "<p class='panel-text'>Error loading pipeline data.</p>";
                }
            }
        }

        function populateFilters(groups) {
            const projects = new Set();
            const owners = new Set();
            const priorities = new Set();

            groups.forEach(group => {
                const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                tasks.forEach(t => {
                    // Proyecto: intenta varios campos comunes
                    const projectValue =
                        t.project_name ||
                        t.project ||
                        t.project_title ||
                        t.project_id ||
                        "";

                    if (projectValue) {
                        projects.add(projectValue);
                    }

                    // Owner: intenta varios formatos
                    const ownerValue =
                        (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                        t.owner_name ||
                        t.assigned_to ||
                        "";

                    if (ownerValue) {
                        owners.add(ownerValue);
                    }

                    // Priority: varios nombres posibles
                    const priorityValue =
                        (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                        t.priority_name ||
                        t.priority ||
                        "";

                    if (priorityValue) {
                        priorities.add(priorityValue);
                    }
                });
            });

            function fillSelect(select, values) {
                if (!select) return;
                const current = select.value;
                select.innerHTML = "<option value='all'>All</option>";
                Array.from(values).sort().forEach(v => {
                    const opt = document.createElement("option");
                    opt.value = v.toString();
                    opt.textContent = v.toString();
                    select.appendChild(opt);
                });
                if (Array.from(values).includes(current)) {
                    select.value = current;
                }
            }

            fillSelect(projectFilter, projects);
            fillSelect(ownerFilter, owners);

            const mappedPriorities = new Map();
            Array.from(priorities).forEach(p => {
                mappedPriorities.set(p.toString().toLowerCase(), p);
            });
            const normalized = Array.from(mappedPriorities.entries())
                .sort((a, b) => a[1].toString().localeCompare(b[1].toString()));

            if (priorityFilter) {
                priorityFilter.innerHTML = "<option value='all'>All</option>";
                normalized.forEach(([key, label]) => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = label.toString();
                    priorityFilter.appendChild(opt);
                });
            }
        }

        function applyFilters(groups) {
            const selectedProject = projectFilter ? projectFilter.value : "all";
            const selectedOwner = ownerFilter ? ownerFilter.value : "all";
            const selectedPriority = priorityFilter ? priorityFilter.value : "all";

            return groups.map(group => {
                const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                const filteredTasks = tasks.filter(t => {
                    // Proyecto
                    const pid =
                        t.project_name ||
                        t.project ||
                        t.project_title ||
                        t.project_id ||
                        "";
                    const projectPass =
                        selectedProject === "all" || pid === selectedProject;

                    // Owner
                    const ownerName =
                        (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                        t.owner_name ||
                        t.assigned_to ||
                        "";
                    const ownerPass =
                        selectedOwner === "all" || ownerName === selectedOwner;

                    // Priority
                    const priorityLabel =
                        (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                        t.priority_name ||
                        t.priority ||
                        "";
                    const pKey = priorityLabel.toString().toLowerCase();
                    const priorityPass =
                        selectedPriority === "all" || pKey === selectedPriority;

                    // Search
                    const q = (searchQuery || "").trim().toLowerCase();
                    let searchPass = true;
                    if (q) {
                        const haystack = [
                            t.task_description,
                            t.task_notes,
                            pid,
                            ownerName,
                            priorityLabel,
                        ]
                            .filter(Boolean)
                            .join(" ")
                            .toLowerCase();

                        searchPass = haystack.includes(q);
                    }

                    return projectPass && ownerPass && priorityPass && searchPass;
                });

                return {
                    ...group,
                    tasks: filteredTasks,
                };
            });
        }

        function renderGroups() {
            if (!groupsWrapper) return;

            const groups = applyFilters(rawGroups);
            console.log("[PIPELINE] rendering groups:", groups);

            groupsWrapper.innerHTML = "";

            if (!groups.length) {
                groupsWrapper.innerHTML = "<p class='panel-text'>No pipeline groups to display.</p>";
                return;
            }

            function escapeHtml(s) {
                return String(s)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function getInitial(name) {
            const s = String(name || "").trim();
            if (!s) return "?";
            return s[0].toUpperCase();
            }

            function hashStringToHue(str) {
            // hash simple y estable -> hue 0..359
            let h = 0;
            for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
            return h % 360;
            }

            function renderPerson(name) {
            const raw = String(name || "").trim();
            const safeName = escapeHtml(raw || "-");
            const initial = escapeHtml(getInitial(raw || "-"));

            const key = raw ? raw.toLowerCase() : "__unknown__";
            const hue = hashStringToHue(key);

            const bg = raw ? `hsl(${hue} 55% 35%)` : "#334155";
            const ring = raw ? `hsl(${hue} 65% 55%)` : "rgba(148, 163, 184, 0.6)";

            return `
                <span class="pm-person" title="${safeName}">
                <span class="pm-avatar" style="--av-bg:${bg}; --av-ring:${ring};">${initial}</span>
                <span class="pm-person-name">${safeName}</span>
                </span>
            `;
            }



            function formatMaybeDate(v) {
                if (!v) return "-";
                // si viene como string ISO, lo mostramos â€œcortoâ€ para tabla
                const s = String(v);
                // 2025-12-07T06:21:42.156005Z -> 2025-12-07
                if (s.includes("T")) return s.split("T")[0];
                return s;
            }

            function getCellValue(t, key) {
                switch (key) {
                    case "task":
                        return escapeHtml(t.task_description || t.title || "(No description)");

                    case "project":
                        return escapeHtml(
                            t.project_name ||
                            t.project ||
                            t.project_title ||
                            t.project_id ||
                            "-"
                        );

                    case "owner": {
                        const name =
                            (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                            t.owner_name ||
                            t.assigned_to ||
                            "";
                        return renderPerson(name || "-");
                    }

                    case "collaborator": {
                        const name =
                            (Array.isArray(t.collaborators) &&
                                t.collaborators.length > 0 &&
                                (t.collaborators[0].name || t.collaborators[0].id)) ||
                            "";
                        return renderPerson(name || "-");
                    }


                    case "company":
                        return escapeHtml(t.company_name || "-");

                    // âœ… nuevas columnas del JSON (t.*)
                    case "department":
                        return escapeHtml(t.department || "-");

                    case "type":
                        return escapeHtml(t.type || "-");

                    case "time_start":
                        return escapeHtml(t.time_start || "-");

                    case "time_finish":
                        return escapeHtml(t.time_finish || "-");

                    case "start":
                        return escapeHtml(formatMaybeDate(t.start_date));

                    case "est": {
                        const v = (typeof t.estimated_hours === "number")
                            ? t.estimated_hours
                            : (t.estimated_hours ?? null);
                        return escapeHtml(v != null ? v : "-");
                    }

                    case "priority":
                        return escapeHtml(
                            (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                            t.priority_name ||
                            t.priority ||
                            "-"
                        );

                    case "finished":
                        return escapeHtml(
                            (t.finished_status &&
                                (t.finished_status.completed_status_name ||
                                t.finished_status.completed_status_id)) ||
                            t.finished_status_name ||
                            "-"
                        );

                    case "due":
                        // prefiero due_date -> deadline -> fallback
                        return escapeHtml(formatMaybeDate(t.due_date || t.deadline || t.due));

                    case "links": {
                        const docsLink = t.docs_link || null;
                        const resultLink = t.result_link || null;

                        if (!docsLink && !resultLink) return "-";

                        const parts = [];
                        if (docsLink) {
                            parts.push(`<a href="${escapeHtml(docsLink)}" target="_blank" rel="noopener noreferrer">Docs</a>`);
                        }
                        if (resultLink) {
                            parts.push(`<a href="${escapeHtml(resultLink)}" target="_blank" rel="noopener noreferrer">Result</a>`);
                        }
                        return parts.join(" Â· ");
                    }

                    default:
                        return "-";
                }
            }

            // ðŸŽ¨ Mapa de colores por status / nombre de grupo (lista oficial)
            const STATUS_ACCENTS = {
                "working on it": "#3b82f6",
                "done": "#22c55e",
                "correction": "#f87171",
                "awaiting approval": "#fb923c",
                "resubmittal needed": "#eab308",
                "good to go": "#10b981",
                "not started": "#facc15",
                "delayed": "#a855f7",
            };

            // ðŸŽ¨ Mapa de clases CSS por status
            const STATUS_CLASS_MAP = {
                "working on it": "pm-group--working-on-it",
                "done": "pm-group--done",
                "correction": "pm-group--correction",
                "awaiting approval": "pm-group--awaiting-approval",
                "resubmittal needed": "pm-group--resubmittal-needed",
                "good to go": "pm-group--good-to-go",
                "not started": "pm-group--not-started",
                "delayed": "pm-group--delayed",
            };

            // ðŸ”¢ ORDEN OFICIAL DE STATUS
            const STATUS_ORDER = [
                "not started",
                "working on it",
                "awaiting approval",
                "good to go",
                "correction",
                "resubmittal needed",
                "done",
                "delayed",
            ];
            const STATUS_RANK = {};
            STATUS_ORDER.forEach((name, idx) => { STATUS_RANK[name] = idx; });

            const visibleGroupsMap = loadVisibleGroups();

            const filteredGroups = groups.filter(g => {
                const name = (g.status_name || g.group_name || g.name || "").trim().toLowerCase();
                // si es un status conocido, respeta visibilidad; si no es conocido, lo dejamos visible
                if (name in visibleGroupsMap) return !!visibleGroupsMap[name];
                return true;
            });

            const sortedGroups = [...filteredGroups].sort((a, b) => {
                const nameA = (a.status_name || a.group_name || a.name || "").trim().toLowerCase();
                const nameB = (b.status_name || b.group_name || b.name || "").trim().toLowerCase();

                const rankA = STATUS_RANK[nameA] ?? 999;
                const rankB = STATUS_RANK[nameB] ?? 999;

                if (rankA !== rankB) return rankA - rankB;
                return nameA.localeCompare(nameB);
            });

            // ==========================
            // RENDER DE CADA GRUPO
            // ==========================
            sortedGroups.forEach(group => {
                const tasks =
                    Array.isArray(group.tasks) ? group.tasks :
                    Array.isArray(group.items) ? group.items :
                    Array.isArray(group.tasks_list) ? group.tasks_list :
                    [];

                const groupName =
                    group.status_name ||
                    group.group_name ||
                    group.name ||
                    "Group";

                const groupElem = document.createElement("div");
                groupElem.className = "pm-group";

                const statusKey = groupName.trim().toLowerCase();

                const cssClass = STATUS_CLASS_MAP[statusKey];
                if (cssClass) groupElem.classList.add(cssClass);

                const accentColor = STATUS_ACCENTS[statusKey] || "#3e4042";
                groupElem.style.setProperty("--pm-group-accent", accentColor);

                const header = document.createElement("div");
                header.className = "pm-group-header";
                header.innerHTML = `
                    <h3 class="section-title" style="color:${accentColor};">
                        ${groupName}
                    </h3>
                    <span class="ngm-pill"><span class="ngm-pill-value">${tasks.length} tasks</span></span>
                `;

                const body = document.createElement("div");
                body.className = "pm-group-body";

                let isCollapsed = false;
                header.addEventListener("click", () => {
                    isCollapsed = !isCollapsed;
                    body.style.display = isCollapsed ? "none" : "";
                    header.classList.toggle("pm-group-header--collapsed", isCollapsed);
                });

                const table = document.createElement("table");
                table.className = "table";

                table.insertAdjacentHTML("afterbegin", buildColGroup());

                const thead = document.createElement("thead");
                thead.innerHTML = `
                <tr>
                    ${COLUMNS.map(c => `<th data-col="${escapeHtml(c.key)}">${escapeHtml(c.label)}</th>`).join("")}
                </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement("tbody");

                if (!tasks.length) {
                    const emptyRow = document.createElement("tr");
                    emptyRow.className = "pm-empty-row";
                    emptyRow.innerHTML = `
                        <td colspan="${COLUMNS.length}" class="pm-empty-cell">
                            <div>No tasks in this group for the current filters.</div>
                        </td>
                    `;
                    tbody.appendChild(emptyRow);
                } else {
                        tasks.forEach(t => {
                         const tr = document.createElement("tr");
                         tr.className = "pm-row";
                         tr.dataset.taskId = t.id || t.task_id || "";

                         tr.innerHTML = COLUMNS.map(col => {
                            const html = getCellValue(t, col.key);
                            return `
                             <td data-col="${escapeHtml(col.key)}">
                                <div>${html}</div>
                             </td>
                            `;
                        }).join("");

                        // ===== dataset para futuro (persistencia / modal) =====
                        const taskId = t.task_id || null;
                        const taskNotes = t.task_notes || null;
                        const companyManagement = t.company_management || null;
                        const startDate = t.start_date || null;

                        const estimatedHours = (typeof t.estimated_hours === "number")
                            ? t.estimated_hours
                            : (t.estimated_hours ?? null);

                        const docsLink = t.docs_link || null;
                        const resultLink = t.result_link || null;

                        const priorityId =
                            (t.priority && t.priority.priority_id) ||
                            t.task_priority ||
                            null;

                        const finishedStatusId =
                            (t.finished_status && t.finished_status.completed_status_id) ||
                            t.task_finished_status ||
                            null;

                        if (taskId) tr.dataset.taskId = String(taskId);
                        if (startDate) tr.dataset.startDate = String(startDate);
                        if (estimatedHours != null) tr.dataset.estimatedHours = String(estimatedHours);
                        if (taskNotes) tr.dataset.taskNotes = String(taskNotes);
                        if (docsLink) tr.dataset.docsLink = String(docsLink);
                        if (resultLink) tr.dataset.resultLink = String(resultLink);
                        if (companyManagement) tr.dataset.companyManagement = String(companyManagement);
                        if (priorityId) tr.dataset.priorityId = String(priorityId);
                        if (finishedStatusId) tr.dataset.finishedStatusId = String(finishedStatusId);

                        // âœ… tambiÃ©n guardamos las nuevas por si el modal las ocupa despuÃ©s
                        if (t.department) tr.dataset.department = String(t.department);
                        if (t.type) tr.dataset.type = String(t.type);
                        if (t.time_start) tr.dataset.timeStart = String(t.time_start);
                        if (t.time_finish) tr.dataset.timeFinish = String(t.time_finish);

                        tbody.appendChild(tr);
                    });
                }

                table.appendChild(tbody);
                body.appendChild(table);

                groupElem.appendChild(header);
                groupElem.appendChild(body);
                groupsWrapper.appendChild(groupElem);
                
            });
            applyVisibleColsToTables(loadVisibleCols(COLUMNS));
        }

        // ================================
        // Eventos de UI
        // ================================
        if (projectFilter) projectFilter.addEventListener("change", renderGroups);
        if (ownerFilter) ownerFilter.addEventListener("change", renderGroups);
        if (priorityFilter) priorityFilter.addEventListener("change", renderGroups);
        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderGroups();
            });
        }

        // ðŸ”¥ Ya NO usamos slider de ancho, asÃ­ que este bloque se puede eliminar.
        // Lo quito para que no haya cÃ³digo muerto.

        // ================================
        // Init global
        // ================================
        window.addEventListener("DOMContentLoaded", () => {
            initTopbarPills?.();
            // Sidebar + topbar
            renderSidebarModules(USER_MODULES);

            try {
            if (typeof initTopbarUserPill === "function") {
                initTopbarUserPill();
            }
            } catch (err) {
            console.warn("[TOPBAR] initTopbarUserPill failed:", err);
            }

            // Pipeline (datos + render)
            // si tu lÃ³gica usa fetchPipeline directamente, dÃ©jalo asÃ­:
            if (typeof fetchPipeline === "function") {
            fetchPipeline();
            }
            // o si lo tienes empaquetado en initPipeline, usa esa:
            // initPipeline?.();

            // Modal de Manage layout
            initLayoutControls();
            if (typeof initTableWidthSlider === "function") {
            initTableWidthSlider();
            }
        });

    </script>
    <script src="assets/js/pipeline_layout.js"></script>
</body>
</html>
