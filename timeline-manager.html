<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1a1a1a" />
    <title>NGM HUB â€” Timeline Manager</title>
    <link rel="icon" type="image/png" href="assets/img/greenblack_icon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="assets/img/greenblack_icon.png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Preload loading logo -->
    <link rel="preload" href="assets/img/white_icon.png" as="image" />

    <!-- Critical CSS for loading overlay -->
    <style>
      body.page-loading { overflow: hidden; }
      .page-loading-overlay { position: fixed; inset: 0; background: #0d0d0d; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; gap: 16px; }
      .page-loading-overlay.hidden { display: none; }
      .page-loading .app-layout { visibility: hidden; }
      .loading-logo { width: 120px; height: 120px; object-fit: contain; animation: pulse 1.5s ease-in-out infinite; }
      .loading-text { color: rgba(255,255,255,0.5); font-size: 13px; font-family: system-ui, sans-serif; letter-spacing: 0.05em; }
      @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }
    </style>

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/expenses_styles.css" />
    <link rel="stylesheet" href="assets/css/toast.css" />
    <link rel="stylesheet" href="assets/css/timeline_manager.css" />
    <link rel="stylesheet" href="assets/css/arturito_widget.css" />
    <link rel="stylesheet" href="assets/css/chat_widget.css" />

    <!-- Frappe Gantt (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

    <!-- Global env/server/user pills -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/toast.js" defer></script>
    <script src="assets/js/permissions.js" defer></script>
    <script src="assets/js/pills.js" defer></script>
    <script src="assets/js/sidebar.js" defer></script>
    <script src="assets/js/page-loading.js" defer></script>
    <script src="assets/js/timeline_manager.js" defer></script>
    <script src="assets/js/arturito_widget.js" defer></script>
    <script src="assets/js/chat_widget.js" defer></script>
</head>
<body class="page-timeline-manager page-loading">
    <!-- Page Loading Overlay -->
    <div class="page-loading-overlay" id="pageLoadingOverlay">
        <img src="assets/img/white_icon.png" class="loading-logo" alt="Loading...">
        <span class="loading-text">Loading...</span>
    </div>

    <div class="app-layout">

        <!-- Sidebar (content generated by sidebar.js) -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main -->
        <div class="main-area">

            <!-- Topbar (system standard) -->
            <header class="ngm-topbar">
                <div class="ngm-bar-left">
                    <!-- Mobile menu button -->
                    <button type="button" class="mobile-menu-btn" id="btnMobileMenu" title="Open menu">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="ngm-brand">
                        <div class="ngm-brand-icon-small"><img src="assets/img/white_icon.png" alt="NGM"></div>
                        <div class="ngm-brand-text">
                            <span class="ngm-brand-org">Next Generation Management</span>
                            <span class="ngm-brand-context">NGM Hub Â· Timeline Manager</span>
                        </div>
                    </div>
                </div>

                <div class="ngm-topbar-right">
                    <div class="ngm-meta">
                        <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment Â· â€”</span>
                        <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server Â· â€”</span>
                    </div>
                    <span id="user-pill" class="user-pill">User Â· â€”</span>
                </div>
            </header>

            <main class="main-content">
                <div class="workspace">

                    <section class="data-section">
                        <!-- Toolbar -->
                        <div class="expenses-toolbar">
                            <div class="toolbar-left">
                                <h2 style="font-size: 18px; font-weight: 600; color: #e5e7eb; margin: 0;">Timeline Manager</h2>
                                <select id="timelineProjectSelect" class="ngm-select" style="min-width: 240px; margin-left: 16px; font-size: 13px; padding: 6px 32px 6px 12px;">
                                    <option value="">Select a project...</option>
                                </select>
                            </div>
                            <div class="toolbar-right">
                                <button type="button" class="btn-toolbar btn-toolbar-secondary" id="btnImportTimeline" style="display:none;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:-2px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                    Import MS Project
                                </button>
                                <div class="tm-view-controls" id="viewControls" style="display:none;">
                                    <button type="button" class="btn-toolbar btn-toolbar-secondary tm-view-btn tm-view-active" data-view="Week">Week</button>
                                    <button type="button" class="btn-toolbar btn-toolbar-secondary tm-view-btn" data-view="Month">Month</button>
                                    <button type="button" class="btn-toolbar btn-toolbar-secondary tm-view-btn" data-view="Quarter Day">Day</button>
                                </div>
                                <button type="button" class="btn-toolbar btn-toolbar-primary" id="btnAddPhase" style="display:none;">
                                    + Add Phase
                                </button>
                            </div>
                        </div>

                        <!-- Gantt container -->
                        <div id="timelineContent">
                            <div class="tm-empty-state" id="timelineEmptyState">
                                <span class="tm-empty-icon">ðŸ“…</span>
                                <span class="tm-empty-text">Select a project to view its timeline</span>
                            </div>
                        </div>

                        <!-- Milestones Section -->
                        <div id="milestonesSection" style="display:none;">
                            <div class="tm-milestones-header">
                                <h3 class="tm-section-title">Milestones</h3>
                                <button type="button" class="btn-toolbar btn-toolbar-secondary" id="btnAddMilestone">+ Add Milestone</button>
                            </div>
                            <div id="milestonesList" class="tm-milestones-list">
                                <!-- rendered by JS -->
                            </div>
                        </div>

                    </section>

                </div>
            </main>
        </div>
    </div>

    <!-- Add Phase Modal -->
    <div class="modal-overlay hidden" id="phaseModal">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="phaseModalTitle">Add Phase</h3>
                <button type="button" class="modal-close" id="btnClosePhaseModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="phaseForm">
                    <input type="hidden" id="phaseId" />
                    <div class="form-field" style="margin-bottom: 16px;">
                        <label class="form-label" for="phaseName">Phase Name *</label>
                        <input type="text" id="phaseName" class="form-input" placeholder="e.g. Foundation" required />
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <div class="form-field" style="flex:1;">
                            <label class="form-label" for="phaseStart">Start Date</label>
                            <input type="date" id="phaseStart" class="form-input" />
                        </div>
                        <div class="form-field" style="flex:1;">
                            <label class="form-label" for="phaseEnd">End Date</label>
                            <input type="date" id="phaseEnd" class="form-input" />
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <div class="form-field" style="flex:1;">
                            <label class="form-label" for="phaseStatus">Status</label>
                            <select id="phaseStatus" class="ngm-select">
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="delayed">Delayed</option>
                            </select>
                        </div>
                        <div class="form-field" style="flex:1;">
                            <label class="form-label" for="phaseProgress">Progress %</label>
                            <input type="number" id="phaseProgress" class="form-input" min="0" max="100" value="0" />
                        </div>
                    </div>
                    <div class="form-field" style="margin-bottom: 16px;">
                        <label class="form-label" for="phaseColor">Color</label>
                        <input type="color" id="phaseColor" class="form-input" value="#3ecf8e" style="height:36px;padding:2px;cursor:pointer;" />
                    </div>
                    <div class="form-field">
                        <label class="form-label" for="phaseNotes">Notes</label>
                        <textarea id="phaseNotes" class="form-input" rows="3" placeholder="Optional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-secondary" id="btnCancelPhase">Cancel</button>
                <button type="button" class="btn-modal btn-modal-primary" id="btnSavePhase">Save Phase</button>
            </div>
        </div>
    </div>

    <!-- Add Milestone Modal -->
    <div class="modal-overlay hidden" id="milestoneModal">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="milestoneModalTitle">Add Milestone</h3>
                <button type="button" class="modal-close" id="btnCloseMilestoneModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="milestoneForm">
                    <input type="hidden" id="milestoneId" />
                    <div class="form-field" style="margin-bottom: 16px;">
                        <label class="form-label" for="milestoneName">Milestone Name *</label>
                        <input type="text" id="milestoneName" class="form-input" placeholder="e.g. Permit Approved" required />
                    </div>
                    <div class="form-field" style="margin-bottom: 16px;">
                        <label class="form-label" for="milestoneDueDate">Due Date</label>
                        <input type="date" id="milestoneDueDate" class="form-input" />
                    </div>
                    <div class="form-field" style="margin-bottom: 16px;">
                        <label class="form-label" for="milestonePhase">Phase (optional)</label>
                        <select id="milestonePhase" class="ngm-select">
                            <option value="">No phase</option>
                        </select>
                    </div>
                    <div class="form-field" style="margin-bottom: 16px;">
                        <label class="form-label" for="milestoneStatus">Status</label>
                        <select id="milestoneStatus" class="ngm-select">
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label" for="milestoneNotes">Notes</label>
                        <textarea id="milestoneNotes" class="form-input" rows="3" placeholder="Optional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-secondary" id="btnCancelMilestone">Cancel</button>
                <button type="button" class="btn-modal btn-modal-primary" id="btnSaveMilestone">Save Milestone</button>
            </div>
        </div>
    </div>

    <!-- Import MS Project Modal -->
    <div class="modal-overlay hidden" id="importModal">
        <div class="modal-container" style="max-width: 520px;">
            <div class="modal-header">
                <h3 class="modal-title">Import from MS Project</h3>
                <button type="button" class="modal-close" id="btnCloseImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #9ca3af; font-size: 13px; margin: 0 0 16px;">
                    Upload an XML or CSV file exported from Microsoft Project. Summary tasks will become phases, and milestone tasks will become milestones.
                </p>

                <!-- Drop zone -->
                <div class="import-dropzone" id="importDropzone">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="1.5" style="margin-bottom:8px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span class="import-dropzone-text">Drop your .xml or .csv file here</span>
                    <span class="import-dropzone-sub">or click to browse</span>
                    <input type="file" id="importFileInput" accept=".xml,.csv" style="display:none;" />
                </div>

                <!-- File selected indicator -->
                <div class="import-file-info hidden" id="importFileInfo">
                    <span class="import-file-name" id="importFileName"></span>
                    <button type="button" class="import-file-remove" id="btnRemoveFile" title="Remove file">&times;</button>
                </div>

                <!-- Import mode -->
                <div class="form-field" style="margin-top: 16px;">
                    <label class="form-label">Import Mode</label>
                    <div style="display: flex; gap: 12px; margin-top: 4px;">
                        <label class="import-radio-label">
                            <input type="radio" name="importMode" value="replace" checked />
                            <span>Replace existing</span>
                        </label>
                        <label class="import-radio-label">
                            <input type="radio" name="importMode" value="append" />
                            <span>Append to existing</span>
                        </label>
                    </div>
                    <p style="color: #6b7280; font-size: 11px; margin: 6px 0 0;">
                        "Replace" will delete current phases and milestones before importing.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-secondary" id="btnCancelImport">Cancel</button>
                <button type="button" class="btn-modal btn-modal-primary" id="btnConfirmImport" disabled>Import</button>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener("DOMContentLoaded", () => {
            if (window.initTopbarPills) window.initTopbarPills();
        });
    </script>

    <!-- Firebase Push Notifications -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
    <script src="assets/js/firebase-init.js"></script>
</body>
</html>
