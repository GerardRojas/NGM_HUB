<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1a1a1a" />
    <title>NGM HUB â€” Agent Hub</title>
    <link rel="icon" type="image/png" href="assets/img/arturito_icon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="assets/img/greenblack_icon.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Preload loading logo -->
    <link rel="preload" href="assets/img/white_icon.png" as="image" />

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/expenses_styles.css" />
    <link rel="stylesheet" href="assets/css/toast.css" />

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/permissions.js" defer></script>
    <script src="assets/js/pills.js" defer></script>
    <script src="assets/js/sidebar.js" defer></script>
    <script src="assets/js/toast.js" defer></script>
    <script src="assets/js/arturito_analytics.js" defer></script>

    <style>
        /* ====== Full-width override (same as expenses page) ====== */
        .page-settings .main-content {
            max-width: none;
            width: 100%;
        }

        /* ====== Fixed container height ====== */
        .expenses-table-container {
            height: calc(100vh - 280px);
            min-height: 500px;
        }
        #settingsContent {
            height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
        }

        /* ====== Hub Grid ====== */
        .hub-header { margin-bottom: 28px; }
        .hub-header h2 {
            font-size: 13px; font-weight: 500;
            color: var(--text-primary); margin: 0;
        }
        .hub-header p {
            font-size: 11px; color: var(--ngm-text-muted);
            margin: 4px 0 0;
        }

        .hub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            align-items: stretch;
        }

        .hub-card {
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-md);
            padding: 20px;
            cursor: pointer;
            transition: border-color 0.15s ease, background-color 0.15s ease;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 180px;
        }

        .hub-card:hover {
            background: var(--ngm-bg-surface-soft);
            border-color: var(--border-strong);
        }

        .hub-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .hub-card-top {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .agent-avatar-lg {
            width: 48px;
            height: 48px;
            font-size: 16px;
        }

        .hub-card-identity { flex: 1; min-width: 0; }

        .hub-card-name {
            font-size: 0.95rem; font-weight: 500;
            color: var(--text-primary); margin: 0;
        }
        .hub-card-role {
            font-size: 0.8rem; color: var(--ngm-text-muted);
            margin: 3px 0 0;
        }

        .hub-status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .hub-status-active { background: var(--accent); }
        .hub-status-idle { background: #fbbf24; }
        .hub-status-disabled { background: #ef4444; }

        .hub-card-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 14px;
            border-top: 1px solid var(--border-soft);
        }

        .hub-metric { text-align: center; }
        .hub-metric-value {
            font-size: 16px; font-weight: 600;
            color: var(--text-primary); display: block;
        }
        .hub-metric-value.metric-error { color: #ef4444; }
        .hub-metric-value.metric-success { color: var(--accent); }
        .hub-metric-value.metric-muted { color: var(--ngm-text-muted, #94a3b8); }
        .hub-metric-label {
            font-size: 11px; color: var(--ngm-text-muted);
            display: block; margin-top: 2px;
        }

        .hub-card-footer { text-align: right; }
        .hub-card-cta {
            font-size: 12px; color: var(--accent);
            opacity: 0; transition: opacity 0.15s ease;
        }
        .hub-card:hover .hub-card-cta { opacity: 1; }

        /* ====== Detail View ====== */
        .detail-back-btn {
            background: none; border: none;
            color: var(--text-secondary); font-size: 13px;
            cursor: pointer; padding: 0;
            margin-bottom: 24px;
            display: inline-flex; align-items: center; gap: 6px;
            transition: color 0.15s ease;
        }
        .detail-back-btn:hover { color: var(--text-primary); }

        .detail-header {
            display: flex; align-items: center; gap: 16px;
            margin-bottom: 24px;
        }

        .detail-header-info { flex: 1; }
        .detail-agent-name {
            font-size: 15px; font-weight: 500;
            color: var(--text-primary); margin: 0;
        }
        .detail-agent-role {
            font-size: 12px; color: var(--ngm-text-muted);
            margin: 4px 0 0;
        }

        .detail-status-badge {
            padding: 2px 6px; border-radius: 4px;
            font-size: 10px; font-weight: 500;
            text-transform: uppercase;
        }

        .detail-status-active {
            background: rgba(62,207,142,0.15); color: var(--accent);
            border: 1px solid rgba(62,207,142,0.3);
        }

        .detail-status-disabled {
            background: rgba(239,68,68,0.15); color: #ef4444;
            border: 1px solid rgba(239,68,68,0.3);
        }

        .detail-tabs {
            display: flex; gap: 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-soft);
        }

        .detail-tab-btn {
            background: none; border: none;
            border-bottom: 2px solid transparent;
            color: var(--ngm-text-muted); font-size: 13px; font-weight: 500;
            padding: 10px 16px; cursor: pointer;
            transition: color 0.15s ease, border-color 0.15s ease;
        }
        .detail-tab-btn:hover { color: var(--text-primary); }
        .detail-tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .detail-tab-panel { display: none; }
        .detail-tab-panel.is-active { display: block; }

        /* ====== Reused Component Styles ====== */

        .permission-card {
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-md);
            padding: 24px;
        }

        .permission-card + .permission-card { margin-top: 16px; }

        .permission-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-soft);
        }

        .permission-card-title {
            font-size: 13px; font-weight: 500;
            color: var(--text-primary);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin: 0; display: flex; align-items: center; gap: 8px;
        }

        .permission-card-title .category-icon {
            width: 20px; height: 20px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        .category-read { background: rgba(62,207,142,0.15); color: var(--accent); }
        .category-create { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .category-update { background: rgba(249,115,22,0.15); color: #f97316; }
        .category-delete { background: rgba(239,68,68,0.15); color: #ef4444; }
        .category-notification { background: rgba(168,85,247,0.15); color: #a855f7; }
        .category-navigation { background: rgba(20,184,166,0.15); color: #14b8a6; }

        .permission-list { display: flex; flex-direction: column; gap: 12px; }

        .permission-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-main);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-sm);
            transition: border-color 0.15s ease;
        }
        .permission-item:hover { border-color: var(--border-strong); }

        .permission-info { display: flex; flex-direction: column; gap: 4px; }
        .permission-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
        .permission-desc { font-size: 12px; color: var(--ngm-text-muted); }

        .permission-risk {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 500; text-transform: uppercase;
            padding: 2px 6px; border-radius: 4px; margin-top: 4px;
        }

        .risk-low { background: rgba(62,207,142,0.15); color: var(--accent); }
        .risk-medium { background: rgba(249,115,22,0.15); color: #f97316; }
        .risk-high { background: rgba(239,68,68,0.15); color: #ef4444; }

        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; inset: 0; cursor: pointer; border-radius: 24px;
            background: var(--border-strong); transition: background 0.15s ease;
        }
        .toggle-slider::before {
            content: ""; position: absolute; width: 18px; height: 18px;
            left: 3px; bottom: 3px; border-radius: 50%;
            background: #fff; transition: transform 0.15s ease;
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }
        .toggle-switch input:disabled + .toggle-slider { opacity: 0.5; cursor: not-allowed; }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }

        .stat-card {
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex; flex-direction: column; gap: 8px;
        }

        .stat-label {
            font-size: 11px; color: var(--ngm-text-muted);
            text-transform: uppercase; letter-spacing: 0.05em;
        }

        .stat-value { font-size: 24px; font-weight: 600; color: var(--text-primary); }
        .stat-value.enabled { color: var(--accent); }
        .stat-value.disabled { color: #ef4444; }

        /* Module Tree (Scope of Work) */
        .module-tree { display: flex; flex-direction: column; gap: 16px; }

        .module-group {
            border-left: 2px solid var(--border-strong);
            padding-left: 16px;
        }

        .module-name {
            font-size: 13px; font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }

        .module-functions { display: flex; flex-direction: column; gap: 4px; margin-left: 8px; }

        .function-item {
            font-size: 12px; color: var(--text-secondary);
            display: flex; align-items: center; gap: 6px;
        }
        .function-item::before {
            content: "---"; color: var(--ngm-text-subtle);
            font-family: monospace;
        }
        .function-item:last-child::before { content: "---"; }
        .function-item.enabled { color: var(--text-primary); }
        .function-item.disabled { color: var(--ngm-text-muted); text-decoration: line-through; }

        /* Agent Config */
        .agent-config-list { display: flex; flex-direction: column; gap: 0; }

        .agent-config-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .agent-config-item:last-child { border-bottom: none; }

        .agent-config-info { flex: 1; min-width: 0; padding-right: 24px; }
        .agent-config-name { font-size: 13px; font-weight: 500; color: var(--text-primary); display: block; }
        .agent-config-desc { font-size: 12px; color: var(--ngm-text-muted); margin-top: 2px; display: block; }
        .agent-config-control { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }

        /* Confidence Slider */
        .confidence-slider {
            -webkit-appearance: none; appearance: none;
            width: 120px; height: 6px; border-radius: 3px;
            background: var(--border-strong); outline: none;
        }
        .confidence-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--accent); cursor: pointer;
        }
        .confidence-slider::-moz-range-thumb {
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--accent); cursor: pointer; border: none;
        }
        .confidence-value {
            font-size: 14px; font-weight: 600; color: var(--accent);
            min-width: 40px; text-align: right;
        }

        /* Recipient Picker */
        .recipient-picker { position: relative; }
        .recipient-picker-input {
            display: flex; flex-wrap: wrap; gap: 6px; min-height: 42px;
            padding: 8px 12px;
            background: var(--bg-input); border: 1px solid var(--border-soft);
            border-radius: var(--radius-sm); cursor: text; align-items: center;
            transition: border-color 0.15s ease;
        }
        .recipient-picker-input:focus-within { border-color: var(--accent); }
        .recipient-picker-input .search-field {
            border: none; background: transparent; color: var(--text-primary);
            font-size: 13px; outline: none; flex: 1; min-width: 120px;
        }
        .recipient-picker-input .search-field::placeholder { color: var(--ngm-text-muted); }

        .recipient-chip {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 10px; border-radius: 16px; font-size: 12px;
            font-weight: 500; white-space: nowrap; max-width: 200px;
        }
        .recipient-chip.role-chip {
            background: rgba(139,92,246,0.15); color: #a78bfa;
            border: 1px solid rgba(139,92,246,0.25);
        }
        .recipient-chip.user-chip {
            background: rgba(59,130,246,0.1); color: #93c5fd;
            border: 1px solid rgba(59,130,246,0.2);
        }
        .recipient-chip .chip-remove {
            cursor: pointer; font-size: 14px; line-height: 1;
            opacity: 0.7; transition: opacity 0.15s ease;
        }
        .recipient-chip .chip-remove:hover { opacity: 1; }
        .chip-avatar {
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 600; color: white; flex-shrink: 0;
        }

        .recipient-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-sm); margin-top: 4px; max-height: 280px;
            overflow-y: auto; z-index: 100; display: none;
            box-shadow: var(--ngm-shadow-strong);
        }
        .recipient-dropdown.is-open { display: block; }
        .recipient-dropdown-group-label {
            font-size: 11px; font-weight: 600; color: var(--ngm-text-muted);
            text-transform: uppercase; letter-spacing: 0.05em;
            padding: 10px 12px 4px; user-select: none;
        }
        .recipient-dropdown-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; cursor: pointer;
            transition: background 0.15s ease;
            font-size: 13px; color: var(--text-primary);
        }
        .recipient-dropdown-item:hover { background: rgba(255,255,255,0.04); }
        .recipient-dropdown-item.is-selected { background: rgba(62,207,142,0.06); }
        .recipient-dropdown-item .item-check {
            width: 16px; height: 16px; border: 1px solid var(--border-strong);
            border-radius: 3px; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0; font-size: 10px;
            transition: all 0.15s ease;
        }
        .recipient-dropdown-item.is-selected .item-check {
            background: var(--accent); border-color: var(--accent); color: white;
        }
        .recipient-dropdown-empty {
            padding: 16px; text-align: center; color: var(--ngm-text-muted); font-size: 13px;
        }

        /* Analytics / Charts */
        .analytics-section {
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-md);
            padding: 24px;
        }

        .section-header { margin-bottom: 20px; }

        .chart-content { display: flex; flex-direction: column; gap: 8px; }
        .chart-bar { display: flex; align-items: center; gap: 12px; }

        .chart-bar-label {
            font-size: 12px; color: var(--text-secondary); min-width: 120px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .chart-bar-fill {
            flex: 1; height: 24px;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
            border-radius: 4px; position: relative;
            transition: width 0.5s ease;
        }

        .chart-bar-value {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            font-size: 11px; font-weight: 600; color: white;
        }

        /* Two column layout */
        .two-col-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 16px; margin-bottom: 24px;
        }

        @media (max-width: 1200px) {
            .two-col-grid { grid-template-columns: 1fr; }
        }

        /* Chart Card */
        .chart-card {
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-md);
            padding: 20px;
        }

        .chart-title {
            font-size: 13px; font-weight: 500; color: var(--text-primary);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin: 0 0 16px 0;
        }

        /* Failed Commands Table */
        .failed-commands-table { border-radius: var(--radius-sm); overflow: hidden; }

        .failed-commands-table table {
            width: 100%; border-collapse: collapse;
            background: var(--bg-main); border: 1px solid var(--border-soft);
        }

        .failed-commands-table th {
            background: var(--ngm-bg-surface); padding: 12px 16px; text-align: left;
            font-size: 11px; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-soft);
        }

        .failed-commands-table td {
            padding: 12px 16px; font-size: 13px; color: var(--text-primary);
            border-bottom: 1px solid var(--border-soft);
        }

        .failed-commands-table tbody tr:hover {
            background: rgba(255,255,255,0.02); cursor: pointer;
        }
        .failed-commands-table tbody tr:last-child td { border-bottom: none; }

        /* Access Denied */
        .access-denied-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .access-denied-icon {
            width: 80px; height: 80px; background: rgba(239,68,68,0.15);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 24px; font-size: 40px; color: #ef4444;
        }
        .access-denied-title { font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .access-denied-message {
            font-size: 13px; color: var(--ngm-text-muted); margin-bottom: 24px;
            text-align: center; max-width: 400px;
        }
        .access-denied-btn {
            padding: 8px 20px; background: var(--accent); color: white; border: none;
            border-radius: var(--radius-sm); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: background 0.15s ease;
        }
        .access-denied-btn:hover { background: var(--accent-hover); }

        /* Loading / Empty */
        .loading-spinner {
            display: flex; align-items: center; justify-content: center;
            padding: 40px; color: var(--ngm-text-muted); font-size: 13px;
        }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--ngm-text-muted); }
        .empty-state-text { font-size: 13px; color: var(--text-secondary); }

        /* Arturito settings grid */
        .arturito-settings-grid { display: grid; gap: 16px; }

        /* Section reset btn */
        .config-section-actions {
            margin-top: 20px; display: flex; justify-content: flex-end;
        }

        /* Page loading overlay */
        body.page-loading { overflow: hidden; }
        .page-loading-overlay { position: fixed; inset: 0; background: #0d0d0d; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; gap: 16px; }
        .page-loading-overlay.hidden { display: none; }
        .page-loading .app-layout { visibility: hidden; }
        .loading-logo { width: 120px; height: 120px; object-fit: contain; animation: pulse 1.5s ease-in-out infinite; }
        .loading-text { color: rgba(255,255,255,0.5); font-size: 13px; font-family: system-ui, sans-serif; letter-spacing: 0.05em; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }

        /* OCR Metrics Widget */
        .ocr-metrics-widget {
            margin-top: 28px;
            background: var(--ngm-bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-md);
            padding: 20px 24px;
        }
        .ocr-metrics-widget h3 {
            font-size: 13px; font-weight: 600;
            color: var(--text-primary); margin: 0 0 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .ocr-metrics-widget h3 .ocr-subtitle {
            font-weight: 400; color: var(--ngm-text-muted); font-size: 12px;
        }
        .ocr-metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 16px;
        }
        .ocr-stat {
            text-align: center; padding: 12px 8px;
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-soft);
        }
        .ocr-stat-value {
            font-size: 22px; font-weight: 700;
            color: var(--text-primary); display: block;
        }
        .ocr-stat-value.ocr-pdfplumber { color: var(--accent); }
        .ocr-stat-value.ocr-vision { color: #f59e0b; }
        .ocr-stat-value.ocr-error { color: #ef4444; }
        .ocr-stat-label {
            font-size: 11px; color: var(--ngm-text-muted);
            display: block; margin-top: 4px;
        }
        .ocr-bar-row {
            margin-top: 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .ocr-bar-track {
            flex: 1; height: 8px;
            background: rgba(255,255,255,0.06);
            border-radius: 4px; overflow: hidden;
            display: flex;
        }
        .ocr-bar-seg {
            height: 100%; transition: width 0.4s ease;
        }
        .ocr-bar-seg.seg-pdf { background: var(--accent); }
        .ocr-bar-seg.seg-vision { background: #f59e0b; }
        .ocr-bar-seg.seg-error { background: #ef4444; }
        .ocr-bar-legend {
            display: flex; gap: 14px; flex-shrink: 0;
        }
        .ocr-legend-item {
            display: flex; align-items: center; gap: 5px;
            font-size: 11px; color: var(--ngm-text-muted);
        }
        .ocr-legend-dot {
            width: 8px; height: 8px; border-radius: 50%;
        }
        .ocr-agent-breakdown {
            margin-top: 14px; display: flex; gap: 16px; flex-wrap: wrap;
        }
        .ocr-agent-chip {
            font-size: 12px; color: var(--text-secondary);
            padding: 4px 10px; border-radius: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-soft);
        }
        .ocr-agent-chip strong { color: var(--text-primary); font-weight: 600; }

        /* Responsive */
        @media (max-width: 1024px) {
            .hub-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .hub-grid { grid-template-columns: 1fr; }
            .hub-card-metrics { gap: 8px; }
            .hub-metric-value { font-size: 14px; }
        }
        @media (max-width: 768px) {
            .stats-row { grid-template-columns: 1fr; }
            .chart-bar-label { min-width: 80px; font-size: 11px; }
            .failed-commands-table th,
            .failed-commands-table td { padding: 8px 12px; font-size: 12px; }
        }

        /* ====== View Transitions ====== */
        #hubView, #detailView {
            animation-duration: 0.2s;
            animation-fill-mode: both;
            animation-timing-function: ease-out;
        }
        .view-entering { animation-name: viewFadeIn; }
        .view-leaving  { animation-name: viewFadeOut; pointer-events: none; }

        @keyframes viewFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes viewFadeOut {
            from { opacity: 1; transform: translateY(0); }
            to   { opacity: 0; transform: translateY(-8px); }
        }

        /* ====== Skeleton Loaders ====== */
        .skeleton {
            background: linear-gradient(90deg,
                var(--ngm-bg-surface) 25%,
                rgba(255,255,255,0.06) 37%,
                var(--ngm-bg-surface) 63%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
            color: transparent !important;
            pointer-events: none;
            user-select: none;
        }
        .skeleton-stat { display: inline-block; min-width: 40px; }

        @keyframes shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ====== CSS Containment (performance) ====== */
        #settingsContent { contain: layout style; }
        #hubView, #detailView { contain: content; }
        .hub-card { contain: content; }
        .permission-card { contain: content; }
        .stat-card { contain: layout style; }
        .ocr-metrics-widget { contain: content; }

        /* ====== Reusable Component Classes (replace inline styles) ====== */
        .daneel-project-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; background: var(--ngm-bg-input);
            border: 1px solid var(--ngm-border); border-radius: 8px;
        }
        .daneel-project-row + .daneel-project-row { margin-top: 8px; }
        .daneel-project-name {
            font-size: 13px; font-weight: 500; color: var(--ngm-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .daneel-project-stats {
            display: flex; gap: 12px; margin-top: 4px;
            font-size: 11px; color: var(--ngm-text-muted);
        }

        .daneel-report-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: var(--ngm-bg-input);
            border: 1px solid var(--ngm-border); border-radius: 8px;
            cursor: pointer; transition: border-color 0.15s ease;
        }
        .daneel-report-row:hover { border-color: var(--border-strong); }
        .daneel-report-row + .daneel-report-row { margin-top: 6px; }

        .daneel-report-detail {
            padding: 10px 12px; background: var(--bg-main);
            border: 1px solid var(--ngm-border); border-top: none;
            border-radius: 0 0 8px 8px; margin-top: -6px; font-size: 11px;
        }

        .daneel-run-btn {
            padding: 4px 12px; background: hsl(217 70% 50%); color: #fff;
            border: none; border-radius: 6px; font-size: 11px;
            cursor: pointer; white-space: nowrap; margin-left: 12px;
        }
        .daneel-run-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .daneel-badge {
            padding: 1px 6px; border-radius: 4px; font-size: 10px;
            color: #fff; margin-right: 4px; display: inline-block;
        }
        .daneel-badge-auth { background: #10b981; }
        .daneel-badge-missing { background: #f59e0b; }
        .daneel-badge-dup { background: #8b5cf6; }
        .daneel-badge-esc { background: #ef4444; }

        .empty-state-msg {
            text-align: center; padding: 24px;
            color: var(--ngm-text-muted); font-size: 12px;
        }
    </style>
    <script src="assets/js/page-loading.js" defer></script>
</head>
<body class="page-settings page-loading">
    <!-- Page Loading Overlay -->
    <div class="page-loading-overlay" id="pageLoadingOverlay">
        <img src="assets/img/white_icon.png" class="loading-logo" alt="Loading...">
        <span class="loading-text">Loading...</span>
    </div>

    <!-- Access Denied Overlay -->
    <div class="access-denied-overlay" id="accessDeniedOverlay" style="display: none;">
        <div class="access-denied-icon">X</div>
        <h2 class="access-denied-title">Access Restricted</h2>
        <p class="access-denied-message">
            This page is only available to CEO and COO roles. If you believe you should have access, please contact your administrator.
        </p>
        <button type="button" class="access-denied-btn" onclick="window.location.href='dashboard.html'">
            Go to Dashboard
        </button>
    </div>

    <div class="app-layout" id="mainContent" style="display: none;">
        <aside class="sidebar" id="sidebar"></aside>

        <div class="main-area">
            <header class="ngm-topbar">
                <div class="ngm-bar-left">
                    <div class="ngm-brand">
                        <div class="ngm-brand-icon-small"><img src="assets/img/white_icon.png" alt="NGM"></div>
                        <div class="ngm-brand-text">
                            <span class="ngm-brand-org">Next Generation Management</span>
                            <span class="ngm-brand-context">NGM Hub -- Agent Hub</span>
                        </div>
                    </div>
                </div>
                <div class="ngm-topbar-right">
                    <div class="ngm-meta">
                        <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment -- ---</span>
                        <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server -- ---</span>
                    </div>
                    <form class="ngm-search" role="search" onsubmit="return false;">
                        <span class="ngm-global-search-icon">?</span>
                        <input type="search" class="ngm-search-input" placeholder="Search..." />
                    </form>
                    <span id="user-pill" class="user-pill">User -- ---</span>
                </div>
            </header>

            <main class="main-content">
                <div class="workspace">
                    <section class="data-section">
                        <div class="expenses-table-container">
                            <div id="loadingState" class="expenses-loading-state">
                                <img src="assets/img/white_icon.png" class="loading-logo loading-logo-lg" alt="Loading...">
                                <span class="loading-text">Loading agents...</span>
                            </div>

                            <div id="settingsContent" style="display: none; padding: 24px;">

                                <!-- ==================== HUB VIEW ==================== -->
                                <div id="hubView">
                                    <div class="hub-header">
                                        <h2>Agent Hub</h2>
                                        <p>Monitor, configure, and review AI agent performance</p>
                                    </div>

                                    <div class="hub-grid">
                                        <!-- Arturito Card -->
                                        <div class="hub-card" data-agent="arturito" onclick="AgentHub.showDetail('arturito')">
                                            <div class="hub-card-top">
                                                <div class="agent-avatar" style="background: hsl(262 70% 55%)">A</div>
                                                <div class="hub-card-identity">
                                                    <h3 class="hub-card-name">Arturito</h3>
                                                    <p class="hub-card-role">AI Assistant</p>
                                                </div>
                                                <span class="hub-status-dot hub-status-active" id="hubDotArturito"></span>
                                            </div>
                                            <div class="hub-card-metrics">
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubArturitoPermissions">&nbsp;</span>
                                                    <span class="hub-metric-label">Permissions</span>
                                                </div>
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubArturitoGptRate">&nbsp;</span>
                                                    <span class="hub-metric-label">GPT Fallback</span>
                                                </div>
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubArturitoFailures">&nbsp;</span>
                                                    <span class="hub-metric-label">Failures</span>
                                                </div>
                                            </div>
                                            <div class="hub-card-footer">
                                                <span class="hub-card-cta">View details &rarr;</span>
                                            </div>
                                        </div>

                                        <!-- Andrew Card -->
                                        <div class="hub-card" data-agent="andrew" onclick="AgentHub.showDetail('andrew')">
                                            <div class="hub-card-top">
                                                <div class="agent-avatar" style="background: hsl(35 70% 45%)">An</div>
                                                <div class="hub-card-identity">
                                                    <h3 class="hub-card-name">Andrew</h3>
                                                    <p class="hub-card-role">Receipt Processing</p>
                                                </div>
                                                <span class="hub-status-dot hub-status-active" id="hubDotAndrew"></span>
                                            </div>
                                            <div class="hub-card-metrics">
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubAndrewProcessed">&nbsp;</span>
                                                    <span class="hub-metric-label">Processed</span>
                                                </div>
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubAndrewSuccessRate">&nbsp;</span>
                                                    <span class="hub-metric-label">Success</span>
                                                </div>
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubAndrewErrors">&nbsp;</span>
                                                    <span class="hub-metric-label">Errors</span>
                                                </div>
                                            </div>
                                            <div class="hub-card-footer">
                                                <span class="hub-card-cta">View details &rarr;</span>
                                            </div>
                                        </div>

                                        <!-- Daneel Card -->
                                        <div class="hub-card" data-agent="daneel" onclick="AgentHub.showDetail('daneel')">
                                            <div class="hub-card-top">
                                                <div class="agent-avatar" style="background: hsl(217 70% 50%)">D</div>
                                                <div class="hub-card-identity">
                                                    <h3 class="hub-card-name">Daneel</h3>
                                                    <p class="hub-card-role">Budget Monitor</p>
                                                </div>
                                                <span class="hub-status-dot hub-status-active" id="hubDotDaneel"></span>
                                            </div>
                                            <div class="hub-card-metrics">
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubDaneelStatus">&nbsp;</span>
                                                    <span class="hub-metric-label">Status</span>
                                                </div>
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubDaneelAutoAuth">&nbsp;</span>
                                                    <span class="hub-metric-label">Authorized</span>
                                                </div>
                                                <div class="hub-metric">
                                                    <span class="hub-metric-value skeleton skeleton-stat" id="hubDaneelAlerts">&nbsp;</span>
                                                    <span class="hub-metric-label">Pending Info</span>
                                                </div>
                                            </div>
                                            <div class="hub-card-footer">
                                                <span class="hub-card-cta">View details &rarr;</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- OCR Metrics Widget -->
                                    <div class="ocr-metrics-widget" id="ocrMetricsWidget">
                                        <h3>
                                            OCR Extraction Metrics
                                            <span class="ocr-subtitle" id="ocrMetricsPeriod">Last 30 days</span>
                                        </h3>
                                        <div class="ocr-metrics-row">
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value" id="ocrTotalScans">--</span>
                                                <span class="ocr-stat-label">Total Scans</span>
                                            </div>
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value ocr-pdfplumber" id="ocrPdfplumber">--</span>
                                                <span class="ocr-stat-label">pdfplumber</span>
                                            </div>
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value ocr-vision" id="ocrVision">--</span>
                                                <span class="ocr-stat-label">Vision API</span>
                                            </div>
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value ocr-error" id="ocrErrors">--</span>
                                                <span class="ocr-stat-label">Errors</span>
                                            </div>
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value" id="ocrAvgConfidence">--</span>
                                                <span class="ocr-stat-label">Avg Confidence</span>
                                            </div>
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value" id="ocrSuccessRate">--</span>
                                                <span class="ocr-stat-label">Success Rate</span>
                                            </div>
                                            <div class="ocr-stat">
                                                <span class="ocr-stat-value" id="ocrTaxDetected" style="color: #8b5cf6;">--</span>
                                                <span class="ocr-stat-label">Tax Detected</span>
                                            </div>
                                        </div>
                                        <!-- Match type breakdown -->
                                        <div class="ocr-agent-breakdown" id="ocrMatchBreakdown" style="margin-top: 10px;"></div>
                                        <div class="ocr-bar-row">
                                            <div class="ocr-bar-track">
                                                <div class="ocr-bar-seg seg-pdf" id="ocrBarPdf" style="width: 0%"></div>
                                                <div class="ocr-bar-seg seg-vision" id="ocrBarVision" style="width: 0%"></div>
                                                <div class="ocr-bar-seg seg-error" id="ocrBarError" style="width: 0%"></div>
                                            </div>
                                            <div class="ocr-bar-legend">
                                                <span class="ocr-legend-item"><span class="ocr-legend-dot" style="background:var(--accent)"></span> pdfplumber</span>
                                                <span class="ocr-legend-item"><span class="ocr-legend-dot" style="background:#f59e0b"></span> Vision</span>
                                                <span class="ocr-legend-item"><span class="ocr-legend-dot" style="background:#ef4444"></span> Error</span>
                                            </div>
                                        </div>
                                        <div class="ocr-agent-breakdown" id="ocrAgentBreakdown"></div>
                                    </div>
                                </div>

                                <!-- ==================== DETAIL VIEW ==================== -->
                                <div id="detailView" style="display: none;">
                                    <button type="button" id="btnBackToHub" class="detail-back-btn">
                                        &larr; Back to Agent Hub
                                    </button>

                                    <div id="detailHeader" class="detail-header"></div>
                                    <div id="detailTabs" class="detail-tabs"></div>

                                    <div id="detailContent">
                                        <!-- ====== Arturito Panels ====== -->
                                        <div id="arturito-overview" class="detail-tab-panel">
                                            <div class="stats-row">
                                                <div class="stat-card">
                                                    <span class="stat-label">Total Permissions</span>
                                                    <span class="stat-value" id="arturitoStatTotal">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Enabled</span>
                                                    <span class="stat-value enabled" id="arturitoStatEnabled">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Disabled</span>
                                                    <span class="stat-value disabled" id="arturitoStatDisabled">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">High Risk Enabled</span>
                                                    <span class="stat-value" id="arturitoStatHighRisk">-</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="arturito-scope" class="detail-tab-panel">
                                            <div class="permission-card">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Capabilities</h3>
                                                </div>
                                                <div class="module-tree">
                                                    <div class="module-group">
                                                        <div class="module-name"><span>1</span> Chat Assistant</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Natural language command routing from any page</div>
                                                            <div class="function-item enabled">Context-aware responses based on current module</div>
                                                            <div class="function-item enabled">GPT fallback for unrecognized commands</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>2</span> CRUD Operations</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Read data across all modules (expenses, pipeline, projects)</div>
                                                            <div class="function-item enabled">Create new records (expenses, tasks, budgets)</div>
                                                            <div class="function-item enabled">Update existing entries and fields</div>
                                                            <div class="function-item enabled">Delete records with confirmation</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>3</span> Navigation & Notifications</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Navigate between pages and modules</div>
                                                            <div class="function-item enabled">Send push notifications to team members</div>
                                                            <div class="function-item enabled">Open modals and forms contextually</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="arturito-config" class="detail-tab-panel">
                                            <div class="arturito-settings-grid" id="permissionsContainer">
                                                <!-- Permissions cards rendered by JS -->
                                            </div>
                                            <div class="config-section-actions">
                                                <button type="button" class="btn-toolbar btn-toolbar-secondary" id="btnResetDefaults">Reset to Defaults</button>
                                            </div>
                                        </div>

                                        <div id="arturito-failures" class="detail-tab-panel">
                                            <div class="analytics-section">
                                                <div class="section-header">
                                                    <h3 style="font-size: 13px; font-weight: 500; color: var(--text-primary); margin: 0 0 4px 0;">
                                                        Command Analytics
                                                    </h3>
                                                    <p style="font-size: 11px; color: var(--ngm-text-muted); margin: 0;">
                                                        Track failed copilot commands to improve recognition over time
                                                    </p>
                                                </div>

                                                <div class="stats-row" style="margin-top: 20px;">
                                                    <div class="stat-card">
                                                        <span class="stat-label">Total Failures (30d)</span>
                                                        <span class="stat-value" id="analyticsTotal">-</span>
                                                    </div>
                                                    <div class="stat-card">
                                                        <span class="stat-label">Unique Commands</span>
                                                        <span class="stat-value" id="analyticsUnique">-</span>
                                                    </div>
                                                    <div class="stat-card">
                                                        <span class="stat-label">GPT Fallback Rate</span>
                                                        <span class="stat-value" id="analyticsGptRate">-</span>
                                                    </div>
                                                </div>

                                                <div class="two-col-grid" style="margin-top: 20px;">
                                                    <div class="chart-card">
                                                        <h4 class="chart-title">Top Pages with Failures</h4>
                                                        <div id="topPagesChart" class="chart-content"></div>
                                                    </div>
                                                    <div class="chart-card">
                                                        <h4 class="chart-title">Most Common Error Reasons</h4>
                                                        <div id="topErrorsChart" class="chart-content"></div>
                                                    </div>
                                                </div>

                                                <div class="commands-table-section" style="margin-top: 20px;">
                                                    <h4 style="font-size: 13px; font-weight: 500; color: var(--text-primary); margin: 0 0 12px 0;">
                                                        Most Frequently Failed Commands
                                                    </h4>
                                                    <div class="failed-commands-table">
                                                        <table id="failedCommandsTable" style="width: 100%;">
                                                            <thead>
                                                                <tr>
                                                                    <th>Command</th>
                                                                    <th>Page</th>
                                                                    <th>Failures</th>
                                                                    <th>Last Seen</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="failedCommandsBody"></tbody>
                                                        </table>
                                                    </div>
                                                </div>

                                                <div style="margin-top: 20px; text-align: right;">
                                                    <button type="button" class="btn-toolbar btn-toolbar-secondary" id="btnRefreshAnalytics">
                                                        Refresh Analytics
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ====== Andrew Panels ====== -->
                                        <div id="andrew-overview" class="detail-tab-panel">
                                            <div class="stats-row">
                                                <div class="stat-card">
                                                    <span class="stat-label">Total Processed</span>
                                                    <span class="stat-value" id="agentStatTotal">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Expenses Created</span>
                                                    <span class="stat-value enabled" id="agentStatLinked">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Success Rate</span>
                                                    <span class="stat-value" id="agentStatSuccessRate">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Avg Confidence</span>
                                                    <span class="stat-value" id="agentStatConfidence">-</span>
                                                </div>
                                            </div>
                                            <div class="stats-row">
                                                <div class="stat-card">
                                                    <span class="stat-label">Pending Review</span>
                                                    <span class="stat-value" id="agentStatPending">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Errors</span>
                                                    <span class="stat-value disabled" id="agentStatErrors">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Duplicates Caught</span>
                                                    <span class="stat-value" id="agentStatDuplicates">-</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="andrew-scope" class="detail-tab-panel">
                                            <div class="permission-card">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Scope of Work</h3>
                                                </div>
                                                <div class="module-tree">
                                                    <div class="module-group">
                                                        <div class="module-name"><span>1</span> Receipt Upload & Storage</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Receives receipt images and PDFs from project channels</div>
                                                            <div class="function-item enabled">Stores files in the pending-expenses storage bucket</div>
                                                            <div class="function-item enabled">Computes file hash for duplicate tracking</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>2</span> OCR Extraction</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Analyzes receipt images using OpenAI Vision</div>
                                                            <div class="function-item enabled">Extracts vendor name, amount, and date</div>
                                                            <div class="function-item enabled">Supports image and PDF file formats</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>3</span> Duplicate Detection</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Checks file hash against existing receipts (exact match)</div>
                                                            <div class="function-item enabled">Checks data duplicates by vendor + amount + date</div>
                                                            <div class="function-item enabled">Prompts user for confirmation when duplicate found</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>4</span> Auto-Categorization</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Categorizes expenses using GPT with construction stage context</div>
                                                            <div class="function-item enabled">Detects multi-category receipts and suggests splits</div>
                                                            <div class="function-item enabled">Returns confidence score for each categorization</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>5</span> Check Detection</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Identifies check images via filename heuristics</div>
                                                            <div class="function-item enabled">Routes checks through a separate review flow</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>6</span> Expense Creation</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Auto-creates expense entries from approved receipts</div>
                                                            <div class="function-item enabled">Supports single and split expense creation</div>
                                                            <div class="function-item enabled">Links receipts to existing expenses when matched</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>7</span> Status Reporting</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Posts summary messages to project Receipts channel</div>
                                                            <div class="function-item enabled">Notifies on duplicates, errors, and successful processing</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>8</span> Bill Mismatch Reconciliation</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Triggered by Daneel when bill total mismatches expense sum</div>
                                                            <div class="function-item enabled">Re-scans receipt via Vision OCR to extract line items</div>
                                                            <div class="function-item enabled">Matches OCR line items against DB expenses one-by-one</div>
                                                            <div class="function-item enabled">Identifies amount mismatches, missing items, and extra entries</div>
                                                            <div class="function-item enabled">Can auto-correct amounts when confidence is high (configurable)</div>
                                                            <div class="function-item enabled">Posts detailed reconciliation report to project chat</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>9</span> Smart Conversation Layer</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Analyzes missing info and tries to auto-resolve (bill hints, similar expenses, vendor DB)</div>
                                                            <div class="function-item enabled">Crafts conversational messages with Andrew's personality (dry wit, competent)</div>
                                                            <div class="function-item enabled">Interprets natural language replies from humans (GPT-powered)</div>
                                                            <div class="function-item enabled">Proactively asks specific questions about missing vendor, date, or amount</div>
                                                            <div class="function-item enabled">Follows up on unanswered questions (24h reminder, 48h escalation, 72h stale)</div>
                                                            <div class="function-item enabled">Auto-links orphan expenses to matching bills (vendor + amount + date)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="andrew-config" class="detail-tab-panel">
                                            <div class="permission-card">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Agent Configuration</h3>
                                                </div>
                                                <div class="agent-config-list">
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Auto-create expenses</span>
                                                            <span class="agent-config-desc">Automatically create expense records after scanning receipts</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="cfgAutoCreate" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Enforce confidence threshold</span>
                                                            <span class="agent-config-desc">Ask for confirmation when categorization confidence is below threshold (only for bulk processing)</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="cfgEnforceThreshold">
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item" id="cfgMinConfidenceContainer">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Minimum confidence threshold</span>
                                                            <span class="agent-config-desc">Confidence level required for automatic categorization</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <input type="range" id="cfgMinConfidence" min="50" max="95" step="5" value="70" class="confidence-slider">
                                                            <span class="confidence-value" id="cfgMinConfidenceValue">70%</span>
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Auto-skip exact duplicates</span>
                                                            <span class="agent-config-desc">Automatically reject receipts with matching file hash (no confirmation prompt)</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="cfgAutoSkipDuplicates">
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ngm-border);">
                                                    <h6 style="font-size: 13px; font-weight: 600; color: var(--ngm-text); margin-bottom: 12px;">Bill Mismatch Reconciliation</h6>
                                                    <div class="agent-config-list">
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Enable reconciliation protocol</span>
                                                                <span class="agent-config-desc">When Daneel detects a bill mismatch, Andrew re-scans and reconciles line items</span>
                                                            </div>
                                                            <div class="agent-config-control">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox" id="andrewMismatchEnabled" role="switch" checked>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Auto-correct amounts</span>
                                                                <span class="agent-config-desc">Automatically fix expense amounts when OCR confidence is above threshold</span>
                                                            </div>
                                                            <div class="agent-config-control">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox" id="andrewMismatchAutoCorrect" role="switch">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Auto-correct confidence threshold</span>
                                                                <span class="agent-config-desc">Minimum OCR confidence required to auto-correct amounts</span>
                                                            </div>
                                                            <div class="agent-config-control" style="display: flex; align-items: center; gap: 8px;">
                                                                <input type="range" id="andrewMismatchConfidence" min="60" max="95" step="5" value="85" class="confidence-slider">
                                                                <span class="confidence-value" id="andrewMismatchConfidenceValue">85%</span>
                                                            </div>
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Amount match tolerance</span>
                                                                <span class="agent-config-desc">Amounts within this % are considered matching (e.g., 0.02 = 2%)</span>
                                                            </div>
                                                            <div class="agent-config-control">
                                                                <input type="number" id="andrewMismatchTolerance" value="0.02" min="0.005" max="0.10" step="0.005"
                                                                       style="width: 80px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 4px; background: var(--ngm-bg-input); color: var(--ngm-text); font-size: 13px;">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="margin-top: 12px; text-align: right;">
                                                        <button type="button" onclick="AgentHub.saveAndrewMismatchConfig()"
                                                                style="background: hsl(217 70% 50%); color: #fff; border: none; padding: 6px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;">
                                                            Save Mismatch Settings
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Smart Conversation Layer -->
                                                <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--ngm-border);">
                                                    <h6 style="font-size: 13px; font-weight: 600; color: var(--ngm-text); margin-bottom: 12px;">Smart Conversation Layer</h6>
                                                    <div class="agent-config-list">
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Smart layer enabled</span>
                                                                <span class="agent-config-desc">AI personality + proactive info resolution on receipt messages</span>
                                                            </div>
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" id="andrewSmartLayerEnabled" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Follow-up reminder (hours)</span>
                                                                <span class="agent-config-desc">Hours before Andrew sends a follow-up for unanswered questions</span>
                                                            </div>
                                                            <input type="number" id="andrewFollowupHours" value="24" min="6" max="72" step="6"
                                                                   style="width: 70px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 6px; font-size: 13px; text-align: center; background: var(--ngm-bg); color: var(--ngm-text);">
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Escalation (hours)</span>
                                                                <span class="agent-config-desc">Hours before escalating to bookkeeping if no response</span>
                                                            </div>
                                                            <input type="number" id="andrewEscalationHours" value="48" min="12" max="168" step="6"
                                                                   style="width: 70px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 6px; font-size: 13px; text-align: center; background: var(--ngm-bg); color: var(--ngm-text);">
                                                        </div>
                                                    </div>
                                                    <div style="margin-top: 12px; text-align: right;">
                                                        <button type="button" onclick="AgentHub.saveAndrewSmartConfig()"
                                                                style="background: hsl(217 70% 50%); color: #fff; border: none; padding: 6px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;">
                                                            Save Smart Layer Settings
                                                        </button>
                                                        <button type="button" onclick="AgentHub.runAndrewFollowupCheck()"
                                                                style="background: hsl(35 80% 50%); color: #fff; border: none; padding: 6px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; margin-left: 8px;">
                                                            Run Follow-Up Check
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Authorization Notification -->
                                                <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--ngm-border);">
                                                    <h6 style="font-size: 13px; font-weight: 600; color: var(--ngm-text); margin-bottom: 4px;">Authorization Notification</h6>
                                                    <p style="font-size: 12px; color: var(--ngm-text-muted); margin: 0 0 12px 0;">
                                                        Who gets @mentioned when Andrew creates expenses. Daneel will auto-authorize if enabled.
                                                    </p>
                                                    <div class="recipient-picker" id="andrewAuthNotifyPicker">
                                                        <div class="recipient-picker-input" id="andrewAuthNotifyPickerInput">
                                                            <input type="text" class="search-field" id="andrewAuthNotifySearch"
                                                                   placeholder="Search users or agents..." autocomplete="off">
                                                        </div>
                                                        <div class="recipient-dropdown" id="andrewAuthNotifyDropdown"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="andrew-failures" class="detail-tab-panel">
                                            <div class="stats-row">
                                                <div class="stat-card">
                                                    <span class="stat-label">Processing Errors</span>
                                                    <span class="stat-value disabled" id="andrewFailureErrors">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Duplicates Caught</span>
                                                    <span class="stat-value" id="andrewFailureDuplicates">-</span>
                                                </div>
                                            </div>
                                            <div class="empty-state" id="andrewFailuresEmpty">
                                                <p class="empty-state-text">Detailed failure logs will appear here as they are tracked.</p>
                                            </div>
                                        </div>

                                        <!-- ====== Daneel Panels ====== -->
                                        <div id="daneel-overview" class="detail-tab-panel">
                                            <div class="stats-row">
                                                <div class="stat-card">
                                                    <span class="stat-label">Agent Status</span>
                                                    <span class="stat-value" id="daneelStatStatus">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Warning Threshold</span>
                                                    <span class="stat-value" id="daneelStatWarn">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Critical Threshold</span>
                                                    <span class="stat-value" id="daneelStatCrit">-</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Last Run</span>
                                                    <span class="stat-value" id="daneelStatLastRun">--</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Auto-Auth</span>
                                                    <span class="stat-value" id="daneelStatAutoAuth">--</span>
                                                </div>
                                                <div class="stat-card">
                                                    <span class="stat-label">Pending Info</span>
                                                    <span class="stat-value" id="daneelStatPendingInfo">--</span>
                                                </div>
                                            </div>
                                            <!-- Project Review Section -->
                                            <div style="margin-top: 24px;">
                                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                                    <h6 style="font-size: 14px; font-weight: 600; color: var(--ngm-text); margin: 0;">Expense Review by Project</h6>
                                                    <button id="daneelRefreshProjects" type="button"
                                                            style="padding: 4px 12px; background: var(--ngm-bg-input); border: 1px solid var(--ngm-border); border-radius: 6px; color: var(--ngm-text-muted); font-size: 11px; cursor: pointer;">
                                                        Refresh
                                                    </button>
                                                </div>
                                                <div id="daneelProjectReview" style="display: flex; flex-direction: column; gap: 8px;">
                                                    <div style="text-align: center; padding: 24px; color: var(--ngm-text-muted); font-size: 12px;">Loading projects...</div>
                                                </div>
                                            </div>
                                            <!-- Auth Reports Section -->
                                            <div style="margin-top: 24px;">
                                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                                    <h6 style="font-size: 14px; font-weight: 600; color: var(--ngm-text); margin: 0;">Auth Reports</h6>
                                                    <div style="display: flex; gap: 6px;">
                                                        <button id="daneelClearReports" type="button"
                                                                style="padding: 4px 12px; background: transparent; border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; color: #ef4444; font-size: 11px; cursor: pointer;">
                                                            Clear Logs
                                                        </button>
                                                        <button id="daneelRefreshReports" type="button"
                                                                style="padding: 4px 12px; background: var(--ngm-bg-input); border: 1px solid var(--ngm-border); border-radius: 6px; color: var(--ngm-text-muted); font-size: 11px; cursor: pointer;">
                                                            Refresh
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="daneelAuthReports" style="display: flex; flex-direction: column; gap: 6px;">
                                                    <div style="text-align: center; padding: 24px; color: var(--ngm-text-muted); font-size: 12px;">Loading reports...</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="daneel-scope" class="detail-tab-panel">
                                            <div class="permission-card">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Scope of Work</h3>
                                                </div>
                                                <div class="module-tree">
                                                    <div class="module-group">
                                                        <div class="module-name"><span>1</span> Budget Threshold Monitoring</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Monitors project spending vs allocated budgets</div>
                                                            <div class="function-item enabled">Warning alert at configurable threshold (default 80%)</div>
                                                            <div class="function-item enabled">Critical alert at configurable threshold (default 95%)</div>
                                                            <div class="function-item enabled">Overspend detection when expenses exceed budget</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>2</span> Expense Anomaly Detection</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Identifies unusual spending patterns per category</div>
                                                            <div class="function-item enabled">Flags expenses with no assigned budget</div>
                                                            <div class="function-item enabled">Detects sudden spikes in category spending</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>3</span> Department Mentions</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Mentions relevant roles/users when posting alerts</div>
                                                            <div class="function-item enabled">Configurable recipient list per alert type</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>4</span> Channel Alerts</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Posts messages to project accounting channels</div>
                                                            <div class="function-item enabled">Includes @mentions for configured recipients</div>
                                                            <div class="function-item enabled">Supports warning, critical, and overspend alert types</div>
                                                        </div>
                                                    </div>
                                                    <div class="module-group">
                                                        <div class="module-name"><span>5</span> Expense Auto-Authorization</div>
                                                        <div class="module-functions">
                                                            <div class="function-item enabled">Auto-authorizes expenses that pass health check and duplicate verification</div>
                                                            <div class="function-item enabled">Requests missing information from bookkeeping team</div>
                                                            <div class="function-item enabled">Escalates ambiguous expenses to accounting manager</div>
                                                            <div class="function-item enabled">Batch notifications per project in general channel</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="daneel-config" class="detail-tab-panel">
                                            <div class="permission-card">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Agent Configuration</h3>
                                                </div>
                                                <div class="agent-config-list">
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Enable Daneel</span>
                                                            <span class="agent-config-desc">Master toggle for all budget monitoring and alert posting</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="daneelEnabled" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Warning threshold</span>
                                                            <span class="agent-config-desc">Alert when a category reaches this % of its budget</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <input type="range" id="daneelWarningThreshold" min="50" max="95" step="5" value="80" class="confidence-slider">
                                                            <span class="confidence-value" id="daneelWarningThresholdValue">80%</span>
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Critical threshold</span>
                                                            <span class="agent-config-desc">Escalate to critical alert at this % of budget</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <input type="range" id="daneelCriticalThreshold" min="85" max="100" step="5" value="95" class="confidence-slider">
                                                            <span class="confidence-value" id="daneelCriticalThresholdValue">95%</span>
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Overspend alerts</span>
                                                            <span class="agent-config-desc">Post alert when expenses exceed the allocated budget</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="daneelOverspendAlert" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">No-budget alerts</span>
                                                            <span class="agent-config-desc">Alert when expenses are posted to categories without a budget</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="daneelNoBudgetAlert" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Alert Recipients -->
                                            <div class="permission-card" style="margin-top: 20px;">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Alert Recipients</h3>
                                                    <span style="font-size: 11px; color: var(--ngm-text-muted);" id="daneelRecipientCount">0 selected</span>
                                                </div>
                                                <p style="font-size: 12px; color: var(--ngm-text-muted); margin: 0 0 16px 0;">
                                                    Select roles or individual users who will be @mentioned in Daneel alert messages.
                                                    Selecting a role includes all current users with that role.
                                                </p>
                                                <div class="recipient-picker" id="daneelRecipientPicker">
                                                    <div class="recipient-picker-input" id="daneelPickerInput">
                                                        <input type="text" class="search-field" id="daneelRecipientSearch"
                                                               placeholder="Search roles or users..." autocomplete="off">
                                                    </div>
                                                    <div class="recipient-dropdown" id="daneelRecipientDropdown"></div>
                                                </div>
                                            </div>

                                            <!-- Expense Auto-Authorization -->
                                            <div class="permission-card" style="margin-top: 20px;">
                                                <div class="permission-card-header">
                                                    <h3 class="permission-card-title">Expense Auto-Authorization</h3>
                                                    <span style="font-size: 11px; color: var(--ngm-text-muted);" id="daneelAutoAuthStatusLabel">Disabled</span>
                                                </div>
                                                <p style="font-size: 12px; color: var(--ngm-text-muted); margin: 0 0 16px 0;">
                                                    When enabled, Daneel will automatically authorize new pending expenses that pass health check
                                                    and duplicate verification. Expenses that fail checks are escalated to the appropriate team.
                                                </p>
                                                <div class="agent-config-list">
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Enable Auto-Authorization</span>
                                                            <span class="agent-config-desc">Master switch -- only processes NEW expenses while active</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="daneelAutoAuthEnabled">
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Require bill number</span>
                                                            <span class="agent-config-desc">Expenses without a bill number will not be auto-authorized</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="daneelRequireBill" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Require receipt attachment</span>
                                                            <span class="agent-config-desc">Expenses without an attached receipt will not be auto-authorized</span>
                                                        </div>
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" id="daneelRequireReceipt" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Fuzzy match threshold</span>
                                                            <span class="agent-config-desc">Minimum similarity % for description matching in duplicate detection</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <input type="range" id="daneelFuzzyThreshold" min="70" max="100" step="5" value="85" class="confidence-slider">
                                                            <span class="confidence-value" id="daneelFuzzyThresholdValue">85%</span>
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Amount tolerance ($)</span>
                                                            <span class="agent-config-desc">Max dollar difference to consider two amounts as equal</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <input type="number" id="daneelAmountTolerance" value="0.05" min="0" max="10" step="0.01"
                                                                   style="width: 70px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 6px; background: var(--ngm-bg-input); color: var(--ngm-text); font-size: 13px;">
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Labor keywords</span>
                                                            <span class="agent-config-desc">Keywords in account name to identify labor/payroll (comma separated)</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <input type="text" id="daneelLaborKeywords" value="labor" placeholder="labor, payroll"
                                                                   style="width: 120px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 6px; background: var(--ngm-bg-input); color: var(--ngm-text); font-size: 13px;">
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item" style="flex-direction: column; align-items: flex-start;">
                                                        <div class="agent-config-info" style="margin-bottom: 8px;">
                                                            <span class="agent-config-name">Bookkeeping team</span>
                                                            <span class="agent-config-desc">Users @mentioned when requesting missing expense info</span>
                                                        </div>
                                                        <div class="recipient-picker" id="daneelBookkeepingPicker" style="width: 100%;">
                                                            <div class="recipient-picker-input" id="daneelBookkeepingPickerInput">
                                                                <input type="text" class="search-field" id="daneelBookkeepingSearch"
                                                                       placeholder="Search users..." autocomplete="off">
                                                            </div>
                                                            <div class="recipient-dropdown" id="daneelBookkeepingDropdown"></div>
                                                        </div>
                                                    </div>
                                                    <div class="agent-config-item" style="flex-direction: column; align-items: flex-start;">
                                                        <div class="agent-config-info" style="margin-bottom: 8px;">
                                                            <span class="agent-config-name">Escalation recipients</span>
                                                            <span class="agent-config-desc">Users @mentioned when escalating ambiguous expenses</span>
                                                        </div>
                                                        <div class="recipient-picker" id="daneelEscalationPicker" style="width: 100%;">
                                                            <div class="recipient-picker-input" id="daneelEscalationPickerInput">
                                                                <input type="text" class="search-field" id="daneelEscalationSearch"
                                                                       placeholder="Search users..." autocomplete="off">
                                                            </div>
                                                            <div class="recipient-dropdown" id="daneelEscalationDropdown"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ngm-border);">
                                                    <h6 style="font-size: 13px; font-weight: 600; color: var(--ngm-text); margin-bottom: 12px;">Receipt Hash Check</h6>
                                                    <div class="agent-config-item">
                                                        <div class="agent-config-info">
                                                            <span class="agent-config-name">Cross-bill hash validation</span>
                                                            <span class="agent-config-desc">Detect when the same receipt file is used on different bills within a project (excludes splits)</span>
                                                        </div>
                                                        <div class="agent-config-control">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="daneelReceiptHashCheck" role="switch" checked>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Smart Conversation Layer -->
                                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ngm-border);">
                                                    <h6 style="font-size: 13px; font-weight: 600; color: var(--ngm-text); margin-bottom: 12px;">Smart Conversation Layer</h6>
                                                    <div class="agent-config-list">
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Smart layer enabled</span>
                                                                <span class="agent-config-desc">AI personality + proactive missing-info resolution on expense messages</span>
                                                            </div>
                                                            <div class="agent-config-control">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox" id="daneelSmartLayerEnabled" role="switch" checked>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Follow-up reminder (hours)</span>
                                                                <span class="agent-config-desc">Hours before Daneel sends a follow-up for unanswered missing-info requests</span>
                                                            </div>
                                                            <input type="number" id="daneelFollowupHours" value="24" min="6" max="72" step="6"
                                                                   style="width: 70px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 6px; font-size: 13px; text-align: center; background: var(--ngm-bg); color: var(--ngm-text);">
                                                        </div>
                                                        <div class="agent-config-item">
                                                            <div class="agent-config-info">
                                                                <span class="agent-config-name">Escalation (hours)</span>
                                                                <span class="agent-config-desc">Hours before escalating to accounting manager if no response</span>
                                                            </div>
                                                            <input type="number" id="daneelEscalationHours" value="48" min="12" max="168" step="6"
                                                                   style="width: 70px; padding: 4px 8px; border: 1px solid var(--ngm-border); border-radius: 6px; font-size: 13px; text-align: center; background: var(--ngm-bg); color: var(--ngm-text);">
                                                        </div>
                                                    </div>
                                                    <div style="margin-top: 12px; text-align: right;">
                                                        <button type="button" onclick="AgentHub.runDaneelFollowupCheck()"
                                                                style="background: hsl(35 80% 50%); color: #fff; border: none; padding: 6px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;">
                                                            Run Follow-Up Check
                                                        </button>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ngm-border);">
                                                    <div style="display: flex; align-items: center; gap: 12px;">
                                                        <button id="daneelRunBacklog" type="button"
                                                                style="padding: 8px 16px; background: var(--ngm-bg-input); border: 1px solid var(--ngm-border); border-radius: 6px; color: var(--ngm-text); font-size: 13px; cursor: pointer;">
                                                            Process Backlog
                                                        </button>
                                                        <span style="font-size: 12px; color: var(--ngm-text-muted);" id="daneelBacklogStatus">
                                                            Run once to process all existing pending expenses
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--ngm-border); text-align: right;">
                                                    <span id="daneelAutoAuthSaveStatus" style="font-size: 12px; color: var(--ngm-text-muted); margin-right: 12px;"></span>
                                                    <button id="daneelApplyConfig" type="button"
                                                            style="background: hsl(217 70% 50%); color: #fff; border: none; padding: 8px 24px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;">
                                                        Apply Changes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="daneel-failures" class="detail-tab-panel">
                                            <div class="empty-state">
                                                <p class="empty-state-text">No failure tracking configured for this agent yet.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        var API_BASE = window.API_BASE || "https://ngm-fastapi.onrender.com";
        var ALLOWED_ROLES = ['CEO', 'COO', 'KD COO'];

        var permissionsData = null;
        var currentAgent = null;
        var currentTab = 'overview';
        var _daneelPickerInitialized = false;
        var _andrewPickerInitialized = false;

        // Agent registry
        var AGENTS = {
            arturito: {
                name: 'Arturito',
                role: 'AI Assistant',
                initials: 'A',
                color: 'hsl(262 70% 55%)',
                tabs: ['overview', 'scope', 'config', 'failures']
            },
            andrew: {
                name: 'Andrew',
                role: 'Receipt Processing',
                initials: 'An',
                color: 'hsl(35 70% 45%)',
                tabs: ['overview', 'scope', 'config', 'failures']
            },
            daneel: {
                name: 'Daneel',
                role: 'Budget Monitor',
                initials: 'D',
                color: 'hsl(217 70% 50%)',
                tabs: ['overview', 'scope', 'config', 'failures']
            }
        };

        // Category display names
        var CATEGORY_INFO = {
            read: { name: 'Read Operations', icon: 'R' },
            create: { name: 'Create Operations', icon: '+' },
            update: { name: 'Update Operations', icon: 'E' },
            delete: { name: 'Delete Operations', icon: 'X' },
            notification: { name: 'Notifications', icon: 'N' },
            navigation: { name: 'Navigation & UI', icon: 'G' },
        };

        // ============================================
        // ACCESS CHECK
        // ============================================

        function checkAccess() {
            var userStr = localStorage.getItem('ngmUser');
            if (!userStr) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                var user = JSON.parse(userStr);
                var userRole = user.user_role || user.role || '';
                if (!ALLOWED_ROLES.includes(userRole)) {
                    document.getElementById('accessDeniedOverlay').style.display = 'flex';
                    document.getElementById('mainContent').style.display = 'none';
                    return false;
                }
                document.getElementById('accessDeniedOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = '';
                return true;
            } catch (err) {
                window.location.href = 'login.html';
                return false;
            }
        }

        // ============================================
        // AUTH HEADERS
        // ============================================

        function _agentAuthHeaders() {
            var token = localStorage.getItem('ngmToken');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }

        // ============================================
        // API CACHE (TTL-based in-memory)
        // ============================================

        var _apiCache = {};
        var CACHE_TTL = 60000; // 60 seconds

        function cachedFetch(url, options, ttl) {
            var key = url;
            var now = Date.now();
            var cached = _apiCache[key];

            if (cached && (now - cached.ts) < (ttl || CACHE_TTL)) {
                return Promise.resolve(cached.data);
            }

            return fetch(url, options || {})
                .then(function(resp) {
                    if (!resp.ok) return null;
                    return resp.json();
                })
                .then(function(data) {
                    if (data !== null) {
                        _apiCache[key] = { data: data, ts: now };
                    }
                    return data;
                });
        }

        function invalidateCache(urlFragment) {
            for (var key in _apiCache) {
                if (key.indexOf(urlFragment) >= 0) {
                    delete _apiCache[key];
                }
            }
        }

        // ============================================
        // HELPERS
        // ============================================

        function _removeSkeleton(id, text) {
            var el = document.getElementById(id);
            if (!el) return;
            el.textContent = text;
            el.classList.remove('skeleton', 'skeleton-stat');
        }

        // ============================================
        // VIEW SWITCHING
        // ============================================

        var _viewTransitioning = false;

        function _animateViewSwitch(outId, inId, onAfter) {
            if (_viewTransitioning) return;
            _viewTransitioning = true;

            var outEl = document.getElementById(outId);
            var inEl = document.getElementById(inId);

            // Scroll the container to top for clean transition
            var container = document.getElementById('settingsContent');
            if (container) container.scrollTop = 0;

            outEl.classList.add('view-leaving');
            outEl.addEventListener('animationend', function handler() {
                outEl.removeEventListener('animationend', handler);
                outEl.classList.remove('view-leaving');
                outEl.style.display = 'none';

                inEl.style.display = '';
                inEl.classList.add('view-entering');
                inEl.addEventListener('animationend', function h2() {
                    inEl.removeEventListener('animationend', h2);
                    inEl.classList.remove('view-entering');
                    _viewTransitioning = false;
                });

                if (onAfter) onAfter();
            });
        }

        function showHub() {
            _animateViewSwitch('detailView', 'hubView', function() {
                currentAgent = null;
                updateHubMetrics();
            });
        }

        function showDetail(agentId) {
            if (!AGENTS[agentId]) return;
            currentAgent = agentId;
            currentTab = 'overview';

            _animateViewSwitch('hubView', 'detailView', function() {
                renderDetailHeader(agentId);
                renderDetailTabs(agentId);
                switchTab('overview');

                // Load agent-specific data (cachedFetch avoids redundant calls)
                if (agentId === 'arturito') {
                    loadPermissions();
                    if (window.arturityAnalytics) {
                        if (window.arturityAnalytics.loadIfNeeded) {
                            window.arturityAnalytics.loadIfNeeded();
                        } else {
                            window.arturityAnalytics.reload();
                        }
                    }
                } else if (agentId === 'andrew') {
                    loadAgentStats();
                    loadAgentConfig();
                    loadAndrewMismatchConfig();
                    loadAndrewSmartConfig();
                    if (!_andrewPickerInitialized) {
                        loadRecipientOptions().then(function() {
                            _initUserPicker({
                                pickerId: 'andrewAuthNotifyPicker',
                                inputId: 'andrewAuthNotifyPickerInput',
                                searchId: 'andrewAuthNotifySearch',
                                dropdownId: 'andrewAuthNotifyDropdown',
                                getUsers: function() { return _andrewAuthNotifyUsers; },
                                setUsers: function(v) {
                                    _andrewAuthNotifyUsers = v;
                                    _saveAndrewAuthNotifyUsers();
                                },
                                userPool: _andrewNotifyUserPool
                            });
                            _renderUserPickerChips('andrewAuthNotifyPickerInput', 'andrewAuthNotifySearch', _andrewAuthNotifyUsers, _andrewNotifyUserPool);
                            _andrewPickerInitialized = true;
                        });
                    }
                } else if (agentId === 'daneel') {
                    loadDaneelConfig();
                    loadDaneelAutoAuthConfig();
                    if (!_daneelPickerInitialized) {
                        loadRecipientOptions().then(function() {
                            return loadDaneelRecipientsSaved();
                        }).then(function() {
                            renderRecipientChips();
                            initDaneelRecipientPicker();
                            _initUserPicker({
                                pickerId: 'daneelBookkeepingPicker',
                                inputId: 'daneelBookkeepingPickerInput',
                                searchId: 'daneelBookkeepingSearch',
                                dropdownId: 'daneelBookkeepingDropdown',
                                getUsers: function() { return _daneelBookkeepingUsers; },
                                setUsers: function(v) { _daneelBookkeepingUsers = v; }
                            });
                            _initUserPicker({
                                pickerId: 'daneelEscalationPicker',
                                inputId: 'daneelEscalationPickerInput',
                                searchId: 'daneelEscalationSearch',
                                dropdownId: 'daneelEscalationDropdown',
                                getUsers: function() { return _daneelAccountingMgrUsers; },
                                setUsers: function(v) { _daneelAccountingMgrUsers = v; }
                            });
                            _renderUserPickerChips('daneelBookkeepingPickerInput', 'daneelBookkeepingSearch', _daneelBookkeepingUsers);
                            _renderUserPickerChips('daneelEscalationPickerInput', 'daneelEscalationSearch', _daneelAccountingMgrUsers);
                            _daneelPickerInitialized = true;
                        });
                    }
                }
            });
        }

        function renderDetailHeader(agentId) {
            var agent = AGENTS[agentId];
            var headerEl = document.getElementById('detailHeader');

            var statusClass = 'detail-status-active';
            var statusText = 'Active';

            if (agentId === 'daneel') {
                var daneelToggle = document.getElementById('daneelEnabled');
                if (daneelToggle && !daneelToggle.checked) {
                    statusClass = 'detail-status-disabled';
                    statusText = 'Disabled';
                }
            }

            headerEl.innerHTML =
                '<div class="agent-avatar agent-avatar-lg" style="background:' + agent.color + '">' + agent.initials + '</div>' +
                '<div class="detail-header-info">' +
                    '<h2 class="detail-agent-name">' + agent.name + '</h2>' +
                    '<p class="detail-agent-role">' + agent.role + '</p>' +
                '</div>' +
                '<span class="detail-status-badge ' + statusClass + '">' + statusText + '</span>';
        }

        function renderDetailTabs(agentId) {
            var agent = AGENTS[agentId];
            var tabsEl = document.getElementById('detailTabs');
            var tabLabels = {
                overview: 'Overview',
                scope: 'Scope of Work',
                config: 'Configuration',
                failures: 'Failures'
            };

            tabsEl.innerHTML = agent.tabs.map(function(tab) {
                return '<button class="detail-tab-btn' + (tab === 'overview' ? ' active' : '') + '" ' +
                       'data-tab="' + tab + '" onclick="AgentHub.switchTab(\'' + tab + '\')">' +
                       tabLabels[tab] + '</button>';
            }).join('');
        }

        function switchTab(tabId) {
            currentTab = tabId;

            // Hide all panels
            var panels = document.querySelectorAll('.detail-tab-panel');
            for (var i = 0; i < panels.length; i++) {
                panels[i].classList.remove('is-active');
            }

            // Show the active panel
            var activePanel = document.getElementById(currentAgent + '-' + tabId);
            if (activePanel) activePanel.classList.add('is-active');

            // Update tab button styles
            var buttons = document.querySelectorAll('.detail-tab-btn');
            for (var j = 0; j < buttons.length; j++) {
                buttons[j].classList.toggle('active', buttons[j].dataset.tab === tabId);
            }
        }

        // ============================================
        // HUB METRICS
        // ============================================

        function updateHubMetrics() {
            // Arturito
            if (permissionsData && permissionsData.by_category) {
                var total = 0, enabled = 0;
                var cats = permissionsData.by_category;
                for (var cat in cats) {
                    if (cats.hasOwnProperty(cat)) {
                        var perms = cats[cat];
                        total += perms.length;
                        for (var p = 0; p < perms.length; p++) {
                            if (perms[p].enabled) enabled++;
                        }
                    }
                }
                _removeSkeleton('hubArturitoPermissions', enabled + '/' + total);
            }
            if (window.arturityAnalytics) {
                var aStats = window.arturityAnalytics.getCurrentStats();
                if (aStats) {
                    _removeSkeleton('hubArturitoGptRate', (aStats.gpt_attempt_rate || 0) + '%');
                    _removeSkeleton('hubArturitoFailures', aStats.total_failures || '0');
                }
            }

            // Andrew
            _fetchAndrewHubStats();

            // Daneel
            _fetchDaneelHubStats();
        }

        function _fetchAndrewHubStats() {
            cachedFetch(API_BASE + '/pending-receipts/agent-stats', { headers: _agentAuthHeaders() })
                .then(function(stats) {
                    if (!stats) return;
                    _removeSkeleton('hubAndrewProcessed', stats.total_processed);
                    _removeSkeleton('hubAndrewSuccessRate', stats.success_rate + '%');
                    var errEl = document.getElementById('hubAndrewErrors');
                    errEl.textContent = stats.errors;
                    errEl.classList.remove('skeleton', 'skeleton-stat');
                    errEl.className = 'hub-metric-value' + (stats.errors > 0 ? ' metric-error' : '');
                })
                .catch(function() {});
        }

        function _fetchDaneelHubStats() {
            cachedFetch(API_BASE + '/daneel/auto-auth/status', { headers: _agentAuthHeaders() })
                .then(function(status) {
                    if (!status) return;

                    // Status = auto-auth enabled/disabled
                    var isEnabled = status.enabled === true;
                    var statusEl = document.getElementById('hubDaneelStatus');
                    statusEl.textContent = isEnabled ? 'Active' : 'Off';
                    statusEl.classList.remove('skeleton', 'skeleton-stat');
                    statusEl.className = 'hub-metric-value' + (isEnabled ? ' metric-success' : ' metric-error');

                    // Auto-Auth = authorizations last 30 days
                    var autoAuthEl = document.getElementById('hubDaneelAutoAuth');
                    autoAuthEl.textContent = status.authorized_last_30d || 0;
                    autoAuthEl.classList.remove('skeleton', 'skeleton-stat');
                    autoAuthEl.className = 'hub-metric-value' + ((status.authorized_last_30d > 0) ? ' metric-success' : ' metric-muted');

                    // Alerts = pending info count
                    var alertsEl = document.getElementById('hubDaneelAlerts');
                    var pendingCount = status.pending_info_count || 0;
                    alertsEl.textContent = pendingCount;
                    alertsEl.classList.remove('skeleton', 'skeleton-stat');
                    alertsEl.className = 'hub-metric-value' + (pendingCount > 0 ? ' metric-error' : '');

                    var dot = document.getElementById('hubDotDaneel');
                    if (dot) dot.className = 'hub-status-dot ' + (isEnabled ? 'hub-status-active' : 'hub-status-disabled');
                })
                .catch(function() {});
        }

        // ============================================
        // OCR METRICS
        // ============================================

        function _fetchOcrMetrics() {
            cachedFetch(API_BASE + '/ocr-metrics/summary?days=30', { headers: _agentAuthHeaders() }, 120000)
                .then(function(data) {
                    if (!data) return;
                    document.getElementById('ocrTotalScans').textContent = data.total_scans;
                    document.getElementById('ocrPdfplumber').textContent = data.pdfplumber_count;
                    document.getElementById('ocrVision').textContent = data.vision_count;
                    var errEl = document.getElementById('ocrErrors');
                    errEl.textContent = data.error_count;
                    if (data.error_count > 0) errEl.classList.add('ocr-error');
                    document.getElementById('ocrAvgConfidence').textContent =
                        data.avg_confidence !== null ? data.avg_confidence + '%' : '--';

                    // Success rate
                    var srEl = document.getElementById('ocrSuccessRate');
                    if (srEl) {
                        srEl.textContent = data.success_rate ? data.success_rate + '%' : '--';
                        if (data.success_rate >= 95) srEl.style.color = 'var(--accent)';
                        else if (data.success_rate >= 80) srEl.style.color = '#f59e0b';
                        else if (data.success_rate > 0) srEl.style.color = '#ef4444';
                    }

                    // Tax detected
                    var taxEl = document.getElementById('ocrTaxDetected');
                    if (taxEl) taxEl.textContent = data.tax_detected_count || 0;

                    // Match type breakdown chips
                    var matchContainer = document.getElementById('ocrMatchBreakdown');
                    if (matchContainer && data.match_types) {
                        matchContainer.innerHTML = '';
                        var mt = data.match_types;
                        var matchLabels = [
                            { key: 'total', label: 'Total Match', color: 'var(--accent)' },
                            { key: 'subtotal', label: 'Subtotal Match', color: '#f59e0b' },
                            { key: 'mismatch', label: 'Mismatch', color: '#ef4444' },
                            { key: 'none', label: 'No Match', color: 'var(--ngm-text-muted)' }
                        ];
                        matchLabels.forEach(function(m) {
                            if (mt[m.key] > 0) {
                                var chip = document.createElement('span');
                                chip.className = 'ocr-agent-chip';
                                chip.innerHTML = '<span style="color:' + m.color + ';font-weight:600;">' + m.label + '</span>: ' + mt[m.key];
                                matchContainer.appendChild(chip);
                            }
                        });
                    }

                    // Bar segments
                    var total = data.total_scans || 1;
                    document.getElementById('ocrBarPdf').style.width = (data.pdfplumber_count / total * 100) + '%';
                    document.getElementById('ocrBarVision').style.width = (data.vision_count / total * 100) + '%';
                    document.getElementById('ocrBarError').style.width = (data.error_count / total * 100) + '%';

                    // Agent breakdown chips
                    var container = document.getElementById('ocrAgentBreakdown');
                    container.innerHTML = '';
                    var agents = data.by_agent || {};
                    for (var agent in agents) {
                        if (agents.hasOwnProperty(agent)) {
                            var chip = document.createElement('span');
                            chip.className = 'ocr-agent-chip';
                            chip.innerHTML = '<strong>' + agent + '</strong>: ' + agents[agent] + ' scans';
                            container.appendChild(chip);
                        }
                    }
                })
                .catch(function() {});
        }

        // ============================================
        // ARTURITO PERMISSIONS
        // ============================================

        function loadPermissions() {
            cachedFetch(API_BASE + '/arturito/permissions', { headers: _agentAuthHeaders() })
                .then(function(data) {
                    if (!data) return;
                    permissionsData = data;
                    renderPermissions(data.by_category);
                    updateArturitoOverviewStats(data.by_category);
                    // Update hub card metrics with fresh permissions data
                    updateHubMetrics();
                })
                .catch(function(err) {
                    console.error('[AgentHub] Error loading permissions:', err);
                });
        }

        function updateArturitoOverviewStats(byCategory) {
            var total = 0, enabled = 0, highRiskEnabled = 0;
            var cats = byCategory || {};
            for (var cat in cats) {
                if (!cats.hasOwnProperty(cat)) continue;
                var perms = cats[cat];
                total += perms.length;
                for (var i = 0; i < perms.length; i++) {
                    if (perms[i].enabled) {
                        enabled++;
                        if (perms[i].risk_level === 'high') highRiskEnabled++;
                    }
                }
            }
            document.getElementById('arturitoStatTotal').textContent = total;
            document.getElementById('arturitoStatEnabled').textContent = enabled;
            document.getElementById('arturitoStatDisabled').textContent = total - enabled;
            document.getElementById('arturitoStatHighRisk').textContent = highRiskEnabled;
        }

        function renderPermissions(byCategory) {
            var container = document.getElementById('permissionsContainer');
            container.innerHTML = '';
            var categoryOrder = ['read', 'create', 'update', 'delete', 'notification', 'navigation'];

            for (var c = 0; c < categoryOrder.length; c++) {
                var category = categoryOrder[c];
                var permissions = byCategory[category];
                if (!permissions || permissions.length === 0) continue;

                var info = CATEGORY_INFO[category] || { name: category, icon: '?' };
                var card = document.createElement('div');
                card.className = 'permission-card';
                card.innerHTML =
                    '<div class="permission-card-header">' +
                        '<h3 class="permission-card-title">' +
                            '<span class="category-icon category-' + category + '">' + info.icon + '</span>' +
                            info.name +
                        '</h3>' +
                        '<span style="font-size: 11px; color: var(--ngm-text-muted);">' + permissions.length + ' permissions</span>' +
                    '</div>' +
                    '<div class="permission-list">' +
                        permissions.map(function(p) { return renderPermissionItem(p); }).join('') +
                    '</div>';
                container.appendChild(card);
            }
        }

        function renderPermissionItem(permission) {
            return '<div class="permission-item" data-intent="' + permission.intent + '">' +
                '<div class="permission-info">' +
                    '<span class="permission-name">' + permission.intent + '</span>' +
                    '<span class="permission-desc">' + permission.description + '</span>' +
                    '<span class="permission-risk risk-' + permission.risk_level + '">' +
                        (permission.risk_level === 'high' ? '!' : permission.risk_level === 'medium' ? '*' : 'ok') +
                        ' ' + permission.risk_level + ' risk' +
                    '</span>' +
                '</div>' +
                '<label class="toggle-switch">' +
                    '<input type="checkbox" ' +
                        (permission.enabled ? 'checked ' : '') +
                        'data-intent="' + permission.intent + '" ' +
                        'onchange="AgentHub.togglePermission(\'' + permission.intent + '\', this.checked)">' +
                    '<span class="toggle-slider"></span>' +
                '</label>' +
            '</div>';
        }

        function togglePermission(intent, enabled) {
            invalidateCache('/arturito/permissions');
            fetch(API_BASE + '/arturito/permissions', {
                method: 'PATCH',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify({ intent: intent, enabled: enabled })
            })
            .then(function(res) {
                if (!res.ok) throw new Error('Failed');
                return res.json();
            })
            .then(function() {
                if (window.Toast) {
                    window.Toast[enabled ? 'success' : 'info'](intent + ' ' + (enabled ? 'enabled' : 'disabled'));
                }
                loadPermissions();
            })
            .catch(function(err) {
                console.error('[AgentHub] Toggle error:', err);
                var checkbox = document.querySelector('input[data-intent="' + intent + '"]');
                if (checkbox) checkbox.checked = !enabled;
                if (window.Toast) window.Toast.error('Error updating permission');
            });
        }

        function resetToDefaults() {
            if (!confirm('Reset all permissions to their default values?')) return;

            invalidateCache('/arturito/permissions');
            fetch(API_BASE + '/arturito/permissions/reset', { method: 'POST', headers: _agentAuthHeaders() })
                .then(function(res) {
                    if (!res.ok) throw new Error('Failed');
                    if (window.Toast) window.Toast.success('Permissions reset to defaults');
                    loadPermissions();
                })
                .catch(function(err) {
                    console.error('[AgentHub] Reset error:', err);
                    if (window.Toast) window.Toast.error('Error resetting permissions');
                });
        }

        // ============================================
        // ANDREW AGENT
        // ============================================

        function loadAgentStats() {
            cachedFetch(API_BASE + '/pending-receipts/agent-stats', { headers: _agentAuthHeaders() })
                .then(function(stats) {
                    if (!stats) return;
                    document.getElementById('agentStatTotal').textContent = stats.total_processed;
                    document.getElementById('agentStatLinked').textContent = stats.expenses_created;
                    document.getElementById('agentStatSuccessRate').textContent = stats.success_rate + '%';
                    document.getElementById('agentStatConfidence').textContent = stats.avg_confidence + '%';
                    document.getElementById('agentStatPending').textContent = stats.pending_review;
                    document.getElementById('agentStatErrors').textContent = stats.errors;
                    document.getElementById('agentStatDuplicates').textContent = stats.duplicates_caught;

                    // Also update failures tab
                    document.getElementById('andrewFailureErrors').textContent = stats.errors;
                    document.getElementById('andrewFailureDuplicates').textContent = stats.duplicates_caught;
                })
                .catch(function(e) {
                    console.error('[AgentHub] Stats error:', e);
                });
        }

        function loadAgentConfig() {
            cachedFetch(API_BASE + '/pending-receipts/agent-config', { headers: _agentAuthHeaders() })
                .then(function(config) {
                    if (!config) return;
                    document.getElementById('cfgAutoCreate').checked = config.auto_create_expense !== false;

                    // Enforce threshold switch
                    var enforceThreshold = config.enforce_confidence_threshold !== false; // Default: true
                    document.getElementById('cfgEnforceThreshold').checked = enforceThreshold;

                    // Min confidence slider
                    var minConf = parseInt(config.min_confidence || 70);
                    document.getElementById('cfgMinConfidence').value = minConf;
                    document.getElementById('cfgMinConfidenceValue').textContent = minConf + '%';

                    // Show/hide slider based on toggle
                    document.getElementById('cfgMinConfidenceContainer').style.display = enforceThreshold ? 'flex' : 'none';

                    document.getElementById('cfgAutoSkipDuplicates').checked = config.auto_skip_duplicates === true;

                    // Auth notification user picker
                    try {
                        var raw = config.andrew_auth_notify_users;
                        _andrewAuthNotifyUsers = raw ? (typeof raw === 'string' ? JSON.parse(raw) : raw) : [];
                    } catch(e) { _andrewAuthNotifyUsers = []; }
                    if (_andrewPickerInitialized) {
                        _renderUserPickerChips('andrewAuthNotifyPickerInput', 'andrewAuthNotifySearch', _andrewAuthNotifyUsers, _andrewNotifyUserPool);
                    }
                })
                .catch(function(e) {
                    console.error('[AgentHub] Config load error:', e);
                });
        }

        function saveAgentConfig(key, value) {
            var body = {};
            body[key] = value;
            invalidateCache('/pending-receipts/agent-config');
            fetch(API_BASE + '/pending-receipts/agent-config', {
                method: 'PATCH',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify(body)
            }).catch(function(e) {
                console.error('[AgentHub] Config save error:', e);
            });
        }

        function _saveAndrewAuthNotifyUsers() {
            saveAgentConfig('andrew_auth_notify_users', JSON.stringify(_andrewAuthNotifyUsers));
        }

        function initAgentManager() {
            document.getElementById('cfgAutoCreate').addEventListener('change', function(e) {
                saveAgentConfig('auto_create_expense', e.target.checked);
            });

            // Enforce threshold toggle
            document.getElementById('cfgEnforceThreshold').addEventListener('change', function(e) {
                var isEnabled = e.target.checked;
                saveAgentConfig('enforce_confidence_threshold', isEnabled);
                // Show/hide the slider
                document.getElementById('cfgMinConfidenceContainer').style.display = isEnabled ? 'flex' : 'none';
            });

            document.getElementById('cfgMinConfidence').addEventListener('input', function(e) {
                document.getElementById('cfgMinConfidenceValue').textContent = e.target.value + '%';
            });
            document.getElementById('cfgMinConfidence').addEventListener('change', function(e) {
                saveAgentConfig('min_confidence', parseInt(e.target.value));
            });
            document.getElementById('cfgAutoSkipDuplicates').addEventListener('change', function(e) {
                saveAgentConfig('auto_skip_duplicates', e.target.checked);
            });

            // Mismatch reconciliation slider label
            document.getElementById('andrewMismatchConfidence').addEventListener('input', function(e) {
                document.getElementById('andrewMismatchConfidenceValue').textContent = e.target.value + '%';
            });
        }

        // Andrew Mismatch Config
        function loadAndrewMismatchConfig() {
            cachedFetch(API_BASE + '/andrew/mismatch-config', { headers: _agentAuthHeaders() })
                .then(function(cfg) {
                    if (!cfg) return;
                    document.getElementById('andrewMismatchEnabled').checked = cfg.andrew_mismatch_enabled !== false;
                    document.getElementById('andrewMismatchAutoCorrect').checked = cfg.andrew_mismatch_auto_correct === true;
                    var conf = cfg.andrew_mismatch_confidence_min || 85;
                    document.getElementById('andrewMismatchConfidence').value = conf;
                    document.getElementById('andrewMismatchConfidenceValue').textContent = conf + '%';
                    document.getElementById('andrewMismatchTolerance').value = cfg.andrew_mismatch_amount_tolerance || 0.02;
                })
                .catch(function(e) {
                    console.error('[Andrew] Mismatch config load error:', e);
                });
        }

        function saveAndrewMismatchConfig() {
            var body = {
                andrew_mismatch_enabled: document.getElementById('andrewMismatchEnabled').checked,
                andrew_mismatch_auto_correct: document.getElementById('andrewMismatchAutoCorrect').checked,
                andrew_mismatch_confidence_min: parseInt(document.getElementById('andrewMismatchConfidence').value),
                andrew_mismatch_amount_tolerance: parseFloat(document.getElementById('andrewMismatchTolerance').value),
            };
            invalidateCache('/andrew/mismatch-config');
            fetch(API_BASE + '/andrew/mismatch-config', {
                method: 'PUT',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify(body)
            }).then(function(resp) {
                if (resp.ok && window.Toast) window.Toast.success('Mismatch settings saved');
                else if (window.Toast) window.Toast.error('Failed to save mismatch settings');
            }).catch(function(e) {
                console.error('[Andrew] Mismatch config save error:', e);
                if (window.Toast) window.Toast.error('Failed to save mismatch settings');
            });
        }

        function saveAndrewSmartConfig() {
            var body = {
                andrew_smart_layer_enabled: document.getElementById('andrewSmartLayerEnabled').checked,
                andrew_followup_hours: parseInt(document.getElementById('andrewFollowupHours').value),
                andrew_escalation_hours: parseInt(document.getElementById('andrewEscalationHours').value),
            };
            invalidateCache('/andrew/mismatch-config');
            fetch(API_BASE + '/andrew/mismatch-config', {
                method: 'PUT',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify(body)
            }).then(function(resp) {
                if (resp.ok && window.Toast) window.Toast.success('Smart layer settings saved');
                else if (window.Toast) window.Toast.error('Failed to save smart layer settings');
            }).catch(function(e) {
                console.error('[Andrew] Smart config save error:', e);
                if (window.Toast) window.Toast.error('Failed to save smart layer settings');
            });
        }

        function runAndrewFollowupCheck() {
            fetch(API_BASE + '/andrew/follow-up-check', {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
            }).then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.ok) {
                    var s = data.stats || {};
                    var msg = 'Follow-up check complete';
                    if (s.followups_sent) msg += ' | ' + s.followups_sent + ' reminders sent';
                    if (s.escalations_sent) msg += ' | ' + s.escalations_sent + ' escalated';
                    if (s.marked_stale) msg += ' | ' + s.marked_stale + ' marked stale';
                    if (!s.followups_sent && !s.escalations_sent && !s.marked_stale) msg += ' | No action needed';
                    if (window.Toast) window.Toast.success(msg);
                } else {
                    if (window.Toast) window.Toast.error('Follow-up check failed');
                }
            }).catch(function(e) {
                console.error('[Andrew] Follow-up check error:', e);
                if (window.Toast) window.Toast.error('Follow-up check failed');
            });
        }

        function loadAndrewSmartConfig() {
            cachedFetch(API_BASE + '/andrew/mismatch-config', { headers: _agentAuthHeaders() })
            .then(function(cfg) {
                if (!cfg) return;
                if (cfg.andrew_smart_layer_enabled !== undefined) {
                    document.getElementById('andrewSmartLayerEnabled').checked = cfg.andrew_smart_layer_enabled !== false;
                }
                if (cfg.andrew_followup_hours) {
                    document.getElementById('andrewFollowupHours').value = cfg.andrew_followup_hours;
                }
                if (cfg.andrew_escalation_hours) {
                    document.getElementById('andrewEscalationHours').value = cfg.andrew_escalation_hours;
                }
            }).catch(function(e) {
                console.error('[Andrew] Smart config load error:', e);
            });
        }

        // ============================================
        // DANEEL BUDGET MONITOR
        // ============================================

        var _andrewAuthNotifyUsers = [];
        var _andrewNotifyUserPool = [];

        var _daneelRecipients = { roles: [], users: [] };
        var _daneelBookkeepingUsers = [];
        var _daneelAccountingMgrUsers = [];
        var _allRoles = [];
        var _allUsers = [];

        function loadDaneelConfig() {
            cachedFetch(API_BASE + '/budget-alerts/settings', { headers: _agentAuthHeaders() })
                .then(function(result) {
                    if (!result) return;
                    var config = result.data || result || {};

                    var isEnabled = config.is_enabled !== false;
                    document.getElementById('daneelEnabled').checked = isEnabled;

                    var warnVal = config.warning_threshold || 80;
                    document.getElementById('daneelWarningThreshold').value = warnVal;
                    document.getElementById('daneelWarningThresholdValue').textContent = warnVal + '%';

                    var critVal = config.critical_threshold || 95;
                    document.getElementById('daneelCriticalThreshold').value = critVal;
                    document.getElementById('daneelCriticalThresholdValue').textContent = critVal + '%';

                    document.getElementById('daneelOverspendAlert').checked = config.overspend_alert !== false;
                    document.getElementById('daneelNoBudgetAlert').checked = config.no_budget_alert !== false;

                    // Update overview stats
                    document.getElementById('daneelStatStatus').textContent = isEnabled ? 'Enabled' : 'Disabled';
                    document.getElementById('daneelStatStatus').className = 'stat-value' + (isEnabled ? ' enabled' : ' disabled');
                    document.getElementById('daneelStatWarn').textContent = warnVal + '%';
                    document.getElementById('daneelStatCrit').textContent = critVal + '%';

                    // Update detail header if currently viewing daneel
                    if (currentAgent === 'daneel') {
                        renderDetailHeader('daneel');
                    }
                })
                .catch(function(e) {
                    console.error('[Daneel] Config load error:', e);
                });
        }

        function saveDaneelConfig(key, value) {
            var body = {};
            body[key] = value;
            invalidateCache('/budget-alerts/settings');
            fetch(API_BASE + '/budget-alerts/settings', {
                method: 'PUT',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify(body)
            }).catch(function(e) {
                console.error('[Daneel] Config save error:', e);
            });
        }

        // ====== Recipient Picker ======

        function loadRecipientOptions() {
            return Promise.all([
                cachedFetch(API_BASE + '/team/rols', { headers: _agentAuthHeaders() }, 300000),
                cachedFetch(API_BASE + '/team/users', { headers: _agentAuthHeaders() }, 300000)
            ]).then(function(results) {
                var rolesData = results[0];
                var usersData = results[1];
                if (rolesData) {
                    _allRoles = Array.isArray(rolesData) ? rolesData : (rolesData.data || []);
                }
                if (usersData) {
                    var allUsers = Array.isArray(usersData) ? usersData : (usersData.data || []);
                    _allUsers = allUsers.filter(function(u) {
                        return u.user_id !== '00000000-0000-0000-0000-000000000001'
                            && u.user_id !== '00000000-0000-0000-0000-000000000002'
                            && u.user_id !== '00000000-0000-0000-0000-000000000003';
                    });
                    // Andrew auth-notify pool: real users + Daneel bot
                    var daneelBot = allUsers.find(function(u) {
                        return u.user_id === '00000000-0000-0000-0000-000000000002';
                    });
                    _andrewNotifyUserPool = daneelBot
                        ? [daneelBot].concat(_allUsers)
                        : _allUsers.slice();
                }
            }).catch(function(e) {
                console.error('[Daneel] Error loading recipient options:', e);
            });
        }

        function saveDaneelRecipients() {
            var payload = {
                daneel_alert_recipients: JSON.stringify({
                    roles: _daneelRecipients.roles,
                    users: _daneelRecipients.users
                })
            };
            invalidateCache('/pending-receipts/agent-config');
            fetch(API_BASE + '/pending-receipts/agent-config', {
                method: 'PATCH',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify(payload)
            }).catch(function(e) {
                console.error('[Daneel] Error saving recipients:', e);
            });
        }

        function loadDaneelRecipientsSaved() {
            return cachedFetch(API_BASE + '/pending-receipts/agent-config', { headers: _agentAuthHeaders() })
                .then(function(config) {
                    if (!config) return;
                    var raw = config.daneel_alert_recipients;
                    if (raw) {
                        var parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;
                        _daneelRecipients.roles = parsed.roles || [];
                        _daneelRecipients.users = parsed.users || [];
                    }
                })
                .catch(function(e) {
                    console.error('[Daneel] Error loading saved recipients:', e);
                });
        }

        function _escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderRecipientChips() {
            var container = document.getElementById('daneelPickerInput');
            var searchInput = document.getElementById('daneelRecipientSearch');

            container.querySelectorAll('.recipient-chip').forEach(function(c) { c.remove(); });

            _daneelRecipients.roles.forEach(function(roleId) {
                var role = _allRoles.find(function(r) {
                    return String(r.rol_id || r.id) === String(roleId);
                });
                if (!role) return;
                var roleName = role.rol_name || role.name || '';
                var chip = document.createElement('span');
                chip.className = 'recipient-chip role-chip';
                chip.innerHTML = 'All ' + _escapeHtml(roleName) + 's'
                    + ' <span class="chip-remove" data-type="role" data-id="' + roleId + '">&times;</span>';
                container.insertBefore(chip, searchInput);
            });

            _daneelRecipients.users.forEach(function(userId) {
                var user = _allUsers.find(function(u) { return u.user_id === userId; });
                if (!user) return;
                var hue = user.avatar_color || 200;
                var initials = (user.user_name || '?').charAt(0).toUpperCase();
                var chip = document.createElement('span');
                chip.className = 'recipient-chip user-chip';
                chip.innerHTML =
                    '<span class="chip-avatar" style="background:hsl(' + hue + ' 70% 45%)">' + initials + '</span>'
                    + _escapeHtml(user.user_name)
                    + ' <span class="chip-remove" data-type="user" data-id="' + userId + '">&times;</span>';
                container.insertBefore(chip, searchInput);
            });

            var total = _daneelRecipients.roles.length + _daneelRecipients.users.length;
            document.getElementById('daneelRecipientCount').textContent = total + ' selected';
        }

        function renderRecipientDropdown(filter) {
            var dropdown = document.getElementById('daneelRecipientDropdown');
            dropdown.innerHTML = '';
            var query = (filter || '').toLowerCase();

            var filteredRoles = _allRoles.filter(function(r) {
                var name = r.rol_name || r.name || '';
                return !query || name.toLowerCase().indexOf(query) >= 0;
            });
            if (filteredRoles.length > 0) {
                var groupLabel = document.createElement('div');
                groupLabel.className = 'recipient-dropdown-group-label';
                groupLabel.textContent = 'Roles';
                dropdown.appendChild(groupLabel);

                filteredRoles.forEach(function(role) {
                    var roleId = String(role.rol_id || role.id);
                    var roleName = role.rol_name || role.name || '';
                    var isSelected = _daneelRecipients.roles.indexOf(roleId) >= 0;
                    var item = document.createElement('div');
                    item.className = 'recipient-dropdown-item' + (isSelected ? ' is-selected' : '');
                    item.dataset.type = 'role';
                    item.dataset.id = roleId;
                    item.innerHTML =
                        '<span class="item-check">' + (isSelected ? '&#10003;' : '') + '</span>'
                        + '<span style="color:#a78bfa;font-weight:500;">All ' + _escapeHtml(roleName) + 's</span>';
                    dropdown.appendChild(item);
                });
            }

            var filteredUsers = _allUsers.filter(function(u) {
                return !query || (u.user_name || '').toLowerCase().indexOf(query) >= 0;
            });
            if (filteredUsers.length > 0) {
                var groupLabel2 = document.createElement('div');
                groupLabel2.className = 'recipient-dropdown-group-label';
                groupLabel2.textContent = 'Team Members';
                dropdown.appendChild(groupLabel2);

                filteredUsers.forEach(function(user) {
                    var isSelected = _daneelRecipients.users.indexOf(user.user_id) >= 0;
                    var hue = user.avatar_color || 200;
                    var initials = (user.user_name || '?').charAt(0).toUpperCase();
                    var roleName = user.role ? (user.role.name || '') : '';
                    var item = document.createElement('div');
                    item.className = 'recipient-dropdown-item' + (isSelected ? ' is-selected' : '');
                    item.dataset.type = 'user';
                    item.dataset.id = user.user_id;
                    item.innerHTML =
                        '<span class="item-check">' + (isSelected ? '&#10003;' : '') + '</span>'
                        + '<span class="chip-avatar" style="background:hsl(' + hue + ' 70% 45%)">' + initials + '</span>'
                        + '<span>' + _escapeHtml(user.user_name) + '</span>'
                        + (roleName ? '<span style="font-size:11px;color:var(--ngm-text-muted);margin-left:auto;">' + _escapeHtml(roleName) + '</span>' : '');
                    dropdown.appendChild(item);
                });
            }

            if (filteredRoles.length === 0 && filteredUsers.length === 0) {
                dropdown.innerHTML = '<div class="recipient-dropdown-empty">No results found</div>';
            }
        }

        function initDaneelRecipientPicker() {
            var searchInput = document.getElementById('daneelRecipientSearch');
            var pickerInput = document.getElementById('daneelPickerInput');
            var dropdown = document.getElementById('daneelRecipientDropdown');

            searchInput.addEventListener('focus', function() {
                renderRecipientDropdown(searchInput.value);
                dropdown.classList.add('is-open');
            });

            searchInput.addEventListener('input', function() {
                renderRecipientDropdown(searchInput.value);
                if (!dropdown.classList.contains('is-open')) {
                    dropdown.classList.add('is-open');
                }
            });

            dropdown.addEventListener('click', function(e) {
                var item = e.target.closest('.recipient-dropdown-item');
                if (!item) return;

                var type = item.dataset.type;
                var id = item.dataset.id;

                if (type === 'role') {
                    var idx = _daneelRecipients.roles.indexOf(id);
                    if (idx >= 0) _daneelRecipients.roles.splice(idx, 1);
                    else _daneelRecipients.roles.push(id);
                } else if (type === 'user') {
                    var idx2 = _daneelRecipients.users.indexOf(id);
                    if (idx2 >= 0) _daneelRecipients.users.splice(idx2, 1);
                    else _daneelRecipients.users.push(id);
                }

                renderRecipientChips();
                renderRecipientDropdown(searchInput.value);
                saveDaneelRecipients();
            });

            pickerInput.addEventListener('click', function(e) {
                var removeBtn = e.target.closest('.chip-remove');
                if (!removeBtn) {
                    searchInput.focus();
                    return;
                }

                var type = removeBtn.dataset.type;
                var id = removeBtn.dataset.id;

                if (type === 'role') {
                    _daneelRecipients.roles = _daneelRecipients.roles.filter(function(r) { return r !== id; });
                } else {
                    _daneelRecipients.users = _daneelRecipients.users.filter(function(u) { return u !== id; });
                }

                renderRecipientChips();
                if (dropdown.classList.contains('is-open')) {
                    renderRecipientDropdown(searchInput.value);
                }
                saveDaneelRecipients();
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#daneelRecipientPicker')) {
                    dropdown.classList.remove('is-open');
                }
            });
        }

        function initDaneel() {
            document.getElementById('daneelEnabled').addEventListener('change', function(e) {
                saveDaneelConfig('is_enabled', e.target.checked);
            });
            document.getElementById('daneelWarningThreshold').addEventListener('input', function(e) {
                document.getElementById('daneelWarningThresholdValue').textContent = e.target.value + '%';
            });
            document.getElementById('daneelWarningThreshold').addEventListener('change', function(e) {
                saveDaneelConfig('warning_threshold', parseInt(e.target.value));
            });
            document.getElementById('daneelCriticalThreshold').addEventListener('input', function(e) {
                document.getElementById('daneelCriticalThresholdValue').textContent = e.target.value + '%';
            });
            document.getElementById('daneelCriticalThreshold').addEventListener('change', function(e) {
                saveDaneelConfig('critical_threshold', parseInt(e.target.value));
            });
            document.getElementById('daneelOverspendAlert').addEventListener('change', function(e) {
                saveDaneelConfig('overspend_alert', e.target.checked);
            });
            document.getElementById('daneelNoBudgetAlert').addEventListener('change', function(e) {
                saveDaneelConfig('no_budget_alert', e.target.checked);
            });

            // Auto-Auth config listeners (UI-only, no auto-save -- Apply button handles saving)
            document.getElementById('daneelAutoAuthEnabled').addEventListener('change', function(e) {
                document.getElementById('daneelAutoAuthStatusLabel').textContent = e.target.checked ? 'Enabled' : 'Disabled';
                var aaEl = document.getElementById('hubDaneelAutoAuth');
                aaEl.textContent = e.target.checked ? 'On' : 'Off';
                aaEl.className = 'hub-metric-value' + (e.target.checked ? ' metric-success' : ' metric-muted');
            });
            document.getElementById('daneelFuzzyThreshold').addEventListener('input', function(e) {
                document.getElementById('daneelFuzzyThresholdValue').textContent = e.target.value + '%';
            });
            // Apply button -- batch save all config
            document.getElementById('daneelApplyConfig').addEventListener('click', saveDaneelAutoAuthConfig);

            // Refresh projects button
            document.getElementById('daneelRefreshProjects').addEventListener('click', loadDaneelProjectReview);

            // Refresh reports button
            document.getElementById('daneelRefreshReports').addEventListener('click', loadDaneelAuthReports);

            // Clear reports button
            document.getElementById('daneelClearReports').addEventListener('click', clearDaneelAuthReports);
        }

        // ====== Daneel Auto-Auth Config ======

        function runDaneelFollowupCheck() {
            fetch(API_BASE + '/daneel/auto-auth/follow-up-check', {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
            }).then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.ok) {
                    var s = data.stats || {};
                    var msg = 'Follow-up check complete';
                    if (s.followups_sent) msg += ' | ' + s.followups_sent + ' reminders sent';
                    if (s.escalations_sent) msg += ' | ' + s.escalations_sent + ' escalated';
                    if (s.marked_stale) msg += ' | ' + s.marked_stale + ' marked stale';
                    if (!s.followups_sent && !s.escalations_sent && !s.marked_stale) msg += ' | No action needed';
                    if (window.Toast) window.Toast.success(msg);
                } else {
                    if (window.Toast) window.Toast.error('Follow-up check failed');
                }
            }).catch(function(e) {
                console.error('[Daneel] Follow-up check error:', e);
                if (window.Toast) window.Toast.error('Follow-up check failed');
            });
        }

        function saveDaneelAutoAuthConfig() {
            var btn = document.getElementById('daneelApplyConfig');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            invalidateCache('/daneel/auto-auth');
            var body = {
                daneel_auto_auth_enabled: document.getElementById('daneelAutoAuthEnabled').checked,
                daneel_auto_auth_require_bill: document.getElementById('daneelRequireBill').checked,
                daneel_auto_auth_require_receipt: document.getElementById('daneelRequireReceipt').checked,
                daneel_fuzzy_threshold: parseInt(document.getElementById('daneelFuzzyThreshold').value),
                daneel_amount_tolerance: parseFloat(document.getElementById('daneelAmountTolerance').value),
                daneel_labor_keywords: document.getElementById('daneelLaborKeywords').value.trim(),
                daneel_bookkeeping_users: JSON.stringify(_daneelBookkeepingUsers),
                daneel_accounting_mgr_users: JSON.stringify(_daneelAccountingMgrUsers),
                daneel_receipt_hash_check_enabled: document.getElementById('daneelReceiptHashCheck').checked,
                daneel_smart_layer_enabled: document.getElementById('daneelSmartLayerEnabled').checked,
                daneel_followup_hours: parseInt(document.getElementById('daneelFollowupHours').value),
                daneel_escalation_hours: parseInt(document.getElementById('daneelEscalationHours').value),
            };
            fetch(API_BASE + '/daneel/auto-auth/config', {
                method: 'PUT',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders()),
                body: JSON.stringify(body)
            }).then(function(resp) {
                btn.disabled = false;
                btn.textContent = 'Apply Changes';
                if (resp.ok) {
                    if (window.Toast) window.Toast.success('Auto-auth settings saved');
                } else {
                    if (window.Toast) window.Toast.error('Failed to save settings');
                }
            }).catch(function(e) {
                btn.disabled = false;
                btn.textContent = 'Apply Changes';
                console.error('[Daneel] Auto-auth config save error:', e);
                if (window.Toast) window.Toast.error('Failed to save settings');
            });
        }

        function loadDaneelAutoAuthConfig() {
            cachedFetch(API_BASE + '/daneel/auto-auth/config', { headers: _agentAuthHeaders() })
                .then(function(cfg) {
                    if (!cfg) return;

                    var enabled = cfg.daneel_auto_auth_enabled === true;
                    document.getElementById('daneelAutoAuthEnabled').checked = enabled;
                    document.getElementById('daneelAutoAuthStatusLabel').textContent = enabled ? 'Enabled' : 'Disabled';
                    var aaHubEl = document.getElementById('hubDaneelAutoAuth');
                    aaHubEl.textContent = enabled ? 'On' : 'Off';
                    aaHubEl.className = 'hub-metric-value' + (enabled ? ' metric-success' : ' metric-muted');

                    document.getElementById('daneelRequireBill').checked = cfg.daneel_auto_auth_require_bill !== false;
                    document.getElementById('daneelRequireReceipt').checked = cfg.daneel_auto_auth_require_receipt !== false;

                    var fuzzy = cfg.daneel_fuzzy_threshold || 85;
                    document.getElementById('daneelFuzzyThreshold').value = fuzzy;
                    document.getElementById('daneelFuzzyThresholdValue').textContent = fuzzy + '%';

                    document.getElementById('daneelAmountTolerance').value = cfg.daneel_amount_tolerance || 0.05;
                    document.getElementById('daneelLaborKeywords').value = cfg.daneel_labor_keywords || 'labor';

                    // Receipt hash check
                    document.getElementById('daneelReceiptHashCheck').checked = cfg.daneel_receipt_hash_check_enabled !== false;

                    // Load user picker selections
                    try {
                        var bkRaw = cfg.daneel_bookkeeping_users;
                        _daneelBookkeepingUsers = bkRaw ? (typeof bkRaw === 'string' ? JSON.parse(bkRaw) : bkRaw) : [];
                    } catch(e) { _daneelBookkeepingUsers = []; }
                    try {
                        var mgRaw = cfg.daneel_accounting_mgr_users;
                        _daneelAccountingMgrUsers = mgRaw ? (typeof mgRaw === 'string' ? JSON.parse(mgRaw) : mgRaw) : [];
                    } catch(e) { _daneelAccountingMgrUsers = []; }

                    _renderUserPickerChips('daneelBookkeepingPickerInput', 'daneelBookkeepingSearch', _daneelBookkeepingUsers);
                    _renderUserPickerChips('daneelEscalationPickerInput', 'daneelEscalationSearch', _daneelAccountingMgrUsers);

                    // Smart layer controls
                    document.getElementById('daneelSmartLayerEnabled').checked = cfg.daneel_smart_layer_enabled !== false;
                    if (cfg.daneel_followup_hours) {
                        document.getElementById('daneelFollowupHours').value = cfg.daneel_followup_hours;
                    }
                    if (cfg.daneel_escalation_hours) {
                        document.getElementById('daneelEscalationHours').value = cfg.daneel_escalation_hours;
                    }
                })
                .catch(function(e) {
                    console.error('[Daneel] Auto-auth config load error:', e);
                });

            // Load status
            cachedFetch(API_BASE + '/daneel/auto-auth/status', { headers: _agentAuthHeaders() })
                .then(function(status) {
                    if (!status) return;
                    document.getElementById('daneelStatAutoAuth').textContent = status.authorized_last_30d || 0;
                    document.getElementById('daneelStatPendingInfo').textContent = status.pending_info_count || 0;

                    // Last run timestamp
                    var lastRunEl = document.getElementById('daneelStatLastRun');
                    if (lastRunEl && status.last_run) {
                        var d = new Date(status.last_run);
                        var now = new Date();
                        var diffMs = now - d;
                        var diffH = Math.floor(diffMs / 3600000);
                        if (diffH < 1) lastRunEl.textContent = '<1h ago';
                        else if (diffH < 24) lastRunEl.textContent = diffH + 'h ago';
                        else lastRunEl.textContent = Math.floor(diffH / 24) + 'd ago';
                    } else if (lastRunEl) {
                        lastRunEl.textContent = 'Never';
                        lastRunEl.className = 'stat-value metric-muted';
                    }
                })
                .catch(function(e) {
                    console.error('[Daneel] Auto-auth status load error:', e);
                });

            // Load project review and auth reports
            loadDaneelProjectReview();
            loadDaneelAuthReports();
        }

        // ====== User Multi-Select Picker (reusable) ======

        function _renderUserPickerChips(containerId, searchId, userIds, userPool) {
            var pool = userPool || _allUsers;
            var container = document.getElementById(containerId);
            var searchInput = document.getElementById(searchId);
            if (!container || !searchInput) return;

            // Remove existing chips
            var existingChips = container.querySelectorAll('.recipient-chip');
            existingChips.forEach(function(c) { c.remove(); });

            // Render chips for selected users
            userIds.forEach(function(uid) {
                var user = pool.find(function(u) { return String(u.user_id) === String(uid); });
                if (!user) return;
                var name = user.user_name || 'Unknown';
                var hue = user.avatar_color || 200;
                var initials = name.split(' ').map(function(w) { return w[0]; }).join('').substring(0, 2).toUpperCase();

                var chip = document.createElement('span');
                chip.className = 'recipient-chip user-chip';
                chip.innerHTML =
                    '<span class="chip-avatar" style="background:hsl(' + hue + ' 70% 45%)">' + initials + '</span>'
                    + _escapeHtml(name)
                    + ' <span class="chip-remove" data-picker="' + containerId + '" data-id="' + uid + '">&times;</span>';
                container.insertBefore(chip, searchInput);
            });
        }

        function _renderUserPickerDropdown(dropdownId, searchQuery, selectedIds, userPool) {
            var pool = userPool || _allUsers;
            var dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            dropdown.innerHTML = '';

            var query = (searchQuery || '').toLowerCase();
            var filtered = pool.filter(function(u) {
                var name = u.user_name || '';
                return !query || name.toLowerCase().indexOf(query) >= 0;
            });

            if (filtered.length === 0) {
                var empty = document.createElement('div');
                empty.style.cssText = 'padding: 12px; text-align: center; color: var(--ngm-text-muted); font-size: 12px;';
                empty.textContent = query ? 'No users found' : 'No users available';
                dropdown.appendChild(empty);
                return;
            }

            filtered.forEach(function(user) {
                var uid = String(user.user_id);
                var isSelected = selectedIds.indexOf(uid) >= 0;
                var name = user.user_name || 'Unknown';
                var hue = user.avatar_color || 200;
                var initials = name.split(' ').map(function(w) { return w[0]; }).join('').substring(0, 2).toUpperCase();

                var item = document.createElement('div');
                item.className = 'recipient-dropdown-item' + (isSelected ? ' is-selected' : '');
                item.dataset.type = 'user';
                item.dataset.id = uid;
                item.innerHTML =
                    '<span class="item-check">' + (isSelected ? '&#10003;' : '') + '</span>'
                    + '<span class="chip-avatar" style="background:hsl(' + hue + ' 70% 45%); width:22px; height:22px; font-size:10px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; color:#fff; margin-right:8px;">' + initials + '</span>'
                    + '<span>' + _escapeHtml(name) + '</span>';
                dropdown.appendChild(item);
            });
        }

        function _initUserPicker(cfg) {
            var pool = cfg.userPool || null;
            var container = document.getElementById(cfg.inputId);
            var searchInput = document.getElementById(cfg.searchId);
            var dropdown = document.getElementById(cfg.dropdownId);
            if (!container || !searchInput || !dropdown) return;

            searchInput.addEventListener('focus', function() {
                _renderUserPickerDropdown(cfg.dropdownId, '', cfg.getUsers(), pool);
                dropdown.classList.add('is-open');
            });

            searchInput.addEventListener('input', function() {
                _renderUserPickerDropdown(cfg.dropdownId, searchInput.value, cfg.getUsers(), pool);
                dropdown.classList.add('is-open');
            });

            dropdown.addEventListener('click', function(e) {
                var item = e.target.closest('.recipient-dropdown-item');
                if (!item) return;
                var uid = item.dataset.id;
                var currentUsers = cfg.getUsers();
                var idx = currentUsers.indexOf(uid);
                if (idx >= 0) {
                    currentUsers.splice(idx, 1);
                } else {
                    currentUsers.push(uid);
                }
                cfg.setUsers(currentUsers);
                _renderUserPickerChips(cfg.inputId, cfg.searchId, currentUsers, pool);
                _renderUserPickerDropdown(cfg.dropdownId, searchInput.value, currentUsers, pool);
            });

            container.addEventListener('click', function(e) {
                var removeBtn = e.target.closest('.chip-remove');
                if (!removeBtn) {
                    searchInput.focus();
                    return;
                }
                var uid = removeBtn.dataset.id;
                var currentUsers = cfg.getUsers();
                cfg.setUsers(currentUsers.filter(function(id) { return id !== uid; }));
                _renderUserPickerChips(cfg.inputId, cfg.searchId, cfg.getUsers(), pool);
                if (dropdown.classList.contains('is-open')) {
                    _renderUserPickerDropdown(cfg.dropdownId, searchInput.value, cfg.getUsers(), pool);
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#' + cfg.pickerId)) {
                    dropdown.classList.remove('is-open');
                }
            });
        }

        // ====== Project Review ======

        function loadDaneelProjectReview() {
            var container = document.getElementById('daneelProjectReview');
            if (!container) return;

            container.innerHTML = '<div class="empty-state-msg">Loading projects...</div>';

            cachedFetch(API_BASE + '/daneel/auto-auth/project-summary', { headers: _agentAuthHeaders() })
                .then(function(result) {
                    if (!result || !result.data || result.data.length === 0) {
                        container.innerHTML = '<div class="empty-state-msg">No projects with expense activity</div>';
                        return;
                    }
                    container.innerHTML = '';
                    result.data.forEach(function(project) {
                        var row = document.createElement('div');
                        row.className = 'daneel-project-row';
                        var leftHtml = '<div style="flex: 1; min-width: 0;">'
                            + '<div class="daneel-project-name">' + _escapeHtml(project.project_name) + '</div>'
                            + '<div class="daneel-project-stats">'
                            + '<span>Pending: <strong style="color: ' + (project.pending > 0 ? '#f59e0b' : 'var(--ngm-text-muted)') + '">' + project.pending + '</strong></span>'
                            + '<span>Authorized: <strong style="color: #10b981">' + project.authorized_by_daneel + '</strong></span>'
                            + '<span>Missing: <strong style="color: ' + (project.missing_info > 0 ? '#ef4444' : 'var(--ngm-text-muted)') + '">' + project.missing_info + '</strong></span>'
                            + '</div></div>';
                        var runBtn = '';
                        if (project.pending > 0) {
                            runBtn = '<button type="button" data-project-id="' + project.project_id + '" class="daneel-run-project-btn daneel-run-btn">Run</button>';
                        }
                        row.innerHTML = leftHtml + runBtn;
                        container.appendChild(row);
                    });
                })
                .catch(function(e) {
                    console.error('[Daneel] Project review load error:', e);
                    container.innerHTML = '<div class="empty-state-msg">Failed to load projects</div>';
                });
        }

        // ====== Auth Reports ======

        function loadDaneelAuthReports() {
            var container = document.getElementById('daneelAuthReports');
            if (!container) return;

            container.innerHTML = '<div class="empty-state-msg">Loading reports...</div>';

            fetch(API_BASE + '/daneel/auto-auth/reports?limit=15', { headers: _agentAuthHeaders() })
                .then(function(resp) { return resp.ok ? resp.json() : null; })
                .then(function(result) {
                    if (!result || !result.data || result.data.length === 0) {
                        container.innerHTML = '<div class="empty-state-msg">No reports yet</div>';
                        return;
                    }
                    container.innerHTML = '';
                    result.data.forEach(function(r) {
                        var typeLabel = r.report_type === 'project_run' ? 'Project' : r.report_type === 'backlog' ? 'Backlog' : r.report_type === 'realtime' ? 'Realtime' : r.report_type;
                        var ts = r.created_at ? new Date(r.created_at).toLocaleString() : '--';
                        var nameStr = r.project_name || '';

                        var badges = '';
                        if (r.authorized > 0) badges += '<span class="daneel-badge daneel-badge-auth">' + r.authorized + ' auth</span>';
                        if (r.missing_info > 0) badges += '<span class="daneel-badge daneel-badge-missing">' + r.missing_info + ' missing</span>';
                        if (r.duplicates > 0) badges += '<span class="daneel-badge daneel-badge-dup">' + r.duplicates + ' dup</span>';
                        if (r.escalated > 0) badges += '<span class="daneel-badge daneel-badge-esc">' + r.escalated + ' esc</span>';

                        var row = document.createElement('div');
                        row.className = 'daneel-report-row';
                        row.dataset.reportId = r.report_id;
                        row.innerHTML = '<div style="flex: 1; min-width: 0;">'
                            + '<div style="display: flex; align-items: center; gap: 8px;">'
                            + '<span style="font-size: 10px; font-weight: 600; color: var(--ngm-text-muted); text-transform: uppercase; min-width: 55px;">' + typeLabel + '</span>'
                            + '<span style="font-size: 12px; color: var(--ngm-text);">' + _escapeHtml(nameStr) + '</span>'
                            + '</div>'
                            + '<div style="display: flex; align-items: center; gap: 4px; margin-top: 3px;">'
                            + badges
                            + '<span style="font-size: 10px; color: var(--ngm-text-muted); margin-left: auto;">' + ts + '</span>'
                            + '</div>'
                            + '</div>';

                        container.appendChild(row);
                    });
                })
                .catch(function(e) {
                    console.error('[Daneel] Reports load error:', e);
                    container.innerHTML = '<div class="empty-state-msg">Failed to load reports</div>';
                });
        }

        function clearDaneelAuthReports() {
            if (!confirm('Delete all auth reports? This cannot be undone.')) return;
            var btn = document.getElementById('daneelClearReports');
            btn.disabled = true;
            btn.textContent = 'Clearing...';
            fetch(API_BASE + '/daneel/auto-auth/reports', {
                method: 'DELETE',
                headers: _agentAuthHeaders()
            })
            .then(function(resp) { return resp.json(); })
            .then(function(result) {
                btn.disabled = false;
                btn.textContent = 'Clear Logs';
                if (result.ok) {
                    if (window.Toast) window.Toast.success('Auth reports cleared');
                    loadDaneelAuthReports();
                } else {
                    if (window.Toast) window.Toast.error('Failed to clear reports');
                }
            })
            .catch(function(e) {
                btn.disabled = false;
                btn.textContent = 'Clear Logs';
                console.error('[Daneel] Clear reports error:', e);
                if (window.Toast) window.Toast.error('Failed to clear reports');
            });
        }

        function _openReportDetail(reportId, rowEl) {
            // Check if detail is already open
            var existing = rowEl.nextElementSibling;
            if (existing && existing.classList.contains('daneel-report-detail')) {
                existing.remove();
                return;
            }
            // Remove any other open detail
            var allDetails = document.querySelectorAll('.daneel-report-detail');
            for (var i = 0; i < allDetails.length; i++) allDetails[i].remove();

            var detail = document.createElement('div');
            detail.className = 'daneel-report-detail';
            detail.innerHTML = '<div style="text-align: center; color: var(--ngm-text-muted);">Loading...</div>';
            rowEl.after(detail);

            fetch(API_BASE + '/daneel/auto-auth/reports/' + reportId, { headers: _agentAuthHeaders() })
                .then(function(resp) { return resp.ok ? resp.json() : null; })
                .then(function(report) {
                    if (!report || !report.decisions || report.decisions.length === 0) {
                        detail.innerHTML = '<div style="color: var(--ngm-text-muted);">No decisions in this report</div>';
                        return;
                    }
                    var decColors = { authorized: '#10b981', missing_info: '#f59e0b', duplicate: '#8b5cf6', escalated: '#ef4444' };
                    var checkLabels = { health: 'Health Check', bill_hint: 'Bill Hint', bill_hint_vision: 'Bill Hint (Vision)', receipt_hash: 'Receipt Hash', duplicate: 'Duplicate (R1-R9)', gpt_resolve: 'GPT Resolve' };
                    var html = '';

                    report.decisions.forEach(function(d, idx) {
                        var color = decColors[d.decision] || 'var(--ngm-text-muted)';
                        var amt = '$' + (d.amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

                        // Expense header row
                        html += '<div style="' + (idx > 0 ? 'margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--ngm-border);' : '') + ' display: flex; align-items: center; gap: 10px;">'
                            + '<span style="font-weight: 600; color: var(--ngm-text); min-width: 120px; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + _escapeHtml(d.vendor || '') + '</span>'
                            + '<span style="color: var(--ngm-text); min-width: 80px;">' + amt + '</span>'
                            + '<span style="color: var(--ngm-text-muted); min-width: 80px;">' + (d.date || '') + '</span>'
                            + (d.bill_id ? '<span style="color: var(--ngm-text-muted); font-size: 10px;">Bill: ' + _escapeHtml(d.bill_id) + '</span>' : '')
                            + '<span style="margin-left: auto; color: ' + color + '; font-weight: 600; font-size: 11px; text-transform: uppercase;">' + (d.decision || '') + '</span>'
                            + '</div>';

                        // Checks trail (if available)
                        if (d.checks && d.checks.length > 0) {
                            html += '<div style="display: flex; flex-wrap: wrap; gap: 4px; margin: 4px 0 0 4px;">';
                            d.checks.forEach(function(c) {
                                var label = checkLabels[c.check] || c.check;
                                var bg = c.passed ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)';
                                var fg = c.passed ? '#10b981' : '#ef4444';
                                var icon = c.passed ? 'V' : 'X';
                                html += '<span title="' + _escapeHtml(c.detail || '') + '" style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; background: ' + bg + '; color: ' + fg + '; font-size: 10px; font-weight: 500; cursor: default;">'
                                    + '<span style="font-weight: 700;">' + icon + '</span> ' + _escapeHtml(label)
                                    + '</span>';
                            });
                            html += '</div>';
                            // Detail text under checks
                            html += '<div style="margin: 2px 0 0 4px; font-size: 10px; color: var(--ngm-text-muted);">';
                            d.checks.forEach(function(c) {
                                if (c.detail) {
                                    var label = checkLabels[c.check] || c.check;
                                    var fg = c.passed ? '#10b981' : '#ef4444';
                                    html += '<div style="margin-top: 1px;"><span style="color: ' + fg + '; font-weight: 500;">' + _escapeHtml(label) + ':</span> ' + _escapeHtml(c.detail) + '</div>';
                                }
                            });
                            html += '</div>';
                        } else {
                            // Fallback for old reports without checks trail
                            var detailStr = d.reason || '';
                            if (d.missing_fields && d.missing_fields.length > 0) {
                                detailStr = 'Missing: ' + d.missing_fields.join(', ');
                            }
                            if (detailStr) {
                                html += '<div style="margin: 2px 0 0 4px; font-size: 10px; color: var(--ngm-text-muted);">'
                                    + '<span style="font-weight: 500;">' + _escapeHtml(d.rule || '') + ':</span> ' + _escapeHtml(detailStr)
                                    + '</div>';
                            }
                        }
                    });

                    detail.innerHTML = html;
                })
                .catch(function() {
                    detail.innerHTML = '<div style="color: #ef4444;">Failed to load report detail</div>';
                });
        }

        function runDaneelBacklog() {
            var btn = document.getElementById('daneelRunBacklog');
            var statusEl = document.getElementById('daneelBacklogStatus');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            statusEl.textContent = 'Running -- this may take a moment...';

            fetch(API_BASE + '/daneel/auto-auth/run-backlog', {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json' }, _agentAuthHeaders())
            })
            .then(function(resp) { return resp.json(); })
            .then(function(result) {
                btn.disabled = false;
                btn.textContent = 'Process Backlog';
                if (result.status === 'disabled') {
                    statusEl.textContent = 'Auto-auth is disabled. Enable it first.';
                    if (window.Toast) window.Toast.warning('Auto-auth is disabled');
                    return;
                }
                var summary = (result.authorized || 0) + ' authorized, '
                    + (result.missing_info || 0) + ' missing info, '
                    + (result.duplicates || 0) + ' duplicates, '
                    + (result.escalated || 0) + ' escalated';
                statusEl.textContent = 'Done: ' + summary;
                if (window.Toast) window.Toast.success('Backlog processed: ' + summary);
                // Refresh stats and reports (invalidate cache for fresh data)
                invalidateCache('/daneel/auto-auth');
                loadDaneelAutoAuthConfig();
                loadDaneelAuthReports();
            })
            .catch(function(e) {
                btn.disabled = false;
                btn.textContent = 'Process Backlog';
                statusEl.textContent = 'Error: ' + e.message;
                if (window.Toast) window.Toast.error('Backlog run failed');
            });
        }

        // ============================================
        // DELEGATED LISTENERS
        // ============================================

        function _initDelegatedListeners() {
            // Project review: delegated "Run" button clicks
            var projContainer = document.getElementById('daneelProjectReview');
            if (projContainer) {
                projContainer.addEventListener('click', function(e) {
                    var btn = e.target.closest('.daneel-run-project-btn');
                    if (!btn || btn.disabled) return;
                    e.stopPropagation();
                    var pid = btn.dataset.projectId;
                    btn.disabled = true;
                    btn.textContent = '...';
                    fetch(API_BASE + '/daneel/auto-auth/run?project_id=' + encodeURIComponent(pid), {
                        method: 'POST',
                        headers: _agentAuthHeaders()
                    }).then(function(resp) { return resp.ok ? resp.json() : null; })
                    .then(function(data) {
                        btn.disabled = false;
                        btn.textContent = 'Run';
                        if (data) {
                            var parts = [];
                            if (data.authorized) parts.push(data.authorized + ' authorized');
                            if (data.missing_info) parts.push(data.missing_info + ' need info');
                            if (data.duplicates) parts.push(data.duplicates + ' duplicates');
                            if (data.escalated) parts.push(data.escalated + ' escalated');
                            var msg = parts.length > 0 ? parts.join(', ') : 'No pending expenses found';
                            if (window.Toast) window.Toast.success(msg);
                            invalidateCache('/daneel/auto-auth');
                            loadDaneelProjectReview();
                            loadDaneelAuthReports();
                        } else {
                            if (window.Toast) window.Toast.error('Run failed');
                        }
                    }).catch(function() {
                        btn.disabled = false;
                        btn.textContent = 'Run';
                        if (window.Toast) window.Toast.error('Run failed');
                    });
                });
            }

            // Auth reports: delegated row clicks
            var reportsContainer = document.getElementById('daneelAuthReports');
            if (reportsContainer) {
                reportsContainer.addEventListener('click', function(e) {
                    var row = e.target.closest('.daneel-report-row');
                    if (!row) return;
                    var reportId = row.dataset.reportId;
                    if (reportId) _openReportDetail(reportId, row);
                });
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAccess()) return;

            // Immediately reveal the hub view -- cards are static HTML, no need to wait for API
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('settingsContent').style.display = 'block';

            // Init config listeners (one-time binding)
            initAgentManager();
            initDaneel();

            // Load hub-visible data
            updateHubMetrics();
            _fetchOcrMetrics();

            // Load Arturito permissions for hub card metrics (cached, page already visible)
            loadPermissions();

            // Load analytics for hub card GPT rate/failures (lazy)
            if (window.arturityAnalytics && window.arturityAnalytics.loadIfNeeded) {
                window.arturityAnalytics.loadIfNeeded();
            }

            // Back button
            document.getElementById('btnBackToHub').addEventListener('click', showHub);

            // Reset button (Arturito config)
            document.getElementById('btnResetDefaults').addEventListener('click', resetToDefaults);

            // Daneel backlog button
            document.getElementById('daneelRunBacklog').addEventListener('click', runDaneelBacklog);

            // Event delegation for dynamic lists
            _initDelegatedListeners();

            // Init topbar pills
            if (window.initTopbarPills) window.initTopbarPills();
        });

        // Expose for inline handlers
        window.AgentHub = {
            showDetail: showDetail,
            showHub: showHub,
            switchTab: switchTab,
            togglePermission: togglePermission,
            resetToDefaults: resetToDefaults,
            saveAndrewMismatchConfig: saveAndrewMismatchConfig,
            saveAndrewSmartConfig: saveAndrewSmartConfig,
            runAndrewFollowupCheck: runAndrewFollowupCheck,
            runDaneelFollowupCheck: runDaneelFollowupCheck
        };

    })();
    </script>
</body>
</html>
