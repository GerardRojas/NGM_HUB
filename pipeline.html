<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NGM HUB â€” Pipeline Manager</title>

    <!-- mismas fuentes que login / dashboard -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link 
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" 
      rel="stylesheet"
    >

    <!-- Estilos base + pipeline -->
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/pipeline_styles.css" />
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar con mÃ³dulos dinÃ¡micos -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img 
                    src="assets/img/logo.png" 
                    alt="NGM HUB Logo"
                    class="sidebar-logo-img"
                />
            </div>
            <div class="sidebar-title-block">
                <p class="sidebar-title">NGM HUB</p>
                <p class="sidebar-subtitle">Pipeline Manager</p>
            </div>

            <nav class="sidebar-nav" id="sidebar-nav">
                <!-- MÃ³dulos se inyectan desde JS -->
            </nav>
        </aside>

        <!-- Zona principal -->
        <div class="main-area">
<!-- Topbar igual al dashboard -->
<header class="ngm-topbar">
  <!-- LEFT: brand / contexto -->
  <div class="ngm-bar-left">
    <div class="ngm-brand">
      <div class="ngm-brand-icon-small">
        <span>âš¡</span>
      </div>
      <div class="ngm-brand-text">
        <span class="ngm-brand-org">Next Generation Management</span>
        <span class="ngm-brand-context">NGM Hub Â· Pipeline Manager</span>
      </div>
    </div>
  </div>

  <!-- RIGHT: meta + search + user -->
  <div class="ngm-topbar-right">
    <div class="ngm-meta">
      <span class="ngm-meta-pill ngm-meta-env">Environment Â· Local</span>
      <span class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server Â· 127.0.0.1:8000</span>
    </div>

    <!-- Search bar -->
    <form class="ngm-search" role="search" onsubmit="return false;">
      <span class="ngm-global-search-icon">âŒ•</span>
      <input
        id="pipeline-search-input"
        type="search"
        class="ngm-search-input"
        placeholder="Searchâ€¦"
        aria-label="Search"
      />
    </form>

    <!-- Usuario / rol -->
    <span id="user-pill" class="user-pill">User Â· Role</span>
  </div>
</header>


        <main class="main-content">
            <section class="pipeline-section">

                <!-- âœ… Wrapper interno del pipeline -->
                <div class="pm-panel">

                    <!-- TOOLBAR dividida en 2 cards -->
                    <div class="pm-toolbar-grid">
                        <!-- Card 1: filtros -->
                        <div class="pm-toolbar-card pm-toolbar-card--filters">
                            <div class="pm-toolbar-card-header">
                                <span class="section-title">Filters</span>
                            </div>
                            <div class="pm-toolbar-card-body">
                                <div class="pm-filters">
                                    <label class="filter-label">
                                        Project
                                        <select id="project-filter" class="filter-select">
                                            <option value="all">All</option>
                                        </select>
                                    </label>

                                    <label class="filter-label">
                                        Owner
                                        <select id="owner-filter" class="filter-select">
                                            <option value="all">All</option>
                                        </select>
                                    </label>

                                    <label class="filter-label">
                                        Priority
                                        <select id="priority-filter" class="filter-select">
                                            <option value="all">All</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: layout + manage mode -->
                        <div class="pm-toolbar-card pm-toolbar-card--layout">
                            <div class="pm-toolbar-card-header">
                                <span class="section-title">Layout</span>
                            </div>
                            <div class="pm-toolbar-card-body pm-toolbar-layout-body">
                                <div class="pm-layout-actions">
                                    <button id="btnNewTask" type="button" class="pm-btn pm-btn-secondary btn-small">
                                    <span class="pm-btn-icon">ï¼‹</span>
                                    <span>Manage Tasks</span>
                                    </button>

                                    <button
                                        id="btnManageLayout"
                                        type="button"
                                        class="pm-btn pm-btn-secondary btn-small"
                                    >
                                        <span class="pm-btn-icon">âš™</span>
                                        <span>Manage Layout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wrapper de grupos de pipeline -->
                    <div id="pm-groups-wrapper" class="pm-groups-wrapper">
                        <!-- Groups se renderizan por JS -->
                    </div>

                </div>
            </section>
        </main>
    </div>
</div>

<!-- Modal: Manage layout (estilo global como Estimator) -->
<div id="layoutModal" class="modal-backdrop hidden">

  <div class="modal">

    <div class="modal-header">
      <div class="modal-title">Manage Layout</div>
      <button type="button" class="modal-btn header-action" id="btnCloseLayoutModal">Ã—</button>
    </div>

    <div class="modal-body">

      <!-- Ancho del panel / tabla -->
      <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Panel width</h3>
        <div class="pm-width-options">
          <label class="pm-radio-pill">
            <input type="radio" name="pm-panel-width" value="compact" />
            <span>Compact (80%)</span>
          </label>
          <label class="pm-radio-pill">
            <input type="radio" name="pm-panel-width" value="balanced" />
            <span>Balanced (92%)</span>
          </label>
          <label class="pm-radio-pill">
            <input type="radio" name="pm-panel-width" value="full" />
            <span>Full width (100%)</span>
          </label>
        </div>
      </section>

      <!-- Grupos visibles -->
      <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Visible groups</h3>
        <div class="pm-checkbox-grid">
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="not started" />
            <span>Not Started</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="working on it" />
            <span>Working on It</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="awaiting approval" />
            <span>Awaiting Approval</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="good to go" />
            <span>Good to Go</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="correction" />
            <span>Correction</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="resubmittal needed" />
            <span>Resubmittal needed</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="done" />
            <span>Done</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="delayed" />
            <span>Delayed</span>
          </label>
        </div>
      </section>

      <!-- Columnas visibles -->
      <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Visible columns</h3>
        <div class="pm-checkbox-grid pm-checkbox-grid--columns">
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="task" />
            <span>Task</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="owner" />
            <span>Owner</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="company" />
            <span>Company</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="status" />
            <span>Status</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="start" />
            <span>Start date</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="est" />
            <span>Estimated hours</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-col-key="due" />
            <span>Due / Deadline</span>
          </label>
        </div>
      </section>

    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="btnCancelLayout">Cancel</button>
      <button type="button" class="btn-primary" id="btnApplyLayout">Apply</button>
    </div>

  </div>
</div>


    <script>
            // ================================
            // Sidebar: mÃ³dulos segÃºn accesos
            // ================================
            const sidebarNav = document.getElementById("sidebar-nav");

            const AVAILABLE_MODULES = {
            dashboard: { key: "dashboard", label: "Dashboard", href: "dashboard.html" },
            projects:  { key: "projects",  label: "Projects",  href: "projects.html" },
            pipeline:  { key: "pipeline",  label: "Pipeline",  href: "pipeline.html" },
            estimator: { key: "estimator", label: "Estimator", href: "#" },
            expenses:  { key: "expenses",  label: "Expenses",  href: "#" },
            settings:  { key: "settings",  label: "Settings",  href: "#" },
            };

            // TODO: en producciÃ³n esto vendrÃ¡ del backend segÃºn el rol del usuario
            const USER_MODULES = ["dashboard", "projects", "pipeline", "estimator", "expenses"];

            function initLayoutControls() {
            const modal = document.getElementById("layoutModal");
            const btnOpen = document.getElementById("btnManageLayout");
            if (!modal || !btnOpen) return;

            const btnClose = document.getElementById("btnCloseLayoutModal");
            const btnCancel = document.getElementById("btnCancelLayout");

            // âœ… nuevo backdrop (modal global)
            const backdrop = modal; // ahora el backdrop ES #layoutModal

            const btnApply = document.getElementById("btnApplyLayout");
            // â›” evita que el click dentro del modal cierre el backdrop
            modal.querySelector(".modal")?.addEventListener("click", (e) => {
                e.stopPropagation();
            });

            const DEFAULT_GROUPS = [
                "not started",
                "working on it",
                "awaiting approval",
                "good to go",
                "done",
            ];

            const DEFAULT_COLUMNS = {
                task: true,
                owner: true,
                company: true,
                status: true,
                start: true,
                est: true,
                due: true,
            };

            // âœ… helpers (modal global usa class "hidden")
            const openModal = () => modal.classList.remove("hidden");
            const closeModal = () => modal.classList.add("hidden");

            // Abrir
            btnOpen.addEventListener("click", () => {
                openModal();
                // (tu lÃ³gica actual de cargar defaults / estados va aquÃ­ sin cambios)
            });

            // Cerrar (X / Cancel / backdrop)
            btnClose?.addEventListener("click", closeModal);
            btnCancel?.addEventListener("click", closeModal);
            backdrop?.addEventListener("click", closeModal);

            // Apply (mantÃ©n tu lÃ³gica y luego cierra)
            btnApply?.addEventListener("click", () => {
                // (tu lÃ³gica actual de apply va aquÃ­ sin cambios)
                closeModal();
            });
            }

        function renderSidebarModules(modulesKeys) {
        if (!sidebarNav) return;
        sidebarNav.innerHTML = "";

        modulesKeys.forEach((key) => {
            const mod = AVAILABLE_MODULES[key];
            if (!mod) return;

            const a = document.createElement("a");
            a.href = mod.href;
            a.className = "nav-item" + (key === "pipeline" ? " nav-item-active" : "");

            const labelSpan = document.createElement("span");
            labelSpan.className = "nav-item-label";
            labelSpan.textContent = mod.label;

            a.appendChild(labelSpan);
            sidebarNav.appendChild(a);
        });
        }

        // ================================
        // Pipeline: datos y lÃ³gica de UI
        // ================================

        // ðŸ”§ MODO LOCAL
        const API_BASE = "http://127.0.0.1:8000";

        const groupsWrapper = document.getElementById("pm-groups-wrapper");
        const projectFilter = document.getElementById("project-filter");
        const ownerFilter = document.getElementById("owner-filter");
        const priorityFilter = document.getElementById("priority-filter");
        const manageBtn = document.getElementById("btnNewTask");
        const searchInput = document.getElementById("pipeline-search-input");

        let rawGroups = [];
        let searchQuery = "";
        let manageMode = false;

        async function fetchPipeline() {
            try {
                const res = await fetch(`${API_BASE}/pipeline/grouped`);
                if (!res.ok) throw new Error("Error loading pipeline");
                const data = await res.json();

                console.log("[PIPELINE] raw response:", data);

                rawGroups = Array.isArray(data) ? data : (data.groups || []);
                console.log("[PIPELINE] parsed groups:", rawGroups);

                populateFilters(rawGroups);
                renderGroups();
            } catch (err) {
                console.error("[PIPELINE] fetch error:", err);
                if (groupsWrapper) {
                    groupsWrapper.innerHTML = "<p class='panel-text'>Error loading pipeline data.</p>";
                }
            }
        }

        function populateFilters(groups) {
            const projects = new Set();
            const owners = new Set();
            const priorities = new Set();

            groups.forEach(group => {
                const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                tasks.forEach(t => {
                    // Proyecto: intenta varios campos comunes
                    const projectValue =
                        t.project_name ||
                        t.project ||
                        t.project_title ||
                        t.project_id ||
                        "";

                    if (projectValue) {
                        projects.add(projectValue);
                    }

                    // Owner: intenta varios formatos
                    const ownerValue =
                        (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                        t.owner_name ||
                        t.assigned_to ||
                        "";

                    if (ownerValue) {
                        owners.add(ownerValue);
                    }

                    // Priority: varios nombres posibles
                    const priorityValue =
                        (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                        t.priority_name ||
                        t.priority ||
                        "";

                    if (priorityValue) {
                        priorities.add(priorityValue);
                    }
                });
            });

            function fillSelect(select, values) {
                if (!select) return;
                const current = select.value;
                select.innerHTML = "<option value='all'>All</option>";
                Array.from(values).sort().forEach(v => {
                    const opt = document.createElement("option");
                    opt.value = v.toString();
                    opt.textContent = v.toString();
                    select.appendChild(opt);
                });
                if (Array.from(values).includes(current)) {
                    select.value = current;
                }
            }

            fillSelect(projectFilter, projects);
            fillSelect(ownerFilter, owners);

            const mappedPriorities = new Map();
            Array.from(priorities).forEach(p => {
                mappedPriorities.set(p.toString().toLowerCase(), p);
            });
            const normalized = Array.from(mappedPriorities.entries())
                .sort((a, b) => a[1].toString().localeCompare(b[1].toString()));

            if (priorityFilter) {
                priorityFilter.innerHTML = "<option value='all'>All</option>";
                normalized.forEach(([key, label]) => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = label.toString();
                    priorityFilter.appendChild(opt);
                });
            }
        }

        function applyFilters(groups) {
            const selectedProject = projectFilter ? projectFilter.value : "all";
            const selectedOwner = ownerFilter ? ownerFilter.value : "all";
            const selectedPriority = priorityFilter ? priorityFilter.value : "all";

            return groups.map(group => {
                const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                const filteredTasks = tasks.filter(t => {
                    // Proyecto
                    const pid =
                        t.project_name ||
                        t.project ||
                        t.project_title ||
                        t.project_id ||
                        "";
                    const projectPass =
                        selectedProject === "all" || pid === selectedProject;

                    // Owner
                    const ownerName =
                        (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                        t.owner_name ||
                        t.assigned_to ||
                        "";
                    const ownerPass =
                        selectedOwner === "all" || ownerName === selectedOwner;

                    // Priority
                    const priorityLabel =
                        (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                        t.priority_name ||
                        t.priority ||
                        "";
                    const pKey = priorityLabel.toString().toLowerCase();
                    const priorityPass =
                        selectedPriority === "all" || pKey === selectedPriority;

                    // Search
                    const q = (searchQuery || "").trim().toLowerCase();
                    let searchPass = true;
                    if (q) {
                        const haystack = [
                            t.task_description,
                            t.task_notes,
                            pid,
                            ownerName,
                            priorityLabel,
                        ]
                            .filter(Boolean)
                            .join(" ")
                            .toLowerCase();

                        searchPass = haystack.includes(q);
                    }

                    return projectPass && ownerPass && priorityPass && searchPass;
                });

                return {
                    ...group,
                    tasks: filteredTasks,
                };
            });
        }

        function renderGroups() {
            if (!groupsWrapper) return;

            const groups = applyFilters(rawGroups);
            console.log("[PIPELINE] rendering groups:", groups);

            groupsWrapper.innerHTML = "";

            if (!groups.length) {
                groupsWrapper.innerHTML = "<p class='panel-text'>No pipeline groups to display.</p>";
                return;
            }

            // ðŸŽ¨ Mapa de colores por status / nombre de grupo (lista oficial)
            const STATUS_ACCENTS = {
                "working on it": "#3b82f6",       // azul
                "done": "#22c55e",               // verde
                "correction": "#f87171",         // rojo suave
                "awaiting approval": "#fb923c",  // naranja
                "resubmittal needed": "#eab308", // dorado intenso
                "good to go": "#10b981",         // verde-mint
                "not started": "#facc15",        // amarillo
                "delayed": "#a855f7",            // morado
            };

            // ðŸŽ¨ Mapa de clases CSS por status (para glow + estilos avanzados)
            const STATUS_CLASS_MAP = {
                "working on it": "pm-group--working-on-it",
                "done": "pm-group--done",
                "correction": "pm-group--correction",
                "awaiting approval": "pm-group--awaiting-approval",
                "resubmittal needed": "pm-group--resubmittal-needed",
                "good to go": "pm-group--good-to-go",
                "not started": "pm-group--not-started",
                "delayed": "pm-group--delayed",
            };

            // ðŸ”¢ ORDEN OFICIAL DE STATUS
            const STATUS_ORDER = [
                "not started",
                "working on it",
                "awaiting approval",
                "good to go",
                "correction",
                "resubmittal needed",
                "done",
                "delayed",
            ];
            const STATUS_RANK = {};
            STATUS_ORDER.forEach((name, idx) => {
                STATUS_RANK[name] = idx;
            });

            // Ordenar grupos segÃºn STATUS_ORDER
            const sortedGroups = [...groups].sort((a, b) => {
                const nameA = (
                    a.status_name ||
                    a.group_name ||
                    a.name ||
                    ""
                ).trim().toLowerCase();

                const nameB = (
                    b.status_name ||
                    b.group_name ||
                    b.name ||
                    ""
                ).trim().toLowerCase();

                const rankA = STATUS_RANK[nameA] ?? 999;
                const rankB = STATUS_RANK[nameB] ?? 999;

                if (rankA !== rankB) {
                    return rankA - rankB;
                }
                // fallback alfabÃ©tico si comparten rank
                return nameA.localeCompare(nameB);
            });

            // ==========================
            // RENDER DE CADA GRUPO
            // ==========================
            sortedGroups.forEach(group => {
                // Nunca filtramos el grupo aunque no tenga tasks
                const tasks =
                    Array.isArray(group.tasks) ? group.tasks :
                    Array.isArray(group.items) ? group.items :
                    Array.isArray(group.tasks_list) ? group.tasks_list :
                    [];

                const groupName =
                    group.status_name ||
                    group.group_name ||
                    group.name ||
                    "Group";

                const groupElem = document.createElement("div");
                groupElem.className = "pm-group";

                // Normalizar clave para status / color / clase
                const statusRaw = groupName.trim();
                const statusKey = statusRaw.toLowerCase();

                // ðŸŽ¨ Asignar clase CSS segÃºn status oficial
                const cssClass = STATUS_CLASS_MAP[statusKey];
                if (cssClass) {
                    groupElem.classList.add(cssClass);
                }

                // ðŸŽ¨ Color del grupo (lÃ­nea + glow)
                const accentColor = STATUS_ACCENTS[statusKey] || "#3e4042";
                groupElem.style.setProperty("--pm-group-accent", accentColor);

                // ==========================
                // HEADER
                // ==========================
                const header = document.createElement("div");
                header.className = "pm-group-header";
                header.innerHTML = `
                    <h3 class="section-title" style="color:${accentColor};">
                        ${groupName}
                    </h3>
                    <span class="ngm-pill"><span class="ngm-pill-value">${tasks.length} tasks</span></span>
                `;

                const body = document.createElement("div");
                body.className = "pm-group-body";

                // ðŸ”½ estado inicial: expandido
                let isCollapsed = false;
                header.addEventListener("click", () => {
                    isCollapsed = !isCollapsed;
                    body.style.display = isCollapsed ? "none" : "";
                    header.classList.toggle("pm-group-header--collapsed", isCollapsed);
                });

                // ==========================
                // TABLA
                // ==========================
                const table = document.createElement("table");
                table.className = "table";

                const thead = document.createElement("thead");
                thead.innerHTML = `
                    <tr>
                        <th>Task</th>
                        <th>Project</th>
                        <th>Owner</th>
                        <th>Collaborator</th>
                        <th>Manager</th>
                        <th>Company</th>
                        <th>Start</th>
                        <th>Est (h)</th>
                        <th>Priority</th>
                        <th>Finished</th>
                        <th>Due</th>
                        <th>Links</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement("tbody");

                if (!tasks.length) {
                    // Grupo SIN tareas â†’ tabla con fila placeholder
                    const emptyRow = document.createElement("tr");
                    emptyRow.className = "pm-empty-row";
                    emptyRow.innerHTML = `
                        <td colspan="12" class="pm-empty-cell">
                            <div>No tasks in this group for the current filters.</div>
                        </td>
                    `;
                    tbody.appendChild(emptyRow);
                } else {
                    // Grupo CON tareas â†’ filas normales
                    tasks.forEach(t => {
                        const tr = document.createElement("tr");
                        tr.className = "pm-row";
                        if (manageMode) {
                            tr.classList.add("pm-row-manage");
                        }

                        // ======================
                        // CAMPOS PARA MOSTRAR EN TABLA
                        // ======================
                        const desc =
                            t.task_description || t.title || "(No description)";

                        const proj =
                            t.project_name ||
                            t.project ||
                            t.project_title ||
                            t.project_id ||
                            "-";

                        const owner =
                            (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                            t.owner_name ||
                            t.assigned_to ||
                            "-";

                        const collaborator =
                            (Array.isArray(t.collaborators) &&
                            t.collaborators.length > 0 &&
                            (t.collaborators[0].name || t.collaborators[0].id)) ||
                            "-";

                        const manager =
                            (t.manager_obj && (t.manager_obj.name || t.manager_obj.id)) ||
                            "-";

                        const company =
                            t.company_name || "-";

                        const startDate = t.start_date || null;
                        const startDisplay = startDate || "-";

                        const estimatedHours = (typeof t.estimated_hours === "number")
                            ? t.estimated_hours
                            : (t.estimated_hours ?? null);
                        const estDisplay = (estimatedHours != null) ? estimatedHours : "-";

                        const pri =
                            (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                            t.priority_name ||
                            t.priority ||
                            "-";

                        const finished =
                            (t.finished_status &&
                                (t.finished_status.completed_status_name ||
                                t.finished_status.completed_status_id)) ||
                            "-";

                        const due = t.due_date || t.due || t.deadline || "-";

                        const docsLink = t.docs_link || null;
                        const resultLink = t.result_link || null;

                        let linksHtml = "-";
                        if (docsLink || resultLink) {
                            const parts = [];
                            if (docsLink) {
                                parts.push(`<a href="${docsLink}" target="_blank" rel="noopener noreferrer">Docs</a>`);
                            }
                            if (resultLink) {
                                parts.push(`<a href="${resultLink}" target="_blank" rel="noopener noreferrer">Result</a>`);
                            }
                            linksHtml = parts.join(" Â· ");
                        }

                        // ======================
                        // IDS Y EXTRA PARA MODALES / LÃ“GICA FUTURA
                        // ======================
                        const taskId = t.task_id || null;
                        const taskNotes = t.task_notes || null;
                        const companyManagement = t.company_management || null;

                        const priorityId =
                            (t.priority && t.priority.priority_id) ||
                            t.task_priority ||
                            null;

                        const finishedStatusId =
                            (t.finished_status && t.finished_status.completed_status_id) ||
                            t.task_finished_status ||
                            null;

                        // ======================
                        // PINTAR CELDAS VISIBLES
                        // ======================
                        tr.innerHTML = `
                            <td class="pm-row"><div>${desc}</div></td>
                            <td class="pm-row"><div>${proj}</div></td>
                            <td class="pm-row"><div>${owner}</div></td>
                            <td class="pm-row"><div>${collaborator}</div></td>
                            <td class="pm-row"><div>${manager}</div></td>
                            <td class="pm-row"><div>${company}</div></td>
                            <td class="pm-row"><div>${startDisplay}</div></td>
                            <td class="pm-row"><div>${estDisplay}</div></td>
                            <td class="pm-row"><div>${pri}</div></td>
                            <td class="pm-row"><div>${finished}</div></td>
                            <td class="pm-row"><div>${due}</div></td>
                            <td class="pm-row"><div>${linksHtml}</div></td>
                        `;

                        // ======================
                        // GUARDAR DATA EXTRA EN EL <tr> PARA MODAL / TOGGLE DE COLUMNAS
                        // ======================
                        if (taskId) tr.dataset.taskId = String(taskId);
                        if (startDate) tr.dataset.startDate = String(startDate);
                        if (estimatedHours != null) tr.dataset.estimatedHours = String(estimatedHours);
                        if (taskNotes) tr.dataset.taskNotes = String(taskNotes);
                        if (docsLink) tr.dataset.docsLink = String(docsLink);
                        if (resultLink) tr.dataset.resultLink = String(resultLink);
                        if (companyManagement) tr.dataset.companyManagement = String(companyManagement);
                        if (priorityId) tr.dataset.priorityId = String(priorityId);
                        if (finishedStatusId) tr.dataset.finishedStatusId = String(finishedStatusId);

                        tbody.appendChild(tr);
                    });
                }

                table.appendChild(tbody);
                body.appendChild(table);

                groupElem.appendChild(header);
                groupElem.appendChild(body);
                groupsWrapper.appendChild(groupElem);
            });
        }

        // ================================
        // Eventos de UI
        // ================================
        if (projectFilter) projectFilter.addEventListener("change", renderGroups);
        if (ownerFilter) ownerFilter.addEventListener("change", renderGroups);
        if (priorityFilter) priorityFilter.addEventListener("change", renderGroups);

        // (por ahora dejamos este manejador como estÃ¡;
        // luego lo cambiamos cuando convirtamos el botÃ³n a "New task" + modal)
        if (manageBtn) {
            manageBtn.addEventListener("click", () => {
                manageMode = !manageMode;
                manageBtn.classList.toggle("is-active", manageMode);
                manageBtn.querySelector("span:last-child").textContent = manageMode ? "Done managing" : "Manage Tasks";
                renderGroups();
            });
        }

        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderGroups();
            });
        }

        // ðŸ”¥ Ya NO usamos slider de ancho, asÃ­ que este bloque se puede eliminar.
        // Lo quito para que no haya cÃ³digo muerto.

        // ================================
        // Init global
        // ================================
        window.addEventListener("DOMContentLoaded", () => {
            // Sidebar + topbar
            renderSidebarModules(USER_MODULES);

            try {
            if (typeof initTopbarUserPill === "function") {
                initTopbarUserPill();
            }
            } catch (err) {
            console.warn("[TOPBAR] initTopbarUserPill failed:", err);
            }

            // Pipeline (datos + render)
            // si tu lÃ³gica usa fetchPipeline directamente, dÃ©jalo asÃ­:
            if (typeof fetchPipeline === "function") {
            fetchPipeline();
            }
            // o si lo tienes empaquetado en initPipeline, usa esa:
            // initPipeline?.();

            // Modal de Manage layout
            initLayoutControls();
        });

    </script>
</body>
</html>
