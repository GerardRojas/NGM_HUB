<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="NGM Hub" />
    <title>NGM Hub</title>
    <link rel="icon" type="image/png" href="assets/img/greenblack_icon_192.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="assets/img/greenblack_icon_192.png" />

    <!-- Fuentes Inter + Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link 
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" 
      rel="stylesheet"
    >

    <!-- 1) Estilos base compartidos (layout, sidebar, inputs, botones genéricos) -->
    <link rel="stylesheet" href="assets/css/styles.css" />
    <!-- 2) Estilos específicos de login (degradado, panel, loading, mensajes) -->
    <link rel="stylesheet" href="assets/css/login.css" />

    <!-- Early redirect: Check for valid session BEFORE page renders -->
    <script>
      (function() {
        'use strict';

        // Quick token validation
        function isTokenValid(token) {
          if (!token) return false;
          try {
            var parts = token.split('.');
            if (parts.length !== 3) return false;
            var payload = JSON.parse(atob(parts[1]));
            if (payload.exp && Date.now() >= payload.exp * 1000) return false;
            return true;
          } catch (e) {
            return false;
          }
        }

        var token = localStorage.getItem('ngmToken');
        var user = localStorage.getItem('ngmUser');

        // If valid session exists, redirect directly to target page
        if (token && user && isTokenValid(token)) {
          // Get saved redirect target or default to dashboard
          var saved = sessionStorage.getItem('loginRedirect');
          var target = (saved && saved !== 'login.html' && saved !== 'index.html') ? saved : 'dashboard.html';
          if (saved) sessionStorage.removeItem('loginRedirect');
          window.location.replace(target);
        }
      })();
    </script>
</head>
<body class="login-page">
    <main class="login-screen">
        <div class="login-panel">
            <!-- Logo + branding -->
            <div class="logo-block">
                <img 
                    src="assets/img/logo.png"
                    alt="NGM HUB Logo" 
                    class="logo-img"
                    onerror="this.style.display='none'"
                />
            </div>

            <!-- Formulario de acceso -->
            <form id="loginForm" class="login-form">
                <div class="field">
                    <label class="field-label" for="user">User</label>
                    <input 
                        id="user"
                        type="text" 
                        placeholder="your.user" 
                        class="input"
                        required
                    >
                </div>

                <div class="field">
                    <label class="field-label" for="password">Password</label>
                    <input 
                        id="password"
                        type="password" 
                        placeholder="••••••••" 
                        class="input"
                        required
                    >
                </div>

                <div class="form-footer">
                    <button type="submit" class="btn-primary" id="loginButton">
                        <span class="btn-primary__inner">
                            <span class="btn-primary__label">Sign in</span>
                            <!-- Loading logo - controlado por JS con la clase .btn-primary--loading -->
                            <img src="assets/img/white_icon.png" class="btn-primary__spinner" alt="" aria-hidden="true" />
                        </span>
                    </button>
                </div>
            </form>

            <!-- Mensaje de estado (error, etc.) -->
            <p id="loginMessage" class="auth-message" aria-live="polite"></p>

            <p class="brand-subtitle">
                Data-Driven Management Platform
            </p>            

            <div class="footer-block">
                <p class="legal-text">
                    NGM HUB © <span id="year"></span> · Internal Access Only
                </p>
                <button class="support-link" type="button">
                    Support
                </button>
            </div>
        </div>
    </main>

    <!-- Transition Loading Overlay (shown after successful login) -->
    <div class="login-transition-overlay" id="loginTransitionOverlay">
        <img src="assets/img/white_icon.png" class="transition-logo" alt="Loading...">
        <span class="transition-text">Loading...</span>
    </div>

    <!-- ============================
         CONFIG + LOGIN SCRIPT
         ============================ -->
    <!-- 1) Config primero (ruta correcta) -->
    <script src="assets/js/config.js"></script>
    <!-- 2) Luego la lógica de login (maneja loading y mensajes) -->
    <script src="assets/js/login.js"></script>

    <script>
      // Año automático en el footer
      document.getElementById("year").textContent = new Date().getFullYear();

      // iOS Keyboard handling
      (function() {
        // Detect iOS
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        if (!isIOS) return;

        var loginPanel = document.querySelector('.login-panel');
        var inputs = document.querySelectorAll('.input');

        if (!loginPanel || !inputs.length) return;

        // Use visualViewport API for keyboard detection
        if (window.visualViewport) {
          var initialHeight = window.visualViewport.height;
          var keyboardVisible = false;

          window.visualViewport.addEventListener('resize', function() {
            var currentHeight = window.visualViewport.height;
            var heightDiff = initialHeight - currentHeight;

            if (heightDiff > 150 && !keyboardVisible) {
              keyboardVisible = true;
              document.body.classList.add('keyboard-open');
            } else if (heightDiff < 150 && keyboardVisible) {
              keyboardVisible = false;
              document.body.classList.remove('keyboard-open');
            }
          });

          window.addEventListener('orientationchange', function() {
            setTimeout(function() {
              initialHeight = window.visualViewport.height;
            }, 500);
          });
        }

        // Scroll input into view when focused
        inputs.forEach(function(input) {
          input.addEventListener('focus', function() {
            var self = this;
            setTimeout(function() {
              self.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
          });
        });
      })();
    </script>
</body>
</html>
