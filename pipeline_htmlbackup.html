<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =======================================
       01 — META & TITLE
       ======================================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGM HUB — Pipeline Manager</title>

  <!-- =======================================
       02 — FONTS
       ======================================= -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" 
    rel="stylesheet"
  >

  <!-- =======================================
       03 — CSS GLOBAL + PIPELINE
       ======================================= -->
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/pipeline_styles.css" />
</head>
<body>
  <div class="app-layout">
    
    <!-- =======================================
         04 — SIDEBAR
         ======================================= -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="assets/img/logo.png" class="sidebar-logo-img" />
      </div>

      <div class="sidebar-title-block">
        <p class="sidebar-title">NGM HUB</p>
        <p class="sidebar-subtitle">Pipeline Manager</p>
      </div>

      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">Overview</a>
        <a href="expenses.html" class="nav-item">Expenses</a>
        <a href="projects.html" class="nav-item">Projects</a>
        <a href="pipeline.html" class="nav-item nav-item-active">Pipeline</a>
        <a href="estimator.html" class="nav-item">Estimator</a>
      </nav>
    </aside>

    <!-- =======================================
         05 — MAIN AREA (TOPBAR + CONTENT)
         ======================================= -->
    <div class="main-area">

      <!-- 05.1 TOPBAR -->
      <header class="topbar">
        <div class="topbar-left">
          <h1 class="topbar-title">Pipeline Manager</h1>
          <p class="topbar-subtitle">Centralized control of tasks & status</p>
        </div>
        <div class="topbar-right">
          <span class="user-pill">Master User</span>
        </div>
      </header>

      <!-- 05.2 CONTENIDO PRINCIPAL -->
      <main class="main-content">

        <!-- =======================================
             06 — TOOLBAR (FILTROS + COLUMNS + GROUPS + SLIDER)
             ======================================= -->
        <section class="data-section">
          <div class="pm-toolbar-surface">
            <div class="pm-toolbar-row">
              
              <!-- 06.1 IZQUIERDA: Filters / Columns / Groups -->
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                
                <!-- Dropdown de filtros -->
                <div style="position: relative;">
                  <button id="pm-filters-toggle" class="btn-secondary" style="font-size: 12px; padding: 6px 10px;">
                    Filters ▾
                  </button>
                  <div 
                    id="pm-filters-panel" 
                    class="panel" 
                    style="
                      position: absolute;
                      left: 0;
                      top: 110%;
                      min-width: 260px;
                      padding: 10px;
                      z-index: 20;
                      display: none;
                    "
                  >
                    <div style="display:flex; flex-direction:column; gap:8px;">
                      <div>
                        <label class="field-label" style="font-size:11px;">Project</label>
                        <select id="pm-filter-project" class="input" style="padding: 6px 10px; font-size: 12px; width: 100%;">
                          <option value="all">All projects</option>
                        </select>
                      </div>

                      <div>
                        <label class="field-label" style="font-size:11px;">Owner</label>
                        <select id="pm-filter-owner" class="input" style="padding: 6px 10px; font-size: 12px; width: 100%;">
                          <option value="all">All owners</option>
                        </select>
                      </div>

                      <div>
                        <label class="field-label" style="font-size:11px;">Priority</label>
                        <select id="pm-filter-priority" class="input" style="padding: 6px 10px; font-size: 12px; width: 100%;">
                          <option value="all">All priorities</option>
                        </select>
                      </div>

                      <div style="display:flex; justify-content:space-between; margin-top:4px;">
                        <span class="table-cell-muted" style="font-size:11px;">Grouped by <strong>Status</strong></span>
                        <button 
                          id="pm-filters-reset" 
                          class="btn-secondary" 
                          style="font-size: 11px; padding: 4px 8px;"
                        >
                          Reset
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dropdown de columnas -->
                <div style="position: relative;">
                  <button id="pm-columns-toggle" class="btn-secondary" style="font-size: 12px; padding: 6px 10px;">
                    Columns ▾
                  </button>
                  <div 
                    id="pm-columns-panel" 
                    class="panel" 
                    style="
                      position: absolute;
                      right: 0;
                      top: 110%;
                      min-width: 220px;
                      padding: 10px;
                      z-index: 20;
                      display: none;
                    "
                  >
                    <!-- JS inyecta checkboxes aquí -->
                  </div>
                </div>

                <!-- Dropdown de grupos -->
                <div style="position: relative;">
                  <button id="pm-groups-toggle" class="btn-secondary" style="font-size: 12px; padding: 6px 10px;">
                    Groups ▾
                  </button>
                  <div 
                    id="pm-groups-panel" 
                    class="panel" 
                    style="
                      position: absolute;
                      left: 0;
                      top: 110%;
                      min-width: 220px;
                      padding: 10px;
                      z-index: 20;
                      display: none;
                    "
                  >
                    <!-- JS inyecta grupos aquí -->
                  </div>
                </div>
              </div>

              <!-- 06.2 DERECHA: Slider ancho + Group info + Manage -->
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end;">
                
                <!-- Slider de ancho -->
                <div class="pm-width-control">
                  <span class="pm-width-control-label">Table width</span>
                  <input
                    id="pm-width-slider"
                    type="range"
                    min="70"
                    max="100"
                    value="92"
                    class="pm-width-slider"
                  />
                  <span id="pm-width-value" class="pm-width-control-value">92%</span>
                </div>

                <!-- Texto Grouped by / Manage -->
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span class="table-cell-muted" style="font-size: 12px;">
                    Grouped by <strong>Status</strong>
                  </span>
                  <button id="pm-manage-toggle" class="btn-secondary" style="font-size: 12px; padding: 6px 10px;">
                    Manage tasks
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- =======================================
             07 — CONTENEDOR DE GRUPOS
             (se rellena desde la API / JS)
             ======================================= -->
        <section class="data-section" id="pm-groups-container">
          <div class="pm-groups-wrapper">
            <div class="pm-group">
              <p class="panel-text">Loading pipeline...</p>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- =======================================
       08 — SCRIPT PRINCIPAL PIPELINE
       ======================================= -->
  <script>
    // =============================
    // 08.1 CONFIG BÁSICA / REF DOM
    // =============================
    const API_BASE = "http://127.0.0.1:8000"; // mismo que en projects
    const groupsContainer = document.getElementById("pm-groups-container");

    const filtersToggleBtn = document.getElementById("pm-filters-toggle");
    const filtersPanel = document.getElementById("pm-filters-panel");
    const projectFilter = document.getElementById("pm-filter-project");
    const ownerFilter = document.getElementById("pm-filter-owner");
    const priorityFilter = document.getElementById("pm-filter-priority");
    const filtersResetBtn = document.getElementById("pm-filters-reset");

    const columnsToggleBtn = document.getElementById("pm-columns-toggle");
    const columnsPanel = document.getElementById("pm-columns-panel");

    const groupsToggleBtn = document.getElementById("pm-groups-toggle");
    const groupsPanel = document.getElementById("pm-groups-panel");

    const manageToggleBtn = document.getElementById("pm-manage-toggle");

    const widthSlider = document.getElementById("pm-width-slider");
    const widthValueLabel = document.getElementById("pm-width-value");

    let originalGroups = [];
    let manageMode = false;

    // Orden deseado de grupos (por Status)
    const STATUS_ORDER = [
      "not started",
      "to do",
      "todo",
      "backlog",
      "working on it",
      "in progress",
      "progress",
      "correction",
      "resubmittal",
      "re-submittal",
      "awaiting approval",
      "waiting approval",
      "delayed",
      "on hold",
      "hold",
      "done",
      "completed",
    ];

    // Grupos que deben estar ON por defecto
    const DEFAULT_ON_GROUPS = [
      "not started",
      "working on it",
      "awaiting approval",
      "done",
    ];

    // Columnas visibles (Task la dejamos siempre)
    const columnVisibility = {
      owner: true,
      collaborators: true,
      manager: true,
      status: false,
      priority: true,
      arrival: true,
      start: true,
      due: true,
      deadline: true,
      finished: false,
      hours: true,
    };

    const columnsConfig = [
      { key: "owner", label: "Owner" },
      { key: "collaborators", label: "Collaborators" },
      { key: "manager", label: "Manager" },
      { key: "status", label: "Status" },
      { key: "priority", label: "Priority" },
      { key: "arrival", label: "Arrival date" },
      { key: "start", label: "Start date" },
      { key: "due", label: "Due date" },
      { key: "deadline", label: "Deadline" },
      { key: "finished", label: "Finished" },
      { key: "hours", label: "Est. hours" },
    ];

    // Visibilidad de grupos (por status_id o nombre)
    const groupVisibility = {};

    // =============================
    // 08.2 SLIDER DE ANCHO (sin parpadeo)
    // =============================
    function applyPanelWidth(value) {
      const raw = Number(value) || 90;
      const clamped = Math.min(100, Math.max(70, raw)); // rango 70–100%
      document.documentElement.style.setProperty("--pm-panel-width", clamped + "%");
      if (widthValueLabel) {
        widthValueLabel.textContent = clamped + "%";
      }
    }

    if (widthSlider) {
      applyPanelWidth(widthSlider.value || 92);
      widthSlider.addEventListener("input", (e) => {
        applyPanelWidth(e.target.value);
      });
    }

    // =============================
    // 08.3 HELPERS DE CELDAS (owner, priority, etc.)
    // =============================
    function renderOwnerCell(owner) {
      if (!owner || (!owner.name && !owner.id)) {
        return '<span class="table-cell-muted">-</span>';
      }
      const initials = (owner.name || owner.id || "?")
        .split(" ")
        .map(p => p[0])
        .join("")
        .substring(0, 2)
        .toUpperCase();

      return `
        <div style="display: flex; align-items: center; gap: 6px;">
          <div 
            style="
              width: 22px; 
              height: 22px; 
              border-radius: 999px; 
              background: #2974ff; 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              font-size: 11px;
            "
          >
            ${initials}
          </div>
          <span style="font-size: 12px;">${owner.name || owner.id}</span>
        </div>
      `;
    }

    function renderCollaboratorsCell(collaborators) {
      if (!Array.isArray(collaborators) || collaborators.length === 0) {
        return '<span class="table-cell-muted">-</span>';
      }

      const first = collaborators[0];
      const initials = (first.name || first.id || "?")
        .split(" ")
        .map(p => p[0])
        .join("")
        .substring(0, 2)
        .toUpperCase();

      const extraCount = collaborators.length - 1;
      const extraLabel = extraCount > 0
        ? `<span class="table-cell-muted" style="font-size: 10px;">+${extraCount}</span>`
        : "";

      return `
        <div style="display: flex; align-items: center; gap: 6px;">
          <div 
            style="
              width: 22px; 
              height: 22px; 
              border-radius: 999px; 
              background: #111827; 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              font-size: 11px;
            "
          >
            ${initials}
          </div>
          <span style="font-size: 12px;">${first.name || first.id}</span>
          ${extraLabel}
        </div>
      `;
    }

    function renderManagerCell(manager) {
      if (!manager || (!manager.name && !manager.id)) {
        return '<span class="table-cell-muted">-</span>';
      }
      const initials = (manager.name || manager.id || "?")
        .split(" ")
        .map(p => p[0])
        .join("")
        .substring(0, 2)
        .toUpperCase();

      return `
        <div style="display: flex; align-items: center; gap: 6px;">
          <div 
            style="
              width: 22px; 
              height: 22px; 
              border-radius: 999px; 
              background: #0f172a; 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              font-size: 11px;
              border: 1px solid #4b5563;
            "
          >
            ${initials}
          </div>
          <span style="font-size: 12px;">${manager.name || manager.id}</span>
        </div>
      `;
    }

    function renderPriority(priority) {
      const name = priority?.priority_name || priority?.priority_id || "-";
      const normalized = (name || "").toString().toLowerCase();

      let bg = "#111827";
      let border = "#1f2937";

      if (normalized.includes("critical")) {
        bg = "#450a0a";
        border = "#ef4444";
      } else if (normalized.includes("high")) {
        bg = "#7f1d1d";
        border = "#b91c1c";
      } else if (normalized.includes("medium")) {
        bg = "#78350f";
        border = "#d97706";
      } else if (normalized.includes("low")) {
        bg = "#064e3b";
        border = "#16a34a";
      }

      return `
        <span class="status-pill" style="background:${bg}; border-color:${border}; font-size: 11px; padding: 2px 8px;">
          ${name}
        </span>
      `;
    }

    function renderFinishedStatus(finished) {
      const name = finished?.completed_status_name || finished?.completed_status_id || "-";
      const normalized = (name || "").toString().toLowerCase();

      let bg = "#111827";
      let border = "#1f2937";

      if (normalized.includes("done") || normalized.includes("completed")) {
        bg = "#064e3b";
        border = "#16a34a";
      } else if (normalized.includes("stuck") || normalized.includes("blocked")) {
        bg = "#7f1d1d";
        border = "#b91c1c";
      } else if (normalized.includes("working") || normalized.includes("progress")) {
        bg = "#1e3a8a";
        border = "#2563eb";
      } else if (normalized.includes("on hold") || normalized.includes("hold")) {
        bg = "#7c2d12";
        border = "#ea580c";
      }

      return `
        <span class="status-pill" style="background:${bg}; border-color:${border}; font-size: 11px; padding: 2px 8px;">
          ${name}
        </span>
      `;
    }

    function formatDate(isoString) {
      if (!isoString) return "";
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return isoString;
      const options = { month: "short", day: "2-digit", year: "numeric" };
      return d.toLocaleDateString("en-US", options);
    }

    function renderStatusCell(statusName) {
      const style = getStatusStyle(statusName);
      return `
        <span 
          class="status-pill" 
          style="
            background: rgba(15,23,42,0.7);
            border-color: ${style.borderColor};
            color: ${style.titleColor};
            font-size: 11px; 
            padding: 2px 8px;
          "
        >
          ${statusName}
        </span>
      `;
    }

    function renderTaskRow(task, groupStatusName) {
      const title = task.task_description || "(no description)";
      const notes = task.task_notes || "";

      const ownerHtml = renderOwnerCell(task.owner);
      const collaboratorsHtml = renderCollaboratorsCell(task.collaborators);
      const managerHtml = renderManagerCell(task.manager_obj);

      const statusName = groupStatusName || task.status_name || "";
      const statusHtml = renderStatusCell(statusName);

      const priorityHtml = renderPriority(task.priority);
      const finishedHtml = renderFinishedStatus(task.finished_status);

      const arrival = formatDate(task.created_at);
      const start = formatDate(task.start_date);
      const due = formatDate(task.due_date);
      const deadline = formatDate(task.deadline);
      const estHours = task.estimated_hours != null ? `${task.estimated_hours} h` : "-";

      const rowClass = manageMode ? "pm-row pm-row-manage" : "pm-row";
      const boxStyle = manageMode
        ? "background:#020617;border-radius:6px;border:1px dashed #4b5563;padding:4px 6px;"
        : "";

      return `
        <tr class="${rowClass}" data-task-id="${task.task_id || ""}" data-status-name="${statusName}">
          <td>
            <div style="${boxStyle}">
              <div style="font-weight: 500; font-size: 13px;">${title}</div>
              ${
                notes
                  ? `<div class="table-cell-muted" style="font-size: 11px; margin-top: 2px;">${notes}</div>`
                  : ""
              }
            </div>
          </td>
          <td data-col-key="owner" style="${columnVisibility.owner ? "" : "display:none;"}">
            <div style="${boxStyle}">${ownerHtml}</div>
          </td>
          <td data-col-key="collaborators" style="${columnVisibility.collaborators ? "" : "display:none;"}">
            <div style="${boxStyle}">${collaboratorsHtml}</div>
          </td>
          <td data-col-key="manager" style="${columnVisibility.manager ? "" : "display:none;"}">
            <div style="${boxStyle}">${managerHtml}</div>
          </td>
          <td data-col-key="status" style="${columnVisibility.status ? "" : "display:none;"}">
            <div style="${boxStyle}">${statusHtml}</div>
          </td>
          <td data-col-key="priority" style="${columnVisibility.priority ? "" : "display:none;"}">
            <div style="${boxStyle}">${priorityHtml}</div>
          </td>
          <td data-col-key="arrival" style="${columnVisibility.arrival ? "" : "display:none;"}">
            <div style="${boxStyle}">${arrival || "-"}</div>
          </td>
          <td data-col-key="start" style="${columnVisibility.start ? "" : "display:none;"}">
            <div style="${boxStyle}">${start || "-"}</div>
          </td>
          <td data-col-key="due" style="${columnVisibility.due ? "" : "display:none;"}">
            <div style="${boxStyle}">${due || "-"}</div>
          </td>
          <td data-col-key="deadline" style="${columnVisibility.deadline ? "" : "display:none;"}">
            <div style="${boxStyle}">${deadline || "-"}</div>
          </td>
          <td data-col-key="finished" style="${columnVisibility.finished ? "" : "display:none;"}">
            <div style="${boxStyle}">${finishedHtml}</div>
          </td>
          <td data-col-key="hours" style="${columnVisibility.hours ? "" : "display:none;"}">
            <div style="${boxStyle}">${estHours}</div>
          </td>
        </tr>
      `;
    }

    // =============================
    // 08.4 COLORES DE GRUPOS (Status)
    // =============================
    function getStatusStyle(statusName) {
      const norm = (statusName || "").toLowerCase();

      if (norm.includes("not started") || norm.includes("backlog") || norm === "todo" || norm.includes("to do")) {
        return {
          borderColor: "#eab308",   // yellow
          titleColor: "#fef9c3",
          dotColor: "#facc15",
        };
      }
      if (norm.includes("working on it") || norm.includes("in progress") || norm === "progress") {
        return {
          borderColor: "#2563eb",   // blue
          titleColor: "#bfdbfe",
          dotColor: "#3b82f6",
        };
      }
      if (norm.includes("correction") || norm.includes("fix") || norm.includes("changes")) {
        return {
          borderColor: "#7c3aed",   // purple
          titleColor: "#ede9fe",
          dotColor: "#a855f7",
        };
      }
      if (norm.includes("resubmittal") || norm.includes("re-submittal") || norm.includes("resubmit")) {
        return {
          borderColor: "#0d9488",   // teal
          titleColor: "#ccfbf1",
          dotColor: "#14b8a6",
        };
      }
      if (norm.includes("awaiting approval") || norm.includes("waiting approval") || norm.includes("approval")) {
        return {
          borderColor: "#f97316",   // orange
          titleColor: "#fed7aa",
          dotColor: "#fb923c",
        };
      }
      if (norm.includes("delayed") || norm.includes("delay")) {
        return {
          borderColor: "#b91c1c",   // red
          titleColor: "#fecaca",
          dotColor: "#ef4444",
        };
      }
      if (norm.includes("on hold") || norm.includes("hold")) {
        return {
          borderColor: "#78350f",   // brownish
          titleColor: "#fef3c7",
          dotColor: "#d97706",
        };
      }
      if (norm.includes("done") || norm.includes("completed")) {
        return {
          borderColor: "#16a34a",   // green
          titleColor: "#bbf7d0",
          dotColor: "#22c55e",
        };
      }

      // Default / otros
      return {
        borderColor: "#4b5563",
        titleColor: "#e5e7eb",
        dotColor: "#9ca3af",
      };
    }

    function renderGroupPanel(group) {
      const statusName = group.status_name || "(no status)";
      const tasks = Array.isArray(group.tasks) ? group.tasks : [];
      const style = getStatusStyle(statusName);
      const groupId = group.status_id || statusName;

      const rowsHtml = tasks.length
        ? tasks.map(t => renderTaskRow(t, statusName)).join("")
        : `
          <tr>
            <td colspan="12" class="table-cell-muted">
              No tasks in this group.
            </td>
          </tr>
        `;

      const addRowHtml = `
        <tr class="pm-add-row">
          <td colspan="12">
            <button 
              class="btn-secondary" 
              data-add-task-for-status="${group.status_id}" 
              style="
                font-size: 12px; 
                padding: 5px 10px; 
                display: inline-flex; 
                align-items: center; 
                gap: 6px;
                background: transparent;
                border-style: dashed;
                border-color: #4b5563;
              "
            >
              <span 
                style="
                  width: 18px;
                  height: 18px;
                  border-radius: 999px;
                  border: 1px dashed #6b7280;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 13px;
                "
              >+</span>
              <span class="table-cell-muted">Add task to ${statusName}</span>
            </button>
          </td>
        </tr>
      `;

      return `
        <div 
          class="pm-group" 
          data-status-id="${group.status_id}" 
          style="--pm-group-accent: ${style.borderColor};"
        >
          <div 
            class="pm-group-header" 
            data-group-id="${groupId}"
          >
            <span 
              class="pm-group-toggle-icon" 
              style="font-size: 16px; color: #9ca3af;"
            >▾</span>
            <div>
              <h2 
                class="section-title" 
                style="margin-bottom: 2px; font-size: 13px; color: ${style.titleColor};"
              >
                <span 
                  style="
                    width: 8px;
                    height: 8px;
                    border-radius: 999px;
                    background: ${style.dotColor};
                    display: inline-block;
                    margin-right: 6px;
                  "
                ></span>
                ${statusName}
              </h2>
              <p class="panel-text" style="font-size: 11px;">${tasks.length} tasks</p>
            </div>
          </div>

          <div class="pm-group-body" data-group-id="${groupId}">
            <table class="table">
              <thead>
                <tr>
                  <th style="width: 18%;">Task</th>
                  <th data-col-key="owner" style="width: 12%; ${columnVisibility.owner ? "" : "display:none;"}">Owner</th>
                  <th data-col-key="collaborators" style="width: 12%; ${columnVisibility.collaborators ? "" : "display:none;"}">Collaborators</th>
                  <th data-col-key="manager" style="width: 12%; ${columnVisibility.manager ? "" : "display:none;"}">Manager</th>
                  <th data-col-key="status" style="width: 8%; ${columnVisibility.status ? "" : "display:none;"}">Status</th>
                  <th data-col-key="priority" style="width: 8%; ${columnVisibility.priority ? "" : "display:none;"}">Priority</th>
                  <th data-col-key="arrival" style="width: 8%; ${columnVisibility.arrival ? "" : "display:none;"}">Arrival</th>
                  <th data-col-key="start" style="width: 8%; ${columnVisibility.start ? "" : "display:none;"}">Start</th>
                  <th data-col-key="due" style="width: 8%; ${columnVisibility.due ? "" : "display:none;"}">Due</th>
                  <th data-col-key="deadline" style="width: 8%; ${columnVisibility.deadline ? "" : "display:none;"}">Deadline</th>
                  <th data-col-key="finished" style="width: 6%; ${columnVisibility.finished ? "" : "display:none;"}">Finished</th>
                  <th data-col-key="hours" style="width: 6%; ${columnVisibility.hours ? "" : "display:none;"}">Est. hours</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
                ${addRowHtml}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // =============================
    // 08.5 PANEL DE COLUMNAS
    // =============================
    function buildColumnsPanel() {
      columnsPanel.innerHTML = columnsConfig.map(c => `
        <label 
          style="
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 12px; 
            margin-bottom: 4px;
          "
        >
          <input 
            type="checkbox" 
            data-col-key="${c.key}" 
            ${columnVisibility[c.key] ? "checked" : ""}
          />
          <span>${c.label}</span>
        </label>
      `).join("");

      columnsPanel
        .querySelectorAll('input[type="checkbox"]')
        .forEach(chk => {
          chk.addEventListener("change", (e) => {
            const key = e.target.getAttribute("data-col-key");
            columnVisibility[key] = e.target.checked;
            renderGroups();
          });
        });
    }

    columnsToggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = columnsPanel.style.display === "block";
      columnsPanel.style.display = isOpen ? "none" : "block";
    });

    // =============================
    // 08.6 FILTROS: PANEL
    // =============================
    filtersToggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = filtersPanel.style.display === "block";
      filtersPanel.style.display = isOpen ? "none" : "block";
    });

    filtersResetBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      projectFilter.value = "all";
      ownerFilter.value = "all";
      priorityFilter.value = "all";
      renderGroups();
    });

    // =============================
    // 08.7 GRUPOS: PANEL DE VISIBILIDAD
    // =============================
    function buildGroupsPanel() {
      if (!originalGroups.length) {
        groupsPanel.innerHTML = `<p class="panel-text" style="font-size:12px;">No groups.</p>`;
        return;
      }

      const itemsHtml = originalGroups.map(g => {
        const id = g.status_id || g.status_name;
        const name = g.status_name || "(no status)";
        const nameNorm = (name || "").toLowerCase();

        if (!(id in groupVisibility)) {
          const isDefaultOn = DEFAULT_ON_GROUPS.some(s => nameNorm.includes(s));
          groupVisibility[id] = isDefaultOn;
        }

        return `
          <label 
            style="
              display:flex;
              align-items:center;
              gap:6px;
              font-size:12px;
              margin-bottom:4px;
            "
          >
            <input 
              type="checkbox" 
              data-group-id="${id}" 
              ${groupVisibility[id] ? "checked" : ""}
            />
            <span>${name}</span>
          </label>
        `;
      }).join("");

      groupsPanel.innerHTML = itemsHtml;

      groupsPanel
        .querySelectorAll('input[type="checkbox"]')
        .forEach(chk => {
          chk.addEventListener("change", (e) => {
            const id = e.target.getAttribute("data-group-id");
            groupVisibility[id] = e.target.checked;
            renderGroups();
          });
        });
    }

    groupsToggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = groupsPanel.style.display === "block";
      groupsPanel.style.display = isOpen ? "none" : "block";
    });

    // Cerrar paneles al click afuera
    document.addEventListener("click", (e) => {
      if (!columnsPanel.contains(e.target) && e.target !== columnsToggleBtn) {
        columnsPanel.style.display = "none";
      }
      if (!filtersPanel.contains(e.target) && e.target !== filtersToggleBtn) {
        filtersPanel.style.display = "none";
      }
      if (!groupsPanel.contains(e.target) && e.target !== groupsToggleBtn) {
        groupsPanel.style.display = "none";
      }
    });

    // =============================
    // 08.8 FILTROS (LÓGICA)
    // =============================
    function populateFilters(groups) {
      const projectMap = new Map();
      const ownerMap = new Map();
      const priorityMap = new Map();

      groups.forEach(g => {
        (g.tasks || []).forEach(t => {
          if (t.project_id || t.project_name) {
            const pid = t.project_id || t.project_name;
            const pname = t.project_name || t.project_id || "(No project name)";
            if (!projectMap.has(pid)) {
              projectMap.set(pid, pname);
            }
          }
          if (t.owner && (t.owner.id || t.owner.name)) {
            const oid = t.owner.id || t.owner.name;
            const oname = t.owner.name || t.owner.id;
            if (!ownerMap.has(oid)) {
              ownerMap.set(oid, oname);
            }
          }
          if (t.priority && (t.priority.priority_name || t.priority.priority_id)) {
            const pname = t.priority.priority_name || t.priority.priority_id;
            const key = (pname || "").toString().toLowerCase();
            if (!priorityMap.has(key)) {
              priorityMap.set(key, pname);
            }
          }
        });
      });

      // Projects
      projectFilter.innerHTML = `<option value="all">All projects</option>`;
      projectMap.forEach((name, id) => {
        projectFilter.innerHTML += `<option value="${id}">${name}</option>`;
      });

      // Owners
      ownerFilter.innerHTML = `<option value="all">All owners</option>`;
      ownerMap.forEach((name, id) => {
        ownerFilter.innerHTML += `<option value="${id}">${name}</option>`;
      });

      // Priorities
      priorityFilter.innerHTML = `<option value="all">All priorities</option>`;
      priorityMap.forEach((name, key) => {
        priorityFilter.innerHTML += `<option value="${key}">${name}</option>`;
      });
    }

    function applyFilters(groups) {
      const selectedProject = projectFilter.value;
      const selectedOwner = ownerFilter.value;
      const selectedPriority = priorityFilter.value;

      return groups.map(group => {
        const tasks = Array.isArray(group.tasks) ? group.tasks : [];
        const filteredTasks = tasks.filter(t => {
          // Project filter
          const pid = t.project_id || t.project_name || "";
          const projectPass = selectedProject === "all" || pid === selectedProject;

          // Owner filter
          const oid = t.owner?.id || t.owner?.name || "";
          const ownerPass = selectedOwner === "all" || oid === selectedOwner;

          // Priority filter
          const pName = t.priority?.priority_name || t.priority?.priority_id || "";
          const pKey = pName.toString().toLowerCase();
          const priorityPass = selectedPriority === "all" || pKey === selectedPriority;

          return projectPass && ownerPass && priorityPass;
        });

        return {
          ...group,
          tasks: filteredTasks,
        };
      });
    }

    // =============================
    // 08.08.x CERRAR MODAL
    // =============================
    function closeTaskModal() {
      const backdrop = document.querySelector(".pm-modal-backdrop");
      if (backdrop) backdrop.remove();
    }

    // =============================
    // 08.09 MODAL DE DETALLES
    // =============================
    function openTaskModal(task, statusName) {
      if (!task) return;

      const ownerName = task.owner?.name || "-";
      const collaboratorsText =
        (task.collaborators || [])
          .map(c => c.name || c.id)
          .filter(Boolean)
          .join(", ") || "-";

      const managerName = task.manager_obj?.name || "-";

      const priorityName = task.priority?.priority_name || "-";
      const finishedName = task.finished_status?.completed_status_name || "-";

      const arrival = formatDate(task.created_at) || "-";
      const start = formatDate(task.start_date) || "-";
      const due = formatDate(task.due_date) || "-";
      const deadline = formatDate(task.deadline) || "-";
      const estHours =
        task.estimated_hours != null ? `${task.estimated_hours} h` : "-";

      const projectName = task.project_name || "-";
      const companyName = task.company_name || "-";

      const docsLink = task.docs_link || "";
      const resultLink = task.result_link || "";

      const statusStyle = getStatusStyle(statusName);

      const modalHtml = `
        <div 
          class="pm-modal-backdrop"
          style="
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
          "
        >
          <div 
            class="pm-modal"
            style="
              background: #020617;
              border-radius: 16px;
              border: 1px solid #1f2937;
              padding: 16px 18px 18px;
              width: 720px;
              max-width: calc(100% - 32px);
              max-height: calc(100% - 32px);
              overflow-y: auto;
              box-shadow: 0 18px 45px rgba(0,0,0,0.6);
            "
          >

            <!-- Header del modal -->
            <div 
              style="
                display:flex; 
                justify-content:space-between; 
                align-items:flex-start; 
                gap:12px; 
                margin-bottom:12px;
              "
            >
              <div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                  <span 
                    style="
                      width: 8px;
                      height: 8px;
                      border-radius: 999px;
                      background: ${statusStyle.dotColor};
                      display: inline-block;
                    "
                  ></span>
                  <span 
                    style="
                      font-size:11px;
                      text-transform:uppercase;
                      letter-spacing:0.08em;
                      color:#9ca3af;
                    "
                  >
                    ${statusName || "(no status)"}
                  </span>
                </div>

                <h2 style="font-size:16px; font-weight:600; margin:0 0 4px 0;">
                  ${task.task_description || "(no description)"}
                </h2>

                ${
                  task.task_notes
                    ? `<p style="font-size:12px; color:#9ca3af; margin:0;">
                        ${task.task_notes}
                      </p>`
                    : ""
                }
              </div>

              <!-- Botón cierre -->
              <button
                type="button"
                onclick="closeTaskModal()"
                style="
                  border:none;
                  background:transparent;
                  color:#9ca3af;
                  font-size:20px;
                  line-height:1;
                  cursor:pointer;
                "
              >×</button>
            </div>

            <!-- GRID MAIN INFO -->
            <div 
              style="
                display:grid;
                grid-template-columns: 1.3fr 1fr;
                gap:10px;
                margin-bottom:8px;
              "
            >
              <!-- LEFT CARD: SUMMARY -->
              <div
                style="
                  background:#020617;
                  border-radius:12px;
                  border:1px solid #1f2937;
                  padding:10px 12px;
                "
              >
                <div 
                  style="
                    display:flex; 
                    justify-content:space-between; 
                    align-items:center; 
                    margin-bottom:4px;
                  "
                >
                  <h3 
                    style="
                      font-size:11px; 
                      text-transform:uppercase; 
                      letter-spacing:0.08em; 
                      color:#6b7280; 
                      margin:0;
                    "
                  >
                    Summary
                  </h3>

                  <span 
                    style="
                      font-size:11px;
                      padding:2px 8px;
                      border-radius:999px;
                      border:1px solid ${statusStyle.borderColor};
                      color:${statusStyle.titleColor};
                      background:rgba(15,23,42,0.7);
                    "
                  >
                    ${statusName || "(no status)"}
                  </span>
                </div>

                <div 
                  style="
                    display:grid; 
                    grid-template-columns: repeat(2, minmax(0,1fr)); 
                    gap:6px;
                  "
                >
                  <div>
                    <div style="font-size:11px; color:#6b7280;">Project</div>
                    <div style="font-size:12px;">${projectName}</div>
                  </div>

                  <div>
                    <div style="font-size:11px; color:#6b7280;">Company</div>
                    <div style="font-size:12px;">${companyName}</div>
                  </div>

                  <div>
                    <div style="font-size:11px; color:#6b7280;">Priority</div>
                    <div style="font-size:12px;">${priorityName}</div>
                  </div>

                  <div>
                    <div style="font-size:11px; color:#6b7280;">Finished</div>
                    <div style="font-size:12px;">${finishedName}</div>
                  </div>
                </div>
              </div>

              <!-- RIGHT CARD: PEOPLE -->
              <div
                style="
                  background:#020617;
                  border-radius:12px;
                  border:1px solid #1f2937;
                  padding:10px 12px;
                "
              >
                <h3 
                  style="
                    font-size:11px; 
                    text-transform:uppercase; 
                    letter-spacing:0.08em; 
                    color:#6b7280; 
                    margin:0 0 4px 0;
                  "
                >
                  People
                </h3>

                <div style="display:flex; flex-direction:column; gap:4px;">
                  <div>
                    <div style="font-size:11px; color:#6b7280;">Owner</div>
                    <div style="font-size:12px;">${ownerName}</div>
                  </div>

                  <div>
                    <div style="font-size:11px; color:#6b7280;">Collaborators</div>
                    <div style="font-size:12px;">${collaboratorsText}</div>
                  </div>

                  <div>
                    <div style="font-size:11px; color:#6b7280;">Manager</div>
                    <div style="font-size:12px;">${managerName}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- CARD: TIMING + LINKS -->
            <div
              style="
                background:#020617;
                border-radius:12px;
                border:1px solid #1f2937;
                padding:10px 12px;
                margin-bottom:4px;
              "
            >
              <h3 
                style="
                  font-size:11px; 
                  text-transform:uppercase; 
                  letter-spacing:0.08em; 
                  color:#6b7280; 
                  margin:0 0 6px 0;
                "
              >
                Timing & Links
              </h3>

              <div 
                style="
                  display:grid; 
                  grid-template-columns: repeat(4, minmax(0,1fr)); 
                  gap:6px; 
                  margin-bottom:6px;
                "
              >
                <div>
                  <div style="font-size:11px; color:#6b7280;">Arrival</div>
                  <div style="font-size:12px;">${arrival}</div>
                </div>

                <div>
                  <div style="font-size:11px; color:#6b7280;">Start date</div>
                  <div style="font-size:12px;">${start}</div>
                </div>

                <div>
                  <div style="font-size:11px; color:#6b7280;">Due</div>
                  <div style="font-size:12px;">${due}</div>
                </div>

                <div>
                  <div style="font-size:11px; color:#6b7280;">Deadline</div>
                  <div style="font-size:12px;">${deadline}</div>
                </div>
              </div>

              <div 
                style="
                  display:flex; 
                  justify-content:space-between; 
                  align-items:center; 
                  gap:8px;
                "
              >
                <div>
                  <div style="font-size:11px; color:#6b7280;">Estimated hours</div>
                  <div style="font-size:12px;">${estHours}</div>
                </div>

                <div style="display:flex; gap:8px; justify-content:flex-end;">
                  ${
                    docsLink
                      ? `<a 
                          href="${docsLink}" 
                          target="_blank" 
                          style="
                            font-size:11px; 
                            padding:4px 8px; 
                            border-radius:999px; 
                            border:1px solid #4b5563; 
                            text-decoration:none; 
                            color:#e5e7eb;
                          "
                        >Docs link</a>`
                      : ""
                  }

                  ${
                    resultLink
                      ? `<a 
                          href="${resultLink}" 
                          target="_blank" 
                          style="
                            font-size:11px; 
                            padding:4px 8px; 
                            border-radius:999px; 
                            border:1px solid #4b5563; 
                            text-decoration:none; 
                            color:#e5e7eb;
                          "
                        >Result link</a>`
                      : ""
                  }
                </div>
              </div>
            </div>

          </div>
        </div>
      `;

      document.body.insertAdjacentHTML("beforeend", modalHtml);

      // cierre del modal al click fuera
      const backdrop = document.querySelector(".pm-modal-backdrop");
      if (backdrop) {
        backdrop.addEventListener("click", e => {
          if (e.target === backdrop) closeTaskModal();
        });
      }
    }

    function attachRowClickHandlers() {
      const rows = document.querySelectorAll(".pm-row");
      rows.forEach(row => {
        row.addEventListener("click", () => {
          if (manageMode) {
            // en modo manage dejamos este click libre para futuro inline-edit
            return;
          }
          const taskId = row.getAttribute("data-task-id");
          const statusName = row.getAttribute("data-status-name") || "";
          if (!taskId) return;

          let foundTask = null;
          for (const g of originalGroups) {
            for (const t of g.tasks || []) {
              if (t.task_id === taskId) {
                foundTask = t;
                break;
              }
            }
            if (foundTask) break;
          }

          openTaskModal(foundTask, statusName);
        });
      });
    }

    // =============================
    // 08.11 TOGGLES DE GRUPOS
    // =============================
    function attachGroupToggles() {
      const headers = document.querySelectorAll(".pm-group-header");
      headers.forEach(header => {
        header.addEventListener("click", () => {
          const groupId = header.getAttribute("data-group-id");
          const body = document.querySelector(`.pm-group-body[data-group-id="${groupId}"]`);
          if (!body) return;
          const isHidden = body.style.display === "none";
          body.style.display = isHidden ? "" : "none";
          const icon = header.querySelector(".pm-group-toggle-icon");
          if (icon) icon.textContent = isHidden ? "▾" : "▸";
        });
      });

      const addButtons = document.querySelectorAll("[data-add-task-for-status]");
      addButtons.forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const statusId = btn.getAttribute("data-add-task-for-status");
          console.log("Add task clicked for status:", statusId);
          alert("TODO: Abrir modal para crear nueva task en este group.");
        });
      });
    }

    // =============================
    // 08.12 MANAGE MODE
    // =============================
    manageToggleBtn.addEventListener("click", () => {
      manageMode = !manageMode;
      manageToggleBtn.textContent = manageMode ? "Exit manage mode" : "Manage tasks";
      renderGroups();
    });

    // =============================
    // 08.13 RENDER PRINCIPAL
    // =============================
    function renderGroups() {
      if (!originalGroups.length) {
        groupsContainer.innerHTML = `
          <div class="pm-groups-wrapper">
            <div class="pm-group">
              <p class="panel-text">No tasks found in pipeline.</p>
            </div>
          </div>
        `;
        return;
      }

      const filteredByTasks = applyFilters(originalGroups);
      const sorted = sortGroupsByStatus(filteredByTasks);

      const visible = sorted.filter(g => {
        const id = g.status_id || g.status_name;
        if (id in groupVisibility) {
          return groupVisibility[id];
        }
        return true;
      });

      if (!visible.length) {
        groupsContainer.innerHTML = `
          <div class="pm-groups-wrapper">
            <div class="pm-group">
              <p class="panel-text">No groups visible. Adjust filters.</p>
            </div>
          </div>
        `;
        return;
      }

      groupsContainer.innerHTML = `
        <div class="pm-groups-wrapper">
          ${visible.map(renderGroupPanel).join("")}
        </div>
      `;
      attachGroupToggles();
      attachRowClickHandlers();
    }

    // =============================
    // 08.14 CARGA INICIAL DESDE API
    // =============================
    async function loadPipeline() {
      // Estado inicial "Loading..."
      groupsContainer.innerHTML =
        '<div class="pm-groups-wrapper">' +
          '<div class="pm-group">' +
            '<p class="panel-text">Loading pipeline...</p>' +
          '</div>' +
        '</div>';

      try {
        const res = await fetch(API_BASE + "/pipeline/grouped");

        if (!res.ok) {
          const text = await res.text();
          groupsContainer.innerHTML =
            '<div class="pm-groups-wrapper">' +
              '<div class="pm-group">' +
                '<p class="panel-text">Error loading pipeline: ' +
                  String(text) +
                '</p>' +
              '</div>' +
            '</div>';
          return;
        }

        const json = await res.json();
        originalGroups = json.groups || [];

        buildColumnsPanel();
        buildGroupsPanel();
        populateFilters(originalGroups);
        renderGroups();

      } catch (err) {
        console.error("Error loading pipeline:", err);
        groupsContainer.innerHTML =
          '<div class="pm-groups-wrapper">' +
            '<div class="pm-group">' +
              '<p class="panel-text">Network or server error loading pipeline.</p>' +
            '</div>' +
          '</div>';
      }
    }

    // Eventos de filtros
    projectFilter.addEventListener("change", renderGroups);
    ownerFilter.addEventListener("change", renderGroups);
    priorityFilter.addEventListener("change", renderGroups);

    // Init
    loadPipeline();
  </script>
</body>
</html>
