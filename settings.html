<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1a1a1a" />
    <title>NGM HUB ‚Äî Settings</title>
    <link rel="icon" type="image/png" href="assets/img/greenblack_icon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="assets/img/greenblack_icon.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/expenses_styles.css" />
    <link rel="stylesheet" href="assets/css/arturito_widget.css" />

    <script src="assets/js/config.js" defer></script>
    <script src="assets/js/permissions.js" defer></script>
    <script src="assets/js/pills.js" defer></script>
    <script src="assets/js/sidebar.js" defer></script>
    <script src="assets/js/arturito_widget.js" defer></script>
</head>
<body class="page-settings">
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="assets/img/logo.png" alt="NGM HUB Logo" class="sidebar-logo-img" />
            </div>
            <div class="sidebar-title-block">
                <p class="sidebar-title">NGM HUB</p>
            </div>
            <div class="sidebar-nav-card">
                <nav class="sidebar-nav" id="sidebar-nav">
                    <a href="dashboard.html" class="nav-item" data-module="dashboard">Dashboard</a>
                    <a href="expenses.html" class="nav-item" data-module="expenses">Expenses Engine</a>
                    <a href="pipeline.html" class="nav-item" data-module="pipeline">Pipeline Manager</a>
                    <a href="projects.html" class="nav-item" data-module="projects">Projects</a>
                    <a href="vendors.html" class="nav-item" data-module="vendors">Vendors</a>
                    <a href="accounts.html" class="nav-item" data-module="accounts">Accounts</a>
                    <a href="estimator.html" class="nav-item" data-module="estimator">Estimator Suite</a>
                    <a href="team.html" class="nav-item" data-module="team">Team Management</a>
                    <a href="messages.html" class="nav-item" data-module="messages">Messages</a>
                    <a href="arturito.html" class="nav-item" data-module="arturito">Arturito</a>
                </nav>
            </div>
        </aside>

        <div class="main-area">
            <header class="ngm-topbar">
                <div class="ngm-bar-left">
                    <div class="ngm-brand">
                        <div class="ngm-brand-icon-small"><img src="assets/img/white_icon.png" alt="NGM"></div>
                        <div class="ngm-brand-text">
                            <span class="ngm-brand-org">Next Generation Management</span>
                            <span class="ngm-brand-context">NGM Hub ¬∑ System Settings</span>
                        </div>
                    </div>
                </div>
                <div class="ngm-topbar-right">
                    <div class="ngm-meta">
                        <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment ¬∑ ‚Äî</span>
                        <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server ¬∑ ‚Äî</span>
                    </div>
                    <form class="ngm-search" role="search" onsubmit="return false;">
                        <span class="ngm-global-search-icon">‚åï</span>
                        <input type="search" class="ngm-search-input" placeholder="Search settings..." />
                    </form>
                    <span id="user-pill" class="user-pill">User ¬∑ ‚Äî</span>
                </div>
            </header>

            <main class="main-content">
                <div class="workspace">
                    <section class="data-section">
                        <div class="expenses-toolbar">
                            <div class="toolbar-left">
                                <h2 style="font-size: 18px; font-weight: 600; color: #e5e7eb; margin: 0;">System Settings</h2>
                                <p style="font-size: 13px; color: #6b7280; margin: 4px 0 0 0;">Configure system preferences and integrations</p>
                            </div>
                            <div class="toolbar-right">
                                <button type="button" class="btn-toolbar btn-toolbar-secondary">Reset to Default</button>
                                <button type="button" class="btn-toolbar btn-toolbar-primary">Save Changes</button>
                            </div>
                        </div>

                        <div class="expenses-table-container">
                            <div id="settingsLoadingState" class="expenses-loading-state">
                                <img src="assets/img/white_icon.png" class="loading-logo loading-logo-lg" alt="Loading...">
                                <span class="loading-text">Loading settings...</span>
                            </div>

                            <div id="settingsContent" style="display: none; padding: 24px;">

                                <!-- General Settings -->
                                <div style="background: #18181b; border: 1px solid #27272f; border-radius: 8px; padding: 24px; margin-bottom: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 600; color: #e5e7eb; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.05em;">General Settings</h3>
                                    <div style="display: grid; gap: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 13px; color: #e5e7eb; margin-bottom: 6px;">Company Name</label>
                                            <input type="text" value="Next Generation Management" style="width: 100%; padding: 8px 12px; background: #0a0a0b; border: 1px solid #27272f; border-radius: 6px; color: #e5e7eb; font-size: 13px;" />
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 13px; color: #e5e7eb; margin-bottom: 6px;">Default Currency</label>
                                            <select style="width: 100%; padding: 8px 12px; background: #0a0a0b; border: 1px solid #27272f; border-radius: 6px; color: #e5e7eb; font-size: 13px;">
                                                <option>USD ($)</option>
                                                <option>EUR (‚Ç¨)</option>
                                                <option>GBP (¬£)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 13px; color: #e5e7eb; margin-bottom: 6px;">Time Zone</label>
                                            <select style="width: 100%; padding: 8px 12px; background: #0a0a0b; border: 1px solid #27272f; border-radius: 6px; color: #e5e7eb; font-size: 13px;">
                                                <option>America/New_York (EST)</option>
                                                <option>America/Los_Angeles (PST)</option>
                                                <option>Europe/London (GMT)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Email & Notifications -->
                                <div style="background: #18181b; border: 1px solid #27272f; border-radius: 8px; padding: 24px; margin-bottom: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 600; color: #e5e7eb; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.05em;">Email & Notifications</h3>
                                    <div style="display: grid; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Send daily summary emails</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Notify on new expenses</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Notify on budget overruns</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Send weekly project updates</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Budget Alerts Settings -->
                                <div id="budgetAlertsCard" style="background: #18181b; border: 1px solid #27272f; border-radius: 8px; padding: 24px; margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <h3 style="font-size: 14px; font-weight: 600; color: #e5e7eb; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">Budget Alerts</h3>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="budgetAlertsEnabled" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 12px; color: #9ca3af;">Enabled</span>
                                        </label>
                                    </div>
                                    <p style="font-size: 12px; color: #6b7280; margin: 0 0 16px 0;">
                                        Receive automatic notifications when project expenses approach or exceed budget limits.
                                    </p>

                                    <!-- Threshold Settings -->
                                    <div style="background: #0a0a0b; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                        <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">Alert Thresholds</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: #e5e7eb; margin-bottom: 6px;">
                                                    Warning at
                                                    <span style="color: #f59e0b;">(%)</span>
                                                </label>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <input type="number" id="warningThreshold" value="80" min="50" max="99" style="width: 70px; padding: 8px 12px; background: #18181b; border: 1px solid #27272f; border-radius: 6px; color: #e5e7eb; font-size: 13px; text-align: center;" />
                                                    <span style="font-size: 12px; color: #6b7280;">% of budget used</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: #e5e7eb; margin-bottom: 6px;">
                                                    Critical at
                                                    <span style="color: #ef4444;">(%)</span>
                                                </label>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <input type="number" id="criticalThreshold" value="95" min="80" max="100" style="width: 70px; padding: 8px 12px; background: #18181b; border: 1px solid #27272f; border-radius: 6px; color: #e5e7eb; font-size: 13px; text-align: center;" />
                                                    <span style="font-size: 12px; color: #6b7280;">% of budget used</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Alert Types -->
                                    <div style="background: #0a0a0b; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                        <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">Alert Types</div>
                                        <div style="display: grid; gap: 10px;">
                                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                                <input type="checkbox" id="overspendAlert" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                                <div>
                                                    <span style="font-size: 13px; color: #e5e7eb;">Over Budget Alert</span>
                                                    <span style="display: block; font-size: 11px; color: #6b7280;">Notify when expenses exceed the budget</span>
                                                </div>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                                <input type="checkbox" id="noBudgetAlert" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                                <div>
                                                    <span style="font-size: 13px; color: #e5e7eb;">No Budget Alert</span>
                                                    <span style="display: block; font-size: 11px; color: #6b7280;">Notify when expenses are made without a budget</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Recipients -->
                                    <div style="background: #0a0a0b; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em;">Alert Recipients</div>
                                            <button onclick="openAddRecipientModal()" style="padding: 4px 12px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                                + Add Recipient
                                            </button>
                                        </div>
                                        <div id="budgetAlertRecipients" style="display: grid; gap: 8px;">
                                            <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 12px;">
                                                Loading recipients...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quiet Hours -->
                                    <div style="background: #0a0a0b; border-radius: 8px; padding: 16px;">
                                        <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">Quiet Hours</div>
                                        <p style="font-size: 11px; color: #6b7280; margin: 0 0 12px 0;">
                                            Notifications won't be sent during these hours.
                                        </p>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div>
                                                <label style="display: block; font-size: 11px; color: #9ca3af; margin-bottom: 4px;">From</label>
                                                <select id="quietStartHour" style="padding: 6px 10px; background: #18181b; border: 1px solid #27272f; border-radius: 4px; color: #e5e7eb; font-size: 12px;">
                                                    <option value="20">8:00 PM</option>
                                                    <option value="21">9:00 PM</option>
                                                    <option value="22" selected>10:00 PM</option>
                                                    <option value="23">11:00 PM</option>
                                                </select>
                                            </div>
                                            <span style="color: #6b7280; margin-top: 16px;">to</span>
                                            <div>
                                                <label style="display: block; font-size: 11px; color: #9ca3af; margin-bottom: 4px;">Until</label>
                                                <select id="quietEndHour" style="padding: 6px 10px; background: #18181b; border: 1px solid #27272f; border-radius: 4px; color: #e5e7eb; font-size: 12px;">
                                                    <option value="6">6:00 AM</option>
                                                    <option value="7" selected>7:00 AM</option>
                                                    <option value="8">8:00 AM</option>
                                                    <option value="9">9:00 AM</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Save Button -->
                                    <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                                        <button onclick="saveBudgetAlertSettings()" style="padding: 10px 20px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;">
                                            Save Alert Settings
                                        </button>
                                    </div>
                                </div>

                                <!-- QuickBooks Online Integration -->
                                <div id="qboIntegrationCard" style="background: #18181b; border: 1px solid #27272f; border-radius: 8px; padding: 24px; margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <h3 style="font-size: 14px; font-weight: 600; color: #e5e7eb; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">QuickBooks Online Integration</h3>
                                        <span id="qboStatusBadge" style="padding: 4px 12px; background: rgba(107, 114, 128, 0.2); color: #9ca3af; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                            Checking...
                                        </span>
                                    </div>

                                    <!-- Connection Status Panel -->
                                    <div id="qboConnectionPanel" style="background: #0a0a0b; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                        <!-- Loading State -->
                                        <div id="qboLoadingState" style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 20px; height: 20px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                            <span style="color: #9ca3af; font-size: 13px;">Checking QuickBooks connection...</span>
                                        </div>

                                        <!-- Not Connected State -->
                                        <div id="qboNotConnected" style="display: none;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                                <div style="width: 40px; height: 40px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                    <span style="font-size: 20px;">‚ö†Ô∏è</span>
                                                </div>
                                                <div>
                                                    <div style="font-size: 14px; color: #e5e7eb; font-weight: 600;">Not Connected</div>
                                                    <div style="font-size: 12px; color: #6b7280;">Connect your QuickBooks account to sync expenses</div>
                                                </div>
                                            </div>
                                            <button id="btnConnectQBO" onclick="connectQuickBooks()" style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #2ca01c 0%, #1a7a10 100%); border: none; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s ease;">
                                                <span style="font-size: 16px;">üîó</span>
                                                Connect to QuickBooks
                                            </button>
                                        </div>

                                        <!-- Connected State -->
                                        <div id="qboConnected" style="display: none;">
                                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
                                                <div style="width: 40px; height: 40px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <span style="font-size: 20px;">‚úì</span>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 14px; color: #e5e7eb; font-weight: 600;" id="qboCompanyName">Company Name</div>
                                                    <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Realm ID: <span id="qboRealmId">‚Äî</span></div>
                                                </div>
                                            </div>

                                            <!-- Token Status -->
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 6px; border: 1px solid #27272f;">
                                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Access Token</div>
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <span id="qboAccessTokenStatus" style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span>
                                                        <span id="qboAccessTokenText" style="font-size: 13px; color: #e5e7eb;">Valid</span>
                                                    </div>
                                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Expires: <span id="qboAccessExpires">‚Äî</span></div>
                                                </div>
                                                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 6px; border: 1px solid #27272f;">
                                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Refresh Token</div>
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <span id="qboRefreshTokenStatus" style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span>
                                                        <span id="qboRefreshTokenText" style="font-size: 13px; color: #e5e7eb;">Valid</span>
                                                    </div>
                                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Expires: <span id="qboRefreshExpires">‚Äî</span></div>
                                                </div>
                                            </div>

                                            <!-- Actions -->
                                            <div style="display: flex; gap: 12px;">
                                                <button id="btnSyncQBO" onclick="syncQuickBooks()" style="flex: 1; padding: 10px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s ease;">
                                                    <span style="font-size: 14px;">üîÑ</span>
                                                    Sync Expenses
                                                </button>
                                                <button id="btnDisconnectQBO" onclick="disconnectQuickBooks()" style="padding: 10px 16px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #f87171; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s ease;">
                                                    Disconnect
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Error State -->
                                        <div id="qboErrorState" style="display: none;">
                                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px;">
                                                <span style="font-size: 20px;">‚ùå</span>
                                                <div>
                                                    <div style="font-size: 13px; color: #f87171; font-weight: 600;">Connection Error</div>
                                                    <div style="font-size: 12px; color: #9ca3af;" id="qboErrorMessage">Unable to check connection status</div>
                                                </div>
                                            </div>
                                            <button onclick="checkQBOStatus()" style="margin-top: 12px; padding: 8px 16px; background: transparent; border: 1px solid #27272f; border-radius: 6px; color: #9ca3af; font-size: 12px; cursor: pointer;">
                                                Retry
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Sync Info -->
                                    <div id="qboSyncInfo" style="display: none; font-size: 12px; color: #6b7280;">
                                        Last sync: <span id="qboLastSync">Never</span>
                                    </div>
                                </div>

                                <!-- Other Integrations -->
                                <div style="background: #18181b; border: 1px solid #27272f; border-radius: 8px; padding: 24px; margin-bottom: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 600; color: #e5e7eb; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.05em;">Other Integrations</h3>
                                    <div style="display: grid; gap: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0a0a0b; border-radius: 6px;">
                                            <div>
                                                <div style="font-size: 14px; color: #e5e7eb; font-weight: 600;">Slack</div>
                                                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Team notifications and updates</div>
                                            </div>
                                            <button style="padding: 4px 12px; background: transparent; border: 1px solid #27272f; color: #9ca3af; border-radius: 4px; font-size: 12px; cursor: pointer;">Connect</button>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0a0a0b; border-radius: 6px;">
                                            <div>
                                                <div style="font-size: 14px; color: #e5e7eb; font-weight: 600;">Google Drive</div>
                                                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Document storage and sharing</div>
                                            </div>
                                            <button style="padding: 4px 12px; background: transparent; border: 1px solid #27272f; color: #9ca3af; border-radius: 4px; font-size: 12px; cursor: pointer;">Connect</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security -->
                                <div style="background: #18181b; border: 1px solid #27272f; border-radius: 8px; padding: 24px;">
                                    <h3 style="font-size: 14px; font-weight: 600; color: #e5e7eb; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.05em;">Security</h3>
                                    <div style="display: grid; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Require two-factor authentication</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Auto-logout after 30 minutes of inactivity</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                            <input type="checkbox" style="width: 16px; height: 16px; cursor: pointer;" />
                                            <span style="font-size: 13px; color: #e5e7eb;">Require password change every 90 days</span>
                                        </label>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #btnConnectQBO:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        #btnSyncQBO:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        #btnDisconnectQBO:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
        }
        #btnSyncQBO:disabled, #btnConnectQBO:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>

    <script>
        // ====== Budget Alerts Variables ======
        let budgetAlertSettings = null;
        let budgetAlertRecipients = [];

        // ====== Budget Alerts Functions ======

        async function loadBudgetAlertSettings() {
            try {
                const token = localStorage.getItem('ngmToken');
                const response = await fetch(`${window.API_BASE}/budget-alerts/settings`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) throw new Error('Failed to load settings');

                const data = await response.json();
                budgetAlertSettings = data.data;

                // Populate form
                document.getElementById('budgetAlertsEnabled').checked = budgetAlertSettings.is_enabled !== false;
                document.getElementById('warningThreshold').value = budgetAlertSettings.warning_threshold || 80;
                document.getElementById('criticalThreshold').value = budgetAlertSettings.critical_threshold || 95;
                document.getElementById('overspendAlert').checked = budgetAlertSettings.overspend_alert !== false;
                document.getElementById('noBudgetAlert').checked = budgetAlertSettings.no_budget_alert !== false;
                document.getElementById('quietStartHour').value = budgetAlertSettings.quiet_start_hour || 22;
                document.getElementById('quietEndHour').value = budgetAlertSettings.quiet_end_hour || 7;

                // Load recipients
                await loadBudgetAlertRecipients();

            } catch (error) {
                console.error('[BudgetAlerts] Error loading settings:', error);
                // Use defaults if API fails
            }
        }

        async function loadBudgetAlertRecipients() {
            const container = document.getElementById('budgetAlertRecipients');

            try {
                const token = localStorage.getItem('ngmToken');
                const response = await fetch(`${window.API_BASE}/budget-alerts/recipients`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) throw new Error('Failed to load recipients');

                const data = await response.json();
                budgetAlertRecipients = data.data || [];

                if (budgetAlertRecipients.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 12px;">
                            No recipients configured. Add users to receive budget alerts.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = budgetAlertRecipients.map(r => {
                    const user = r.users || {};
                    const initials = (user.user_name || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    const color = user.avatar_color || '#3b82f6';

                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px; border: 1px solid #27272f;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 32px; height: 32px; background: ${color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff;">
                                    ${initials}
                                </div>
                                <div>
                                    <div style="font-size: 13px; color: #e5e7eb;">${user.user_name || 'Unknown'}</div>
                                    <div style="font-size: 11px; color: #6b7280;">${user.user_email || ''}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 10px; color: ${r.notify_push ? '#22c55e' : '#6b7280'};" title="Push notifications">
                                    ${r.notify_push ? 'üîî' : 'üîï'}
                                </span>
                                <span style="font-size: 10px; color: ${r.notify_dashboard ? '#22c55e' : '#6b7280'};" title="Dashboard notifications">
                                    ${r.notify_dashboard ? 'üìã' : 'üìã'}
                                </span>
                                <button onclick="removeAlertRecipient('${r.id}')" style="padding: 4px 8px; background: transparent; border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('[BudgetAlerts] Error loading recipients:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 12px;">
                        Unable to load recipients. <button onclick="loadBudgetAlertRecipients()" style="color: #3b82f6; background: none; border: none; cursor: pointer; text-decoration: underline;">Retry</button>
                    </div>
                `;
            }
        }

        async function saveBudgetAlertSettings() {
            try {
                const settings = {
                    is_enabled: document.getElementById('budgetAlertsEnabled').checked,
                    warning_threshold: parseInt(document.getElementById('warningThreshold').value) || 80,
                    critical_threshold: parseInt(document.getElementById('criticalThreshold').value) || 95,
                    overspend_alert: document.getElementById('overspendAlert').checked,
                    no_budget_alert: document.getElementById('noBudgetAlert').checked,
                    quiet_start_hour: parseInt(document.getElementById('quietStartHour').value) || 22,
                    quiet_end_hour: parseInt(document.getElementById('quietEndHour').value) || 7,
                };

                // Validate thresholds
                if (settings.warning_threshold >= settings.critical_threshold) {
                    alert('Warning threshold must be less than critical threshold.');
                    return;
                }

                const token = localStorage.getItem('ngmToken');
                const response = await fetch(`${window.API_BASE}/budget-alerts/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) throw new Error('Failed to save settings');

                alert('Budget alert settings saved successfully!');

            } catch (error) {
                console.error('[BudgetAlerts] Error saving settings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        }

        async function openAddRecipientModal() {
            // For now, use a simple prompt - in production, use a proper modal with user picker
            const userId = prompt('Enter user ID to add as recipient:');
            if (!userId) return;

            try {
                const token = localStorage.getItem('ngmToken');
                const response = await fetch(`${window.API_BASE}/budget-alerts/recipients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        receive_warning: true,
                        receive_critical: true,
                        receive_overspend: true,
                        receive_no_budget: true,
                        notify_push: true,
                        notify_dashboard: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to add recipient');
                }

                await loadBudgetAlertRecipients();
                alert('Recipient added successfully!');

            } catch (error) {
                console.error('[BudgetAlerts] Error adding recipient:', error);
                alert('Failed to add recipient: ' + error.message);
            }
        }

        async function removeAlertRecipient(recipientId) {
            if (!confirm('Remove this recipient from budget alerts?')) return;

            try {
                const token = localStorage.getItem('ngmToken');
                const response = await fetch(`${window.API_BASE}/budget-alerts/recipients/${recipientId}`, {
                    method: 'DELETE',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) throw new Error('Failed to remove recipient');

                await loadBudgetAlertRecipients();

            } catch (error) {
                console.error('[BudgetAlerts] Error removing recipient:', error);
                alert('Failed to remove recipient: ' + error.message);
            }
        }

        // ====== QBO Integration Variables ======
        let currentQBOConnection = null;

        // ====== QBO Functions ======

        async function checkQBOStatus() {
            console.log('[QBO] checkQBOStatus called');
            console.log('[QBO] API_BASE:', window.API_BASE);

            const loadingState = document.getElementById('qboLoadingState');
            const notConnected = document.getElementById('qboNotConnected');
            const connected = document.getElementById('qboConnected');
            const errorState = document.getElementById('qboErrorState');
            const statusBadge = document.getElementById('qboStatusBadge');
            const syncInfo = document.getElementById('qboSyncInfo');

            // Show loading
            loadingState.style.display = 'flex';
            notConnected.style.display = 'none';
            connected.style.display = 'none';
            errorState.style.display = 'none';
            statusBadge.textContent = 'Checking...';
            statusBadge.style.background = 'rgba(107, 114, 128, 0.2)';
            statusBadge.style.color = '#9ca3af';

            try {
                const url = `${window.API_BASE}/qbo/status`;
                console.log('[QBO] Fetching:', url);
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch status');

                const data = await response.json();

                loadingState.style.display = 'none';

                if (data.connected && data.connections && data.connections.length > 0) {
                    // Show connected state
                    const conn = data.connections[0]; // Use first connection
                    currentQBOConnection = conn;

                    document.getElementById('qboCompanyName').textContent = conn.company_name || 'Unknown Company';
                    document.getElementById('qboRealmId').textContent = conn.realm_id;

                    // Access token status
                    const accessValid = conn.access_token_valid;
                    document.getElementById('qboAccessTokenStatus').style.background = accessValid ? '#22c55e' : '#ef4444';
                    document.getElementById('qboAccessTokenText').textContent = accessValid ? 'Valid' : 'Expired';
                    document.getElementById('qboAccessExpires').textContent = formatDate(conn.access_token_expires_at);

                    // Refresh token status
                    const refreshValid = conn.refresh_token_valid;
                    document.getElementById('qboRefreshTokenStatus').style.background = refreshValid ? '#22c55e' : '#ef4444';
                    document.getElementById('qboRefreshTokenText').textContent = refreshValid ? 'Valid' : 'Expired';
                    document.getElementById('qboRefreshExpires').textContent = formatDate(conn.refresh_token_expires_at);

                    // Last updated
                    if (conn.last_updated) {
                        syncInfo.style.display = 'block';
                        document.getElementById('qboLastSync').textContent = formatDate(conn.last_updated);
                    }

                    // Update badge
                    statusBadge.textContent = 'Connected';
                    statusBadge.style.background = 'rgba(34, 197, 94, 0.12)';
                    statusBadge.style.color = '#22c55e';

                    connected.style.display = 'block';
                } else {
                    // Not connected
                    statusBadge.textContent = 'Not Connected';
                    statusBadge.style.background = 'rgba(239, 68, 68, 0.12)';
                    statusBadge.style.color = '#ef4444';
                    notConnected.style.display = 'block';
                    currentQBOConnection = null;
                }
            } catch (error) {
                console.error('[QBO] Error checking QBO status:', error);
                loadingState.style.display = 'none';

                // If it's a 404, the endpoint might not be deployed yet
                // Show "Not Connected" instead of error
                if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
                    console.log('[QBO] Endpoint not available, showing Not Connected state');
                    statusBadge.textContent = 'Not Connected';
                    statusBadge.style.background = 'rgba(239, 68, 68, 0.12)';
                    statusBadge.style.color = '#ef4444';
                    notConnected.style.display = 'block';
                    currentQBOConnection = null;
                } else {
                    errorState.style.display = 'block';
                    document.getElementById('qboErrorMessage').textContent = error.message || 'Unable to check connection status';
                    statusBadge.textContent = 'Error';
                    statusBadge.style.background = 'rgba(239, 68, 68, 0.12)';
                    statusBadge.style.color = '#ef4444';
                }
            }
        }

        async function connectQuickBooks() {
            const btn = document.getElementById('btnConnectQBO');
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size: 14px;">‚è≥</span> Redirecting...';

            try {
                const response = await fetch(`${window.API_BASE}/qbo/auth`);
                if (!response.ok) throw new Error('Failed to get auth URL');

                const data = await response.json();

                if (data.authorization_url) {
                    // Open in popup window
                    const width = 600;
                    const height = 700;
                    const left = (window.screen.width - width) / 2;
                    const top = (window.screen.height - height) / 2;

                    const popup = window.open(
                        data.authorization_url,
                        'QuickBooks Authorization',
                        `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
                    );

                    // Listen for message from popup
                    window.addEventListener('message', function handleQBOCallback(event) {
                        if (event.data && event.data.type === 'QBO_CONNECTED') {
                            window.removeEventListener('message', handleQBOCallback);
                            checkQBOStatus();
                        }
                    });

                    // Poll for popup close
                    const pollTimer = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(pollTimer);
                            btn.disabled = false;
                            btn.innerHTML = '<span style="font-size: 16px;">üîó</span> Connect to QuickBooks';
                            // Check status after popup closes
                            setTimeout(() => checkQBOStatus(), 1000);
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Error connecting to QBO:', error);
                alert('Failed to initiate QuickBooks connection: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size: 16px;">üîó</span> Connect to QuickBooks';
            }
        }

        async function syncQuickBooks() {
            if (!currentQBOConnection) {
                alert('No QuickBooks connection found');
                return;
            }

            const btn = document.getElementById('btnSyncQBO');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size: 14px;">‚è≥</span> Syncing...';

            try {
                const response = await fetch(`${window.API_BASE}/qbo/sync/${currentQBOConnection.realm_id}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Sync failed');
                }

                const data = await response.json();

                alert(`Sync completed!\n\nImported: ${data.total_imported} expense lines\nTransactions:\n- Bills: ${data.transactions.bills}\n- Purchases: ${data.transactions.purchases}\n- Vendor Credits: ${data.transactions.vendor_credits}\n- Journal Entries: ${data.transactions.journal_entries}\n\nNew project mappings: ${data.new_project_mappings}`);

                // Update last sync time
                document.getElementById('qboSyncInfo').style.display = 'block';
                document.getElementById('qboLastSync').textContent = formatDate(new Date().toISOString());

            } catch (error) {
                console.error('Error syncing QBO:', error);
                alert('Sync failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        async function disconnectQuickBooks() {
            if (!currentQBOConnection) return;

            if (!confirm(`Are you sure you want to disconnect "${currentQBOConnection.company_name}" from QuickBooks?\n\nThis will remove the stored tokens. You'll need to re-authorize to sync expenses again.`)) {
                return;
            }

            const btn = document.getElementById('btnDisconnectQBO');
            btn.disabled = true;
            btn.textContent = 'Disconnecting...';

            try {
                const response = await fetch(`${window.API_BASE}/qbo/disconnect/${currentQBOConnection.realm_id}`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Disconnect failed');

                // Refresh status
                checkQBOStatus();
            } catch (error) {
                console.error('Error disconnecting QBO:', error);
                alert('Failed to disconnect: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Disconnect';
            }
        }

        function formatDate(isoString) {
            if (!isoString) return '‚Äî';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString;
            }
        }

        // ====== Initialize ======
        window.addEventListener("DOMContentLoaded", () => {
            console.log('[Settings] DOMContentLoaded fired');
            console.log('[Settings] API_BASE at init:', window.API_BASE);

            if (window.initTopbarPills) window.initTopbarPills();
            if (window.initSidebar) window.initSidebar();

            setTimeout(() => {
                document.getElementById('settingsLoadingState').style.display = 'none';
                document.getElementById('settingsContent').style.display = 'block';

                // Check QBO status and load budget alerts after content loads
                // Wait a bit more to ensure config.js has loaded
                console.log('[Settings] About to check QBO status, API_BASE:', window.API_BASE);
                if (window.API_BASE) {
                    checkQBOStatus();
                    loadBudgetAlertSettings();
                } else {
                    console.error('[Settings] API_BASE not defined! Check config.js loading.');
                    // Show error state
                    document.getElementById('qboLoadingState').style.display = 'none';
                    document.getElementById('qboErrorState').style.display = 'block';
                    document.getElementById('qboErrorMessage').textContent = 'Configuration not loaded. Please refresh the page.';
                }
            }, 600);
        });
    </script>

    <!-- Firebase Push Notifications -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
    <script src="assets/js/firebase-init.js"></script>
</body>
</html>
