<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1a1a1a" />
    <title>NGM HUB ‚Äî Estimator Suite</title>
    <link rel="icon" type="image/png" href="assets/img/greenblack_icon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="assets/img/greenblack_icon.png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    >

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/estimator_styles.css">
    <link rel="stylesheet" href="assets/css/toast.css">
    <link rel="stylesheet" href="assets/css/arturito_widget.css">

    <!-- Supabase JS Library for Storage -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Config (API_BASE, SUPABASE_URL, etc.) -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth-guard.js"></script>
    <script src="assets/js/toast.js"></script>
    <script src="assets/js/page-loading.js" defer></script>

    <!-- Critical CSS for loading overlay -->
    <style>
      body.page-loading { overflow: hidden; }
      .page-loading-overlay {
        position: fixed; inset: 0; background: #0d0d0d;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 9999; gap: 16px;
      }
      .page-loading-overlay.hidden { display: none; }
      .page-loading .app-layout { visibility: hidden; }
      .loading-logo { width: 160px; height: 160px; object-fit: contain; animation: pulse 1.5s ease-in-out infinite; }
      .loading-text { color: rgba(255,255,255,0.5); font-size: 13px; font-family: system-ui, sans-serif; letter-spacing: 0.05em; }
      @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }
    </style>
</head>

<body class="estimator-page page-loading">
    <!-- Page Loading Overlay -->
    <div class="page-loading-overlay" id="pageLoadingOverlay">
        <img src="assets/img/white_icon.png" class="loading-logo" alt="Loading...">
        <span class="loading-text">Loading...</span>
    </div>

    <div class="app-layout" id="main-app-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar estimator-sidebar">
            <div class="sidebar-logo">
                <img src="assets/img/logo.png" alt="NGM HUB" class="sidebar-logo-img">
            </div>

            <!-- Estimate Overview -->
            <div class="estimator-summary-card">
                <div class="summary-title">Estimate Overview</div>

                <div class="summary-block">
                    <div class="summary-label">Project</div>
                    <div class="summary-value" id="summary-project">(Untitled)</div>
                </div>

                <div class="summary-block">
                    <div class="summary-label">Subtotal</div>
                    <div class="summary-value summary-subtotal" id="summary-subtotal">$0</div>
                </div>

                <div class="summary-block">
                    <div class="summary-label">Total</div>
                    <div class="summary-value summary-total" id="summary-total">$0</div>
                </div>

                <div class="summary-block">
                    <div class="summary-label">Overhead</div>
                    <div class="summary-value" id="summary-overhead">‚Äî</div>
                </div>

                <div class="summary-block">
                    <div class="summary-label">Created</div>
                    <div class="summary-value" id="summary-date">‚Äî</div>
                </div>
            </div>

            <!-- Estimates List -->
            <div class="estimator-list-card">
                <div class="estimator-list-title">Estimates</div>
                <div class="estimator-files-wrapper">
                    <ul id="estimator-files-list" class="estimator-files-list">
                        <li class="estimator-file estimator-file--active">estimate.ngm</li>
                    </ul>
                </div>
            </div>

            <!-- Templates List -->
            <div class="estimator-list-card">
                <div class="estimator-list-title">Templates</div>
                <div class="estimator-files-wrapper">
                    <ul id="estimator-templates-list" class="estimator-files-list">
                        <li class="estimator-file" style="color: #6b7280; font-style: italic;">Loading...</li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <div class="main-area">
            <!-- TOPBAR -->
            <header class="ngm-topbar">
                <div class="ngm-bar-left">
                    <div class="ngm-brand">
                        <div class="ngm-brand-icon-small">
                            <img src="assets/img/white_icon.png" alt="NGM">
                        </div>
                        <div class="ngm-brand-text">
                            <span class="ngm-brand-org">Next Generation Management</span>
                            <span class="ngm-brand-context">NGM Hub ¬∑ Estimator Suite</span>
                        </div>
                    </div>
                </div>

                <div class="ngm-topbar-right">
                    <div class="ngm-meta">
                        <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment ¬∑ ‚Äî</span>
                        <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server ¬∑ ‚Äî</span>
                    </div>

                    <form class="ngm-search" role="search" onsubmit="return false;">
                        <span class="ngm-global-search-icon">‚åï</span>
                        <input
                            type="search"
                            id="estimator-search-input"
                            class="ngm-search-input"
                            placeholder="Filter by code, name, unit‚Ä¶"
                            aria-label="Filter estimator table"
                        />
                    </form>

                    <span id="user-pill" class="user-pill">User ¬∑ ‚Äî</span>
                </div>
            </header>

            <!-- MAIN CONTENT -->
            <main class="main-content">
                <!-- Header Bar (Project Title) -->
                <section class="estimator-header-bar">
                    <div class="estimator-title-block">
                        <div class="topbar-title editable-title">
                            <span id="project-title-text">Untitled Project</span>
                            <button id="project-info-btn" class="icon-button" title="Project info">
                                ‚ìò
                            </button>
                        </div>
                        <div class="topbar-subtitle" id="project-subtitle">
                            Loaded from <code>estimate.ngm</code>.
                        </div>
                    </div>
                </section>

                <!-- TOOLBAR -->
                <section class="estimator-toolbar">
                    <div class="toolbar-left">
                        <button class="btn-primary" id="btn-new-estimate" title="Create New Estimate">
                            <span class="btn-icon">+</span> New Estimate
                        </button>
                        <button class="btn-secondary" id="btn-add-concept">Add Concept</button>
                        <button class="btn-secondary" id="btn-overhead">Overhead</button>
                        <button class="btn-secondary" id="btn-import-revit">Import from Revit</button>
                        <button class="btn-secondary" id="btn-export">Export</button>
                        <button class="btn-secondary" id="btn-columns">Columns</button>
                        <button class="btn-secondary" id="btn-refresh-catalog" title="Refresh concepts and materials from database">
                            Refresh Catalog
                        </button>
                    </div>

                    <div class="toolbar-right">
                        <!-- Save buttons -->
                        <div class="estimator-save-controls">
                            <button class="btn-secondary" id="btn-save-as-template" title="Save as Template">
                                <span class="btn-icon">üìÑ</span> Save as Template
                            </button>
                            <button class="btn-primary" id="btn-save" title="Sync to Cloud (auto-saves locally)">
                                <span class="btn-icon">‚òÅÔ∏è</span> Sync
                            </button>
                        </div>

                        <!-- View Controls -->
                        <div class="estimator-view-controls">
                            <label class="view-control">
                                Width
                                <input
                                    type="range"
                                    id="table-width-slider"
                                    min="60"
                                    max="100"
                                    value="100"
                                />
                            </label>

                            <label class="view-control">
                                Zoom
                                <input
                                    type="range"
                                    id="table-zoom-slider"
                                    min="90"
                                    max="120"
                                    value="100"
                                />
                            </label>
                        </div>
                    </div>
                </section>

                <!-- MAIN TABLE PANEL -->
                <section class="estimator-main-panel">
                    <div class="panel panel-narrow estimator-panel">
                        <div id="estimator-status" class="table-lock-label" style="margin-bottom: 8px;">
                            Loading...
                        </div>

                        <div class="table-wrapper estimator-table-wrapper">
                            <table class="table estimator-table">
                                <thead>
                                    <tr>
                                        <th class="col-code" style="width: 90px;">Code</th>
                                        <th class="col-image" style="width: 80px;">Image</th>
                                        <th class="col-name">Category / Subcategory / Concept</th>
                                        <th class="col-qty" style="width: 90px;">QTY</th>
                                        <th class="col-unit" style="width: 110px;">Unit</th>
                                        <th class="col-unit-cost" style="width: 120px;">Unit Cost</th>
                                        <th class="col-subtotal" style="width: 120px;">Subtotal</th>
                                        <th class="col-total" style="width: 140px;">Total</th>
                                    </tr>
                                </thead>

                                <tbody id="estimator-body">
                                    <tr>
                                        <td colspan="8" class="table-cell-muted">
                                            Loading‚Ä¶
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="estimator-feedback" class="estimator-feedback"></div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- =========================================================
         MODAL: PROJECT INFO
    ========================================================== -->
    <div id="project-modal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Project Info</div>
                    <button type="button" class="modal-btn header-action" id="manage-info-btn">
                        Manage info
                    </button>
                </div>

                <form id="project-form" class="modal-form">
                    <div>
                        <div class="field-label">Project Name</div>
                        <input type="text" id="project-name-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Address</div>
                        <input type="text" id="project-address-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Project Type</div>
                        <input type="text" id="project-type-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Total Area (SqFt)</div>
                        <input type="text" id="project-total-area-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Habitable Area (SqFt)</div>
                        <input type="text" id="project-habitable-area-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Non Habitable Area (SqFt)</div>
                        <input type="text" id="project-nonhabitable-area-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Footings Type</div>
                        <input type="text" id="project-footings-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Number of Rooms</div>
                        <input type="text" id="project-rooms-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Number of Bathrooms</div>
                        <input type="text" id="project-baths-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Number of Units</div>
                        <input type="text" id="project-units-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Foundation Type</div>
                        <input type="text" id="project-foundation-input" class="input" />
                    </div>
                    <div>
                        <div class="field-label">Date</div>
                        <input type="date" id="project-date-input" class="input" />
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="modal-btn cancel" id="project-cancel-btn">
                            Close
                        </button>
                        <button type="submit" class="modal-btn" id="project-save-btn">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- =========================================================
         MODAL: COLUMNS
    ========================================================== -->
    <div id="columns-modal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-title">Visible Columns</div>

                <form id="columns-form" class="modal-form">
                    <label class="field-label">
                        <input type="checkbox" data-col="code" checked />
                        Code
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="image" checked />
                        Image
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="name" checked />
                        Category / Concept
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="qty" checked />
                        QTY
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="unit" checked />
                        Unit
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="unit-cost" checked />
                        Unit Cost
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="subtotal" checked />
                        Subtotal
                    </label>
                    <label class="field-label">
                        <input type="checkbox" data-col="total" checked />
                        Total
                    </label>

                    <div class="modal-footer">
                        <button type="button" class="modal-btn cancel" id="columns-cancel-btn">
                            Cancel
                        </button>
                        <button type="submit" class="modal-btn">
                            Apply
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- =========================================================
         MODAL: SAVE AS TEMPLATE
    ========================================================== -->
    <div id="save-as-template-modal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Save as Template</div>
                    <button type="button" class="modal-btn header-action" onclick="document.getElementById('save-as-template-modal').classList.add('hidden')">
                        √ó
                    </button>
                </div>

                <form id="save-as-template-form" class="modal-form" style="grid-template-columns: 1fr;">
                    <div>
                        <div class="field-label">Template Name *</div>
                        <input
                            type="text"
                            id="template-name-input"
                            class="input"
                            placeholder="e.g., Residential Single Family"
                            required
                        />
                    </div>

                    <div>
                        <div class="field-label">Description</div>
                        <textarea
                            id="template-description-input"
                            class="input"
                            rows="3"
                            placeholder="Brief description of this template..."
                            style="resize: vertical; min-height: 80px;"
                        ></textarea>
                    </div>

                    <div class="template-save-info" style="background: rgba(62, 207, 142, 0.1); border: 1px solid rgba(62, 207, 142, 0.3); border-radius: 8px; padding: 12px; margin-top: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #9ca3af;">
                            <strong style="color: #3ecf8e;">Note:</strong> The template will include the current category structure and all concepts, but project-specific data (address, date) will be cleared.
                        </p>
                    </div>

                    <div class="modal-footer" style="margin-top: 16px;">
                        <button type="button" class="modal-btn cancel" id="template-cancel-btn">
                            Cancel
                        </button>
                        <button type="submit" class="modal-btn">
                            <span style="margin-right: 6px;">üìÑ</span> Save Template
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- =========================================================
         MODAL: TEMPLATE PICKER (New Estimate)
    ========================================================== -->
    <div id="template-picker-modal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Create New Estimate</div>
                    <button type="button" class="modal-btn header-action" id="template-picker-close">
                        √ó
                    </button>
                </div>

                <div class="template-picker-body">
                    <!-- Option: Blank Estimate -->
                    <div class="template-option template-option--blank" id="template-option-blank">
                        <div class="template-option-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                        </div>
                        <div class="template-option-content">
                            <div class="template-option-title">Blank Estimate</div>
                            <div class="template-option-desc">Start from scratch with an empty estimate</div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="template-picker-divider">
                        <span>or choose a template</span>
                    </div>

                    <!-- Templates List -->
                    <div class="template-picker-list" id="template-picker-list">
                        <div class="template-picker-loading">
                            <span class="spinner"></span>
                            Loading templates...
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="modal-btn cancel" id="template-picker-cancel">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================================
         MODAL: ADD CONCEPT TO ESTIMATE
    ========================================================== -->
    <div id="add-concept-modal" class="modal-backdrop hidden">
        <div class="modal" style="width: min(900px, 90vw);">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Add Concept to Estimate</div>
                    <button type="button" class="modal-btn header-action" id="add-concept-close">
                        X
                    </button>
                </div>

                <div class="add-concept-body">
                    <!-- Search and filters -->
                    <div class="concept-picker-toolbar">
                        <input type="text" id="concept-picker-search" class="input"
                               placeholder="Search concepts by code or name..."
                               style="flex: 1; max-width: 400px;" />
                        <div class="concept-picker-filters">
                            <select id="concept-picker-category" class="input" style="width: 150px;">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>

                    <!-- Concepts table -->
                    <div class="concept-picker-table-wrapper">
                        <table class="concept-picker-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Code</th>
                                    <th>Description</th>
                                    <th style="width: 70px;">Unit</th>
                                    <th style="width: 100px;">Base Cost</th>
                                    <th style="width: 80px;">Types</th>
                                </tr>
                            </thead>
                            <tbody id="concept-picker-body">
                                <tr>
                                    <td colspan="5" class="table-cell-muted" style="text-align: center; padding: 40px;">
                                        Loading concepts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Preview panel -->
                    <div class="concept-preview-panel" id="concept-preview-panel">
                        <div class="preview-header">
                            <h4>Concept Details</h4>
                        </div>
                        <div id="concept-preview-content" class="preview-content">
                            <p class="preview-empty">Select a concept from the table to see its details and line items.</p>
                        </div>
                    </div>

                    <!-- Quantity and options row -->
                    <div class="concept-add-options">
                        <div class="option-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" id="add-concept-qty" class="input"
                                   value="1" min="0.001" step="0.001" style="width: 100px;" />
                        </div>
                        <div class="option-group">
                            <label class="form-label">Target Category</label>
                            <select id="add-concept-target-category" class="input" style="width: 200px;">
                                <option value="">Auto (from concept)</option>
                            </select>
                        </div>
                        <div class="option-group" style="align-self: flex-end;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="add-concept-save-to-db" />
                                Also save to database
                            </label>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="modal-btn cancel" id="add-concept-cancel">
                        Cancel
                    </button>
                    <button type="button" class="modal-btn" id="add-concept-confirm" disabled>
                        Add to Estimate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================================
         SCRIPTS
    ========================================================== -->
    <script src="assets/js/pills.js" defer></script>
    <script src="assets/js/estimator.js" defer></script>
    <script src="assets/js/arturito_widget.js" defer></script>

    <!-- Firebase Push Notifications -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
    <script src="assets/js/firebase-init.js"></script>
</body>
</html>
