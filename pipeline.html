<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a1a1a" />
  <title>NGM HUB — Pipeline Manager</title>
  <link rel="icon" type="image/png" href="assets/img/greenblack_icon_192.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="assets/img/greenblack_icon_192.png" />

  <!-- Preload loading logo for instant display -->
  <link rel="preload" href="assets/img/white_icon.png" as="image" />

  <!-- Fonts: Inter + Roboto (NGM standard) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet"
  />

  <!-- Base layout + Pipeline styles -->
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/expenses_styles.css" />
  <link rel="stylesheet" href="assets/css/pipeline_styles.css" />
  <link rel="stylesheet" href="assets/css/toast.css" />
  <link rel="stylesheet" href="assets/css/arturito_widget.css" />
  <script src="assets/js/config.js"></script>
  <script src="assets/js/auth-guard.js"></script>
  <script src="assets/js/toast.js" defer></script>
  <script src="assets/js/permissions.js" defer></script>
  <script src="assets/js/pills.js" defer></script>
  <script src="assets/js/sidebar.js" defer></script>
</head>
<body class="page-pipeline page-loading">
    <!-- Page Loading Overlay -->
    <div class="page-loading-overlay" id="pageLoadingOverlay">
        <img src="assets/img/white_icon.png" class="loading-logo loading-logo-xl" alt="Loading...">
        <span class="loading-text">Loading...</span>
    </div>

    <div class="app-layout">
        <!-- Sidebar (content generated by sidebar.js) -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Zona principal -->
        <div class="main-area">
<!-- Topbar igual al dashboard -->
<header class="ngm-topbar">
  <!-- LEFT: brand / contexto -->
  <div class="ngm-bar-left">
    <div class="ngm-brand">
      <div class="ngm-brand-icon-small">
        <img src="assets/img/white_icon.png" alt="NGM">
      </div>
      <div class="ngm-brand-text">
        <span class="ngm-brand-org">Next Generation Management</span>
        <span class="ngm-brand-context">NGM Hub · Pipeline Manager</span>
      </div>
    </div>
  </div>

  <!-- RIGHT: meta + search + user -->
  <div class="ngm-topbar-right">
    <div class="ngm-meta">
      <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment · —</span>
      <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server · —</span>
    </div>

    <!-- Search bar -->
    <form class="ngm-search" role="search" onsubmit="return false;">
      <span class="ngm-global-search-icon">⌕</span>
      <input
        id="pipeline-search-input"
        type="search"
        class="ngm-search-input"
        placeholder="Search…"
        aria-label="Search"
      />
    </form>

    <!-- Usuario / rol -->
    <span id="user-pill" class="user-pill">User · —</span>
  </div>
</header>


        <main class="main-content">
            <section class="pipeline-section">

                <!-- ✅ Wrapper interno del pipeline -->
                <div class="pm-panel">

                    <!-- TOOLBAR dividida en 2 cards -->
                    <div class="pm-toolbar-grid">
                        <!-- Card 1: filtros -->
                        <div class="pm-toolbar-card pm-toolbar-card--filters">
                            <div class="pm-toolbar-card-header">
                                <span class="section-title">Filters</span>
                            </div>
                            <div class="pm-toolbar-card-body">
                                <div class="pm-filters">
                                    <label class="filter-label">
                                        Project
                                        <select id="project-filter" class="ngm-select ngm-select--compact">
                                            <option value="all">All</option>
                                        </select>
                                    </label>

                                    <label class="filter-label">
                                        Owner
                                        <select id="owner-filter" class="ngm-select ngm-select--compact">
                                            <option value="all">All</option>
                                        </select>
                                    </label>

                                    <label class="filter-label">
                                        Priority
                                        <select id="priority-filter" class="ngm-select ngm-select--compact">
                                            <option value="all">All</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: layout + manage mode -->
                        <div class="pm-toolbar-card pm-toolbar-card--layout">
                            <div class="pm-toolbar-card-header">
                                <span class="section-title">Layout</span>
                            </div>
                            <div class="pm-toolbar-card-body pm-toolbar-layout-body">
                                <div class="pm-layout-actions">
                                    <button id="btnNewTask" type="button" class="pm-btn pm-btn-secondary btn-small">
                                     <span class="pm-btn-icon">＋</span>
                                     <span>New Task</span>
                                    </button>

                                    <button id="btnAutomations" type="button" class="pm-btn pm-btn-secondary btn-small">
                                        <span>Automations</span>
                                    </button>

                                    <button
                                        id="btnManageLayout"
                                        type="button"
                                        class="pm-btn pm-btn-secondary btn-small"
                                    >
                                        <span class="pm-btn-icon">⚙</span>
                                        <span>Manage Layout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wrapper de grupos de pipeline -->
                    <div id="pm-groups-wrapper" class="pm-groups-wrapper">
                        <!-- Groups se renderizan por JS -->
                    </div>

                </div>
            </section>
        </main>
    </div>
</div>

<!-- Modal: Manage layout (estilo global como Estimator) -->
<div id="layoutModal" class="modal-backdrop hidden">

  <div class="modal">

    <div class="modal-header">
      <div class="modal-title">Manage Layout</div>
      <button type="button" class="modal-btn header-action" id="btnCloseLayoutModal">×</button>
    </div>

    <div class="modal-body">

        <!-- Ancho del panel / tabla -->
        <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Panel width</h3>

        <div class="pm-width-control">
            <span class="pm-width-control-label">Min table width</span>
            <input
            id="pm-width-slider"
            class="pm-width-slider"
            type="range"
            min="1000"
            max="2500"
            step="50"
            value="1200"
            />
            <span id="pm-width-value" class="pm-width-control-value">1200px</span>
        </div>
        </section>


      <!-- Grupos visibles -->
      <section class="pm-modal-section">
        <h3 class="pm-modal-section-title">Visible groups</h3>
        <div class="pm-checkbox-grid">
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="not started" />
            <span>Not Started</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="working on it" />
            <span>Working on It</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="awaiting approval" />
            <span>Awaiting Approval</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="good to go" />
            <span>Good to Go</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="correction" />
            <span>Correction</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="resubmittal needed" />
            <span>Resubmittal needed</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="done" />
            <span>Done</span>
          </label>
          <label class="pm-checkbox">
            <input type="checkbox" data-group-key="delayed" />
            <span>Delayed</span>
          </label>
        </div>
      </section>

    
    <!-- Columnas visibles -->
    <section class="pm-modal-section">
    <h3 class="pm-modal-section-title">Visible columns</h3>

    <!--
        ⚠️ IMPORTANTE:
        Este contenedor se llena dinámicamente desde JS
        usando la definición global COLUMNS
    -->
    <div
        id="pm-columns-list"
        class="pm-checkbox-grid pm-checkbox-grid--columns"
    ></div>
    </section>


    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="btnCancelLayout">Cancel</button>
      <button type="button" class="btn-primary" id="btnApplyLayout">Apply</button>
    </div>

  </div>
</div>

    <!-- Root donde vamos a inyectar modales (partials) -->
    <div id="modals-root"></div>

    <!-- Shared utilities for Pipeline module -->
    <script src="assets/js/pipeline_utils.js"></script>
    <!-- People Picker component (Monday.com style) -->
    <script src="assets/js/pipeline_people_picker.js"></script>
    <!-- Catalog Picker component (Monday.com style) -->
    <script src="assets/js/pipeline_catalog_picker.js"></script>

    <!-- UI handlers del modal (abre/cierra/bind) -->
    <script src="assets/js/pipeline_new_task_ui.js"></script>

    <!-- Edit Task Modal UI -->
    <script src="assets/js/pipeline_edit_task_ui.js"></script>

    <!-- Links Modal UI -->
    <script src="assets/js/pipeline_links_modal.js"></script>

    <!-- Carga del partial + bind SOLO cuando ya existe en el DOM -->
    <script type="module">
     import { loadHtmlFragment } from "./assets/js/html_loader.js";

    // Load New Task Modal
    loadHtmlFragment("./partials/new_task_modal.html", "#modals-root")
        .then(() => {
         console.log("[PARTIAL] New Task modal loaded");
         window.PM_NewTask?.bind();
        })
        .catch((err) => console.error("[PARTIAL] New Task load failed:", err));

    // Load Edit Task Modal
    loadHtmlFragment("./partials/edit_task_modal.html", "#modals-root")
        .then(() => {
         console.log("[PARTIAL] Edit Task modal loaded");
         window.PM_EditTask?.bind();
        })
        .catch((err) => console.error("[PARTIAL] Edit Task load failed:", err));

    // Load Automations Modal
    loadHtmlFragment("./partials/automations_modal.html", "#modals-root")
        .then(() => {
         console.log("[PARTIAL] Automations modal loaded");
         window.PM_Automations?.bind();
        })
        .catch((err) => console.error("[PARTIAL] Automations load failed:", err));

    // Load Links Modal
    loadHtmlFragment("./partials/links_modal.html", "#modals-root")
        .then(() => {
         console.log("[PARTIAL] Links modal loaded");
         window.PM_LinksModal?.bind();
        })
        .catch((err) => console.error("[PARTIAL] Links modal load failed:", err));
    </script>

    <script src="assets/js/pipeline_table_interactions.js"></script>
    <script src="assets/js/pipeline_automations.js"></script>
    <script src="assets/js/pipeline.js" defer></script>
    <script src="assets/js/pipeline_layout.js"></script>
    <script src="assets/js/arturito_widget.js"></script>

    <!-- Supabase Realtime -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/pipeline_realtime.js"></script>

    <!-- Firebase Push Notifications -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
    <script src="assets/js/firebase-init.js"></script>
</body>
</html>
