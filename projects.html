<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NGM HUB ‚Äî Projects</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    >

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/projects.css" />

    <!-- Global env/server/user pills -->
    <script src="assets/js/config.js" defer></script>
    <script src="assets/js/pills.js" defer></script>
</head>
<body class="page-projects">
    <div class="app-layout">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="assets/img/logo.png" alt="NGM HUB Logo" class="sidebar-logo-img" />
            </div>

            <div class="sidebar-title-block">
                <p class="sidebar-title">NGM HUB</p>
                <p class="sidebar-subtitle">Projects</p>
            </div>

            <div class="sidebar-nav-card">
                <nav class="sidebar-nav" id="sidebar-nav">
                    <a href="dashboard.html" class="nav-item">Dashboard</a>
                    <a href="expenses.html" class="nav-item">Expenses Engine</a>
                    <a href="pipeline.html" class="nav-item">Pipeline Manager</a>
                    <a href="projects.html" class="nav-item nav-item-active">Projects</a>
                    <a href="estimator.html" class="nav-item">Estimator Suite</a>
                    <a href="team.html" class="nav-item">Team Management</a>
                </nav>
            </div>
        </aside>

        <!-- Main -->
        <div class="main-area">

            <!-- Topbar (system standard) -->
            <header class="ngm-topbar">
                <div class="ngm-bar-left">
                    <div class="ngm-brand">
                        <div class="ngm-brand-icon-small"><span>‚ö°</span></div>
                        <div class="ngm-brand-text">
                            <span class="ngm-brand-org">Next Generation Management</span>
                            <span class="ngm-brand-context">NGM Hub ¬∑ Projects Manager</span>
                        </div>
                    </div>
                </div>

                <div class="ngm-topbar-right">
                    <div class="ngm-meta">
                        <span id="env-pill" class="ngm-meta-pill ngm-meta-env">Environment ¬∑ ‚Äî</span>
                        <span id="server-pill" class="ngm-meta-pill ngm-meta-status ngm-meta-status-live">Server ¬∑ ‚Äî</span>
                    </div>

                    <form class="ngm-search" role="search" onsubmit="return false;">
                        <span class="ngm-global-search-icon">‚åï</span>
                        <input
                            id="projects-search-input"
                            type="search"
                            class="ngm-search-input"
                            placeholder="Search projects..."
                            aria-label="Search projects"
                        />
                    </form>

                    <span id="user-pill" class="user-pill">User ¬∑ ‚Äî</span>
                </div>
            </header>

            <main class="main-content">
                <div class="workspace">

                    <!-- Projects List -->
                    <section class="data-section">
                        <h2 class="section-title">Projects</h2>

                        <!-- Projects rendered as cards -->
                        <div id="projectsList" class="projects-list">
                            <div class="projects-loading">Loading projects...</div>
                        </div>

                        <!-- Manage button -->
                        <div class="projects-actions">
                            <button id="manageProjectsBtn" class="btn-secondary">
                                Manage Projects
                            </button>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>

    <script>
    // =============================
    // Configuraci√≥n de la API
    // =============================
    const API_BASE = "https://ngm-backend.onrender.com";
    const listContainer = document.getElementById("projectsList");
    const manageBtn = document.getElementById("manageProjectsBtn");

    // Estado en memoria
    let projects = [];
    let isManaging = false;

    // Cat√°logos
    let companiesOptions = [];
    let statusOptions = [];

    // =============================
    // Helpers de UI
    // =============================

    function renderStatusPill(statusValue) {
        const text = (statusValue || "").toString();
        const normalized = text.trim().toLowerCase();
        const isActive = normalized === "active";
        const classes = isActive ? "status-pill status-pill--active" : "status-pill";
        return `<span class="${classes}">${text || "‚Äî"}</span>`;
    }

    function buildCompanySelect(index, selectedId) {
        const optionsHtml = companiesOptions.map(c => {
            const sel = c.company_id === selectedId ? "selected" : "";
            return `<option value="${c.company_id}" ${sel}>${c.name}</option>`;
        }).join("");
        return `<select class="cell-input" data-index="${index}" data-field="source_company">${optionsHtml}</select>`;
    }

    function buildStatusSelect(index, selectedId) {
        const optionsHtml = statusOptions.map(s => {
            const sel = s.status_id === selectedId ? "selected" : "";
            return `<option value="${s.status_id}" ${sel}>${s.status}</option>`;
        }).join("");
        return `<select class="cell-input" data-index="${index}" data-field="status">${optionsHtml}</select>`;
    }

    function findCompanyNameById(id) {
        const item = companiesOptions.find(c => c.company_id === id);
        return item ? item.name : "‚Äî";
    }

    function findStatusNameById(id) {
        const item = statusOptions.find(s => s.status_id === id);
        return item ? item.status : "";
    }

    // =============================
    // Cargar META (companies + statuses)
    // =============================
    async function loadMeta() {
        try {
            const res = await fetch(`${API_BASE}/projects/meta`);
            if (!res.ok) {
                console.error("Error loading meta:", await res.text());
                return;
            }
            const json = await res.json();
            companiesOptions = json.companies || [];
            statusOptions = json.statuses || [];
        } catch (err) {
            console.error("Network error loading meta:", err);
        }
    }

    // =============================
    // Cargar proyectos desde la API
    // =============================
    async function loadProjects() {
        listContainer.innerHTML = `<div class="projects-loading">Loading projects...</div>`;

        try {
            const res = await fetch(`${API_BASE}/projects/`);
            if (!res.ok) {
                const text = await res.text();
                listContainer.innerHTML = `<div class="projects-empty">Error: ${text}</div>`;
                return;
            }

            const json = await res.json();
            projects = json.data || [];
            renderProjects();
        } catch (err) {
            console.error(err);
            listContainer.innerHTML = `<div class="projects-empty">Network or server error.</div>`;
        }
    }

    // =============================
    // Render de cards
    // =============================
    function renderProjects() {
        listContainer.innerHTML = "";

        if (!projects.length && !isManaging) {
            listContainer.innerHTML = `
                <div class="projects-empty">
                    <span class="projects-empty-icon">üìÅ</span>
                    <span>No projects found</span>
                </div>
            `;
            return;
        }

        projects.forEach((p, index) => {
            const id = p.project_id || "(no id)";
            const name = p.project_name || "(no name)";
            const companyId = p.source_company || null;
            const companyName = p.company_name || findCompanyNameById(companyId) || "‚Äî";
            const client = p.client_name || p.client || "‚Äî";
            const city = p.city || "‚Äî";
            const statusId = p.status || null;
            const statusName = p.status_name || findStatusNameById(statusId) || "";

            const card = document.createElement("div");
            card.className = "project-card";

            if (!isManaging) {
                // MODO LECTURA
                card.innerHTML = `
                    <div class="project-card-content">
                        <div>
                            <span class="project-card-meta-label">Project</span>
                            <p class="project-card-name">${name}</p>
                        </div>
                        <div class="project-card-meta">
                            <span class="project-card-meta-label">Company</span>
                            ${companyName}
                        </div>
                        <div class="project-card-meta">
                            <span class="project-card-meta-label">City</span>
                            ${city}
                        </div>
                        <div class="project-card-meta">
                            <span class="project-card-meta-label">Client</span>
                            ${client}
                        </div>
                        <div>
                            ${renderStatusPill(statusName)}
                        </div>
                    </div>
                    <div class="project-card-actions">
                        <button class="btn-small" disabled>View</button>
                    </div>
                `;
            } else {
                // MODO EDICI√ìN
                card.innerHTML = `
                    <div class="project-card-content">
                        <div>
                            <span class="project-card-meta-label">Project Name</span>
                            <input type="text" class="cell-input" data-index="${index}" data-field="project_name" value="${name}">
                        </div>
                        <div>
                            <span class="project-card-meta-label">Company</span>
                            ${buildCompanySelect(index, companyId)}
                        </div>
                        <div>
                            <span class="project-card-meta-label">City</span>
                            <input type="text" class="cell-input" data-index="${index}" data-field="city" value="${city}">
                        </div>
                        <div>
                            <span class="project-card-meta-label">Client</span>
                            <span class="project-card-meta">${client}</span>
                        </div>
                        <div>
                            <span class="project-card-meta-label">Status</span>
                            ${buildStatusSelect(index, statusId)}
                        </div>
                    </div>
                    <div class="project-card-actions">
                        <button class="btn-small delete-btn" data-index="${index}">Delete</button>
                    </div>
                `;
            }

            listContainer.appendChild(card);
        });

        // Card para agregar nuevo proyecto en modo Manage
        if (isManaging) {
            const newCard = document.createElement("div");
            newCard.className = "project-card project-card--new";

            const companySelectNew = companiesOptions.length
                ? `<select class="cell-input" id="new-project-company">
                    <option value="">Select company</option>
                    ${companiesOptions.map(c => `<option value="${c.company_id}">${c.name}</option>`).join("")}
                   </select>`
                : `<span class="project-card-meta">No companies</span>`;

            const statusSelectNew = statusOptions.length
                ? `<select class="cell-input" id="new-project-status">
                    ${statusOptions.map(s => `<option value="${s.status_id}">${s.status}</option>`).join("")}
                   </select>`
                : `<span class="project-card-meta">No statuses</span>`;

            newCard.innerHTML = `
                <div class="project-card-content">
                    <div>
                        <span class="project-card-meta-label">Project Name</span>
                        <input type="text" class="cell-input" id="new-project-name" placeholder="New project name">
                    </div>
                    <div>
                        <span class="project-card-meta-label">Company</span>
                        ${companySelectNew}
                    </div>
                    <div>
                        <span class="project-card-meta-label">City</span>
                        <input type="text" class="cell-input" id="new-project-city" placeholder="City">
                    </div>
                    <div>
                        <span class="project-card-meta-label">Client</span>
                        <span class="project-card-meta">‚Äî</span>
                    </div>
                    <div>
                        <span class="project-card-meta-label">Status</span>
                        ${statusSelectNew}
                    </div>
                </div>
                <div class="project-card-actions">
                    <button class="btn-primary-small add-new-btn">Add Project</button>
                </div>
            `;
            listContainer.appendChild(newCard);
        }
    }

    // =============================
    // Save changes to backend
    // =============================
    let originalProjects = []; // Store original data

    async function saveAllChanges() {
        const updates = [];

        // Compare current projects with original to find changes
        for (let i = 0; i < projects.length; i++) {
            const current = projects[i];
            const original = originalProjects[i];

            if (!original) continue; // Skip new projects

            // Check if any field changed
            const hasChanges =
                current.project_name !== original.project_name ||
                current.city !== original.city ||
                current.source_company !== original.source_company ||
                current.status !== original.status;

            if (hasChanges) {
                updates.push({
                    id: current.project_id,
                    data: {
                        project_name: current.project_name,
                        city: current.city || null,
                        source_company: current.source_company,
                        status: current.status
                    }
                });
            }
        }

        if (updates.length === 0) {
            return; // No changes to save
        }

        // Disable button while saving
        manageBtn.disabled = true;
        manageBtn.textContent = "Saving...";

        try {
            // Send PATCH request for each changed project
            for (const update of updates) {
                const res = await fetch(`${API_BASE}/projects/${update.id}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(update.data)
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Error updating project: ${errText}`);
                }
            }

            alert(`${updates.length} project(s) updated successfully!`);

            // Reload projects from backend to ensure sync
            await loadProjects();

        } catch (err) {
            console.error("Error saving changes:", err);
            alert("Error saving changes: " + err.message);
        } finally {
            manageBtn.disabled = false;
        }
    }

    // =============================
    // Toggle Manage Mode
    // =============================
    manageBtn.addEventListener("click", async () => {
        if (isManaging) {
            // Switching from Manage to Read - save changes
            await saveAllChanges();
            isManaging = false;
            manageBtn.textContent = "Manage Projects";
        } else {
            // Switching from Read to Manage - store original data
            originalProjects = JSON.parse(JSON.stringify(projects));
            isManaging = true;
            manageBtn.textContent = "Done";
        }

        renderProjects();
    });

    // =============================
    // Edici√≥n en celdas (local)
    // =============================
    function handleCellEdit(target) {
        if (!target.classList.contains("cell-input")) return;
        const index = target.dataset.index;
        const field = target.dataset.field;
        const value = target.value;
        if (index === undefined || field === undefined) return;
        const idx = Number(index);
        if (!projects[idx]) return;

        if (field === "project_name") {
            projects[idx].project_name = value;
        } else if (field === "city") {
            projects[idx].city = value;
        } else if (field === "source_company") {
            projects[idx].source_company = value;
            projects[idx].company_name = findCompanyNameById(value);
        } else if (field === "status") {
            projects[idx].status = value;
            projects[idx].status_name = findStatusNameById(value);
        }
    }

    listContainer.addEventListener("input", (e) => handleCellEdit(e.target));
    listContainer.addEventListener("change", (e) => handleCellEdit(e.target));

    // =============================
    // Clicks en botones
    // =============================
    listContainer.addEventListener("click", async (e) => {
        // Agregar nuevo proyecto -> POST al backend
        if (e.target.classList.contains("add-new-btn")) {
            const nameInput = document.getElementById("new-project-name");
            const cityInput = document.getElementById("new-project-city");
            const companySelect = document.getElementById("new-project-company");
            const statusSelect = document.getElementById("new-project-status");

            const name = nameInput?.value.trim() || "";
            const city = cityInput?.value.trim() || "";
            const companyId = companySelect?.value || null;
            const statusId = statusSelect?.value || null;

            if (!name) {
                alert("Project name is required.");
                return;
            }

            if (!companyId) {
                alert("Company is required.");
                return;
            }

            // Deshabilitar bot√≥n mientras se guarda
            e.target.disabled = true;
            e.target.textContent = "Saving...";

            try {
                const res = await fetch(`${API_BASE}/projects/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        project_name: name,
                        source_company: companyId,
                        city: city || null,
                        status: statusId || null
                    })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(errText);
                }

                // Limpiar inputs y recargar tabla desde el servidor
                if (nameInput) nameInput.value = "";
                if (cityInput) cityInput.value = "";
                await loadProjects();

            } catch (err) {
                console.error("Error creating project:", err);
                alert("Error creating project: " + err.message);
            } finally {
                e.target.disabled = false;
                e.target.textContent = "Add Project";
            }
        }

        // Eliminar proyecto -> DELETE al backend
        if (e.target.classList.contains("delete-btn")) {
            const index = e.target.dataset.index;
            const idx = Number(index);
            if (!projects[idx]) return;

            const projectId = projects[idx].project_id;
            const projectName = projects[idx].project_name;

            const confirmed = confirm(`Delete project "${projectName}"? This cannot be undone.`);
            if (!confirmed) return;

            e.target.disabled = true;
            e.target.textContent = "...";

            try {
                const res = await fetch(`${API_BASE}/projects/${projectId}`, {
                    method: "DELETE"
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(errText);
                }

                await loadProjects();

            } catch (err) {
                console.error("Error deleting project:", err);
                alert("Error deleting project: " + err.message);
                e.target.disabled = false;
                e.target.textContent = "Delete";
            }
        }
    });

    // =============================
    // Init (cargar primero meta y luego projects)
    // =============================
    async function init() {
        await loadMeta();
        await loadProjects();
    }

    init();
    </script>

    <script>
        window.addEventListener("DOMContentLoaded", () => {
            if (window.initTopbarPills) window.initTopbarPills();
            if (window.initSidebar) window.initSidebar();
        });
    </script>

</body>
</html>
