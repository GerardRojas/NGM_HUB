<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NGM HUB â€” Pipeline Manager</title>

    <!-- mismas fuentes que login / dashboard -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link 
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" 
      rel="stylesheet"
    >

    <!-- Estilos base + dashboard + pipeline -->
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
    <link rel="stylesheet" href="assets/css/pipeline_styles.css" />
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar con mÃ³dulos dinÃ¡micos -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img 
                    src="assets/img/logo.png" 
                    alt="NGM HUB Logo"
                    class="sidebar-logo-img"
                />
            </div>
            <div class="sidebar-title-block">
                <p class="sidebar-title">NGM HUB</p>
                <p class="sidebar-subtitle">Master Dashboard</p>
            </div>

            <nav class="sidebar-nav" id="sidebar-nav">
                <!-- MÃ³dulos se inyectan desde JS -->
            </nav>
        </aside>

        <!-- Zona principal -->
        <div class="main-area">
            <!-- Topbar igual al dashboard -->
            <header class="topbar topbar-dashboard">
                <div class="topbar-left global-bar-left">
                    <div class="global-brand">
                        <div class="brand-icon-small">
                            <span>âš¡</span>
                        </div>
                        <div class="brand-text">
                            <span class="brand-org">Next Generation Management</span>
                            <span class="brand-context">NGM Hub Â· Pipeline Manager</span>
                        </div>
                    </div>
                </div>

                <div class="topbar-right dashboard-topbar-right">
                    <div class="dashboard-meta">
                        <span class="meta-pill meta-env">Environment Â· Local</span>
                        <span class="meta-pill meta-status meta-status-live">API Â· 127.0.0.1:8000</span>
                    </div>

                    <form class="dashboard-search" role="search" onsubmit="return false;">
                        <span class="dashboard-search-icon">âŒ•</span>
                        <input
                            id="pipeline-search-input"
                            type="search"
                            class="dashboard-search-input"
                            placeholder="Search tasks, projects or ownersâ€¦"
                            aria-label="Search"
                        />
                    </form>

                    <span id="user-pill" class="user-pill">User Â· Role</span>
                </div>
            </header>

            <!-- Contenido principal: solo Ã¡rea Ãºtil del pipeline -->
            <main class="main-content">
                <section class="pipeline-section">
                    <section class="data-section">
                        <!-- TOOLBAR dividida en 2 cards -->
                        <div class="pm-toolbar-grid">
                            <!-- Card 1: filtros -->
                            <div class="pm-toolbar-card pm-toolbar-card--filters">
                                <div class="pm-toolbar-card-header">
                                    <span class="section-title">Filters</span>
                                </div>
                                <div class="pm-toolbar-card-body">
                                    <div class="pm-filters">
                                        <label class="filter-label">
                                            Project
                                            <select id="project-filter" class="filter-select">
                                                <option value="all">All</option>
                                            </select>
                                        </label>

                                        <label class="filter-label">
                                            Owner
                                            <select id="owner-filter" class="filter-select">
                                                <option value="all">All</option>
                                            </select>
                                        </label>

                                        <label class="filter-label">
                                            Priority
                                            <select id="priority-filter" class="filter-select">
                                                <option value="all">All</option>
                                            </select>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 2: layout + manage mode -->
                            <div class="pm-toolbar-card pm-toolbar-card--layout">
                                <div class="pm-toolbar-card-header">
                                    <span class="section-title">Layout</span>
                                </div>
                                <div class="pm-toolbar-card-body pm-toolbar-layout-body">
                                    <button id="manage-mode-btn" type="button" class="btn-ghost btn-small btn-manage-tasks">
                                        Manage tasks
                                    </button>

                                    <div class="pm-width-control">
                                        <span class="pm-width-control-label">Panel width</span>
                                        <input
                                            id="pm-width-slider"
                                            class="pm-width-slider"
                                            type="range"
                                            min="70"
                                            max="100"
                                            step="1"
                                            value="92"
                                        />
                                        <span id="pm-width-value" class="pm-width-control-value">92%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Wrapper de grupos de pipeline -->
                        <div id="pm-groups-wrapper" class="pm-groups-wrapper">
                            <!-- Groups se renderizan por JS -->
                        </div>
                    </section>
                </section>
            </main>
        </div>
    </div>

    <script>
        // ================================
        // Sidebar: mÃ³dulos segÃºn accesos
        // ================================
        const sidebarNav = document.getElementById("sidebar-nav");

        const AVAILABLE_MODULES = {
            dashboard: { key: "dashboard", label: "Dashboard", href: "dashboard.html", icon: "ðŸ " },
            projects:  { key: "projects",  label: "Projects",  href: "projects.html",  icon: "ðŸ“" },
            pipeline:  { key: "pipeline",  label: "Pipeline",  href: "pipeline.html",  icon: "ðŸ“Š" },
            estimator: { key: "estimator", label: "Estimator", href: "#",              icon: "ðŸ“" },
            expenses:  { key: "expenses",  label: "Expenses",  href: "#",              icon: "ðŸ’¸" },
            settings:  { key: "settings",  label: "Settings",  href: "#",              icon: "âš™ï¸" },
        };

        // TODO: en producciÃ³n esto vendrÃ¡ del backend segÃºn el rol del usuario
        const USER_MODULES = ["dashboard", "projects", "pipeline", "estimator", "expenses"];

        function renderSidebarModules(modulesKeys) {
            if (!sidebarNav) return;
            sidebarNav.innerHTML = "";

            modulesKeys.forEach(key => {
                const mod = AVAILABLE_MODULES[key];
                if (!mod) return;

                const a = document.createElement("a");
                a.href = mod.href;
                a.className = "nav-item" + (key === "pipeline" ? " nav-item-active" : "");

                const iconSpan = document.createElement("span");
                iconSpan.className = "nav-icon";
                iconSpan.textContent = mod.icon;

                const labelSpan = document.createElement("span");
                labelSpan.className = "nav-label";
                labelSpan.textContent = mod.label;

                a.appendChild(iconSpan);
                a.appendChild(labelSpan);
                sidebarNav.appendChild(a);
            });
        }

        // ================================
        // Pipeline: datos y lÃ³gica de UI
        // ================================

        // ðŸ”§ MODO LOCAL
        const API_BASE = "http://127.0.0.1:8000";

        const groupsWrapper = document.getElementById("pm-groups-wrapper");
        const projectFilter = document.getElementById("project-filter");
        const ownerFilter = document.getElementById("owner-filter");
        const priorityFilter = document.getElementById("priority-filter");
        const manageBtn = document.getElementById("manage-mode-btn");
        const widthSlider = document.getElementById("pm-width-slider");
        const widthValue = document.getElementById("pm-width-value");
        const searchInput = document.getElementById("pipeline-search-input");

        let rawGroups = [];
        let searchQuery = "";
        let manageMode = false;

        async function fetchPipeline() {
            try {
                const res = await fetch(`${API_BASE}/pipeline/grouped`);
                if (!res.ok) throw new Error("Error loading pipeline");
                const data = await res.json();

                console.log("[PIPELINE] raw response:", data);

                rawGroups = Array.isArray(data) ? data : (data.groups || []);
                console.log("[PIPELINE] parsed groups:", rawGroups);

                populateFilters(rawGroups);
                renderGroups();
            } catch (err) {
                console.error("[PIPELINE] fetch error:", err);
                if (groupsWrapper) {
                    groupsWrapper.innerHTML = "<p class='panel-text'>Error loading pipeline data.</p>";
                }
            }
        }

        function populateFilters(groups) {
            const projects = new Set();
            const owners = new Set();
            const priorities = new Set();

            groups.forEach(group => {
                const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                tasks.forEach(t => {
                    // Proyecto: intenta varios campos comunes
                    const projectValue =
                        t.project_name ||
                        t.project ||
                        t.project_title ||
                        t.project_id ||
                        "";

                    if (projectValue) {
                        projects.add(projectValue);
                    }

                    // Owner: intenta varios formatos
                    const ownerValue =
                        (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                        t.owner_name ||
                        t.assigned_to ||
                        "";

                    if (ownerValue) {
                        owners.add(ownerValue);
                    }

                    // Priority: varios nombres posibles
                    const priorityValue =
                        (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                        t.priority_name ||
                        t.priority ||
                        "";

                    if (priorityValue) {
                        priorities.add(priorityValue);
                    }
                });
            });

            function fillSelect(select, values) {
                if (!select) return;
                const current = select.value;
                select.innerHTML = "<option value='all'>All</option>";
                Array.from(values).sort().forEach(v => {
                    const opt = document.createElement("option");
                    opt.value = v.toString();
                    opt.textContent = v.toString();
                    select.appendChild(opt);
                });
                if (Array.from(values).includes(current)) {
                    select.value = current;
                }
            }

            fillSelect(projectFilter, projects);
            fillSelect(ownerFilter, owners);

            const mappedPriorities = new Map();
            Array.from(priorities).forEach(p => {
                mappedPriorities.set(p.toString().toLowerCase(), p);
            });
            const normalized = Array.from(mappedPriorities.entries())
                .sort((a, b) => a[1].toString().localeCompare(b[1].toString()));

            if (priorityFilter) {
                priorityFilter.innerHTML = "<option value='all'>All</option>";
                normalized.forEach(([key, label]) => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = label.toString();
                    priorityFilter.appendChild(opt);
                });
            }
        }

        function applyFilters(groups) {
            const selectedProject = projectFilter ? projectFilter.value : "all";
            const selectedOwner = ownerFilter ? ownerFilter.value : "all";
            const selectedPriority = priorityFilter ? priorityFilter.value : "all";

            return groups.map(group => {
                const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                const filteredTasks = tasks.filter(t => {
                    // Proyecto
                    const pid =
                        t.project_name ||
                        t.project ||
                        t.project_title ||
                        t.project_id ||
                        "";
                    const projectPass =
                        selectedProject === "all" || pid === selectedProject;

                    // Owner
                    const ownerName =
                        (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                        t.owner_name ||
                        t.assigned_to ||
                        "";
                    const ownerPass =
                        selectedOwner === "all" || ownerName === selectedOwner;

                    // Priority
                    const priorityLabel =
                        (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                        t.priority_name ||
                        t.priority ||
                        "";
                    const pKey = priorityLabel.toString().toLowerCase();
                    const priorityPass =
                        selectedPriority === "all" || pKey === selectedPriority;

                    // Search
                    const q = (searchQuery || "").trim().toLowerCase();
                    let searchPass = true;
                    if (q) {
                        const haystack = [
                            t.task_description,
                            t.task_notes,
                            pid,
                            ownerName,
                            priorityLabel,
                        ]
                            .filter(Boolean)
                            .join(" ")
                            .toLowerCase();

                        searchPass = haystack.includes(q);
                    }

                    return projectPass && ownerPass && priorityPass && searchPass;
                });

                return {
                    ...group,
                    tasks: filteredTasks,
                };
            });
        }

        function renderGroups() {
            if (!groupsWrapper) return;

            const groups = applyFilters(rawGroups);
            console.log("[PIPELINE] rendering groups:", groups);

            groupsWrapper.innerHTML = "";

            if (!groups.length) {
                groupsWrapper.innerHTML = "<p class='panel-text'>No pipeline groups to display.</p>";
                return;
            }

            // ðŸŽ¨ Mapa de colores por status / nombre de grupo
            const STATUS_ACCENTS = {
                "not started": "#facc15",
                "working on it": "#3b82f6",
                "awaiting approval": "#fb923c",
                "done": "#22c55e",
                "on hold": "#a855f7",
                "cancelled": "#ef4444",
            };

            groups.forEach(group => {
                // Nunca filtramos el grupo aunque no tenga tasks
                const tasks =
                    Array.isArray(group.tasks) ? group.tasks :
                    Array.isArray(group.items) ? group.items :
                    Array.isArray(group.tasks_list) ? group.tasks_list :
                    [];

                const groupName =
                    group.status_name ||
                    group.group_name ||
                    group.name ||
                    "Group";

                const groupElem = document.createElement("div");
                groupElem.className = "pm-group";

                // ðŸŽ¨ Color del grupo (glow + tÃ­tulo)
                const key = groupName.trim().toLowerCase();
                const accentColor = STATUS_ACCENTS[key] || "#3e4042";
                groupElem.style.setProperty("--pm-group-accent", accentColor);

                // Header (click para expandir/contraer)
                const header = document.createElement("div");
                header.className = "pm-group-header";
                header.innerHTML = `
                    <h3 class="section-title" style="color:${accentColor};">
                        ${groupName}
                    </h3>
                    <span class="meta-pill">${tasks.length} tasks</span>
                `;

                const body = document.createElement("div");
                body.className = "pm-group-body";

                // ðŸ”½ estado inicial: expandido
                let isCollapsed = false;
                header.addEventListener("click", () => {
                    isCollapsed = !isCollapsed;
                    body.style.display = isCollapsed ? "none" : "";
                    header.classList.toggle("pm-group-header--collapsed", isCollapsed);
                });

                // ============= TABLA (SIEMPRE) =============
                const table = document.createElement("table");
                table.className = "table";

                const thead = document.createElement("thead");
                thead.innerHTML = `
                    <tr>
                        <th>Task</th>
                        <th>Project</th>
                        <th>Owner</th>
                        <th>Collaborator</th>
                        <th>Manager</th>
                        <th>Company</th>
                        <th>Start</th>
                        <th>Est (h)</th>
                        <th>Priority</th>
                        <th>Finished</th>
                        <th>Due</th>
                        <th>Links</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement("tbody");

                if (!tasks.length) {
                    // Grupo SIN tareas â†’ tabla con fila placeholder
                    const emptyRow = document.createElement("tr");
                    emptyRow.className = "pm-empty-row";
                    emptyRow.innerHTML = `
                        <td colspan="12" class="pm-empty-cell">
                            <div>No tasks in this group for the current filters.</div>
                        </td>
                    `;
                    tbody.appendChild(emptyRow);
                } else {
                    // Grupo CON tareas â†’ filas normales
                    tasks.forEach(t => {
                        const tr = document.createElement("tr");
                        tr.className = "pm-row";
                        if (manageMode) {
                            tr.classList.add("pm-row-manage");
                        }

                        // ======================
                        // CAMPOS PARA MOSTRAR EN TABLA
                        // ======================
                        const desc =
                            t.task_description || t.title || "(No description)";

                        const proj =
                            t.project_name ||
                            t.project ||
                            t.project_title ||
                            t.project_id ||
                            "-";

                        const owner =
                            (t.owner && (t.owner.name || t.owner.username || t.owner.email)) ||
                            t.owner_name ||
                            t.assigned_to ||
                            "-";

                        const collaborator =
                            (Array.isArray(t.collaborators) &&
                            t.collaborators.length > 0 &&
                            (t.collaborators[0].name || t.collaborators[0].id)) ||
                            "-";

                        const manager =
                            (t.manager_obj && (t.manager_obj.name || t.manager_obj.id)) ||
                            "-";

                        const company =
                            t.company_name || "-";

                        const startDate = t.start_date || null;
                        const startDisplay = startDate || "-";

                        const estimatedHours = (typeof t.estimated_hours === "number")
                            ? t.estimated_hours
                            : (t.estimated_hours ?? null);
                        const estDisplay = (estimatedHours != null) ? estimatedHours : "-";

                        const pri =
                            (t.priority && (t.priority.priority_name || t.priority.priority_id)) ||
                            t.priority_name ||
                            t.priority ||
                            "-";

                        const finished =
                            (t.finished_status &&
                                (t.finished_status.completed_status_name ||
                                t.finished_status.completed_status_id)) ||
                            "-";

                        const due = t.due_date || t.due || t.deadline || "-";

                        const docsLink = t.docs_link || null;
                        const resultLink = t.result_link || null;

                        let linksHtml = "-";
                        if (docsLink || resultLink) {
                            const parts = [];
                            if (docsLink) {
                                parts.push(`<a href="${docsLink}" target="_blank" rel="noopener noreferrer">Docs</a>`);
                            }
                            if (resultLink) {
                                parts.push(`<a href="${resultLink}" target="_blank" rel="noopener noreferrer">Result</a>`);
                            }
                            linksHtml = parts.join(" Â· ");
                        }

                        // ======================
                        // IDS Y EXTRA PARA MODALES / LÃ“GICA FUTURA
                        // ======================
                        const taskId = t.task_id || null;
                        const taskNotes = t.task_notes || null;
                        const companyManagement = t.company_management || null;

                        const priorityId =
                            (t.priority && t.priority.priority_id) ||
                            t.task_priority ||
                            null;

                        const finishedStatusId =
                            (t.finished_status && t.finished_status.completed_status_id) ||
                            t.task_finished_status ||
                            null;

                        // ======================
                        // PINTAR CELDAS VISIBLES
                        // ======================
                        tr.innerHTML = `
                            <td class="pm-row"><div>${desc}</div></td>
                            <td class="pm-row"><div>${proj}</div></td>
                            <td class="pm-row"><div>${owner}</div></td>
                            <td class="pm-row"><div>${collaborator}</div></td>
                            <td class="pm-row"><div>${manager}</div></td>
                            <td class="pm-row"><div>${company}</div></td>
                            <td class="pm-row"><div>${startDisplay}</div></td>
                            <td class="pm-row"><div>${estDisplay}</div></td>
                            <td class="pm-row"><div>${pri}</div></td>
                            <td class="pm-row"><div>${finished}</div></td>
                            <td class="pm-row"><div>${due}</div></td>
                            <td class="pm-row"><div>${linksHtml}</div></td>
                        `;

                        // ======================
                        // GUARDAR DATA EXTRA EN EL <tr> PARA MODAL / TOGGLE DE COLUMNAS
                        // ======================
                        if (taskId) tr.dataset.taskId = String(taskId);
                        if (startDate) tr.dataset.startDate = String(startDate);
                        if (estimatedHours != null) tr.dataset.estimatedHours = String(estimatedHours);
                        if (taskNotes) tr.dataset.taskNotes = String(taskNotes);
                        if (docsLink) tr.dataset.docsLink = String(docsLink);
                        if (resultLink) tr.dataset.resultLink = String(resultLink);
                        if (companyManagement) tr.dataset.companyManagement = String(companyManagement);
                        if (priorityId) tr.dataset.priorityId = String(priorityId);
                        if (finishedStatusId) tr.dataset.finishedStatusId = String(finishedStatusId);

                        tbody.appendChild(tr);
                    });
                }

                table.appendChild(tbody);
                body.appendChild(table);

                groupElem.appendChild(header);
                groupElem.appendChild(body);
                groupsWrapper.appendChild(groupElem);
            });
        }


        // ================================
        // Eventos de UI
        // ================================
        if (projectFilter) projectFilter.addEventListener("change", renderGroups);
        if (ownerFilter) ownerFilter.addEventListener("change", renderGroups);
        if (priorityFilter) priorityFilter.addEventListener("change", renderGroups);

        if (manageBtn) {
            manageBtn.addEventListener("click", () => {
                manageMode = !manageMode;
                manageBtn.classList.toggle("is-active", manageMode);
                manageBtn.textContent = manageMode ? "Done managing" : "Manage tasks";
                renderGroups();
            });
        }

        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderGroups();
            });
        }

        if (widthSlider && widthValue) {
            const applyWidth = () => {
                const value = widthSlider.value;
                widthValue.textContent = value + "%";
                document.documentElement.style.setProperty("--pm-panel-width", value + "%");
                console.log("[PIPELINE] panel width ->", value + "%");
            };
            widthSlider.addEventListener("input", applyWidth);
            applyWidth();
        }

        // Init
        document.addEventListener("DOMContentLoaded", () => {
            renderSidebarModules(USER_MODULES);
            fetchPipeline();
        });
    </script>
</body>
</html>
